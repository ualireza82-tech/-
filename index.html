<!DOCTYPE html>
<html lang="fa" dir="rtl" class="dark">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
<meta name="theme-color" content="#000000">
<title>AJ Sports 2026 - Ultimate Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons@6.6.6/css/flag-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
<script src="https://unpkg.com/pulltorefreshjs@0.1.22/dist/index.umd.js"></script>
<script src="https://unpkg.com/i18next/dist/umd/i18next.min.js"></script>
<script src="https://unpkg.com/i18next-browser-languagedetector/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
<script src="https://unpkg.com/i18next-http-backend/dist/umd/i18nextHttpBackend.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;300;400;500;700;900&display=swap');

* { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color: transparent; }
body, html { height:100%; width:100%; direction:rtl; background:#000000; color:#fff; overflow-x:hidden; position: fixed; }
body[lang="fa"] { font-family: 'Vazirmatn', system-ui, -apple-system, sans-serif; }
body[lang="en"] { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }

/* Auth Flow */
.auth-flow-container { height: 100%; width: 100%; position: relative; background: #121212; overflow-y: auto; }
.app-flow-container { display: none; width: 100%; height: 100%; background: #000; overflow-y: auto; }
.page { display:none; height:100%; width:100%; justify-content:center; align-items:center; flex-direction:column; text-align:center; position: absolute; inset: 0; }
.page.active { display:flex; animation: fadeIn 0.3s ease-in-out; }
@keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

/* Welcome Page */
.welcome-container { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; background:#121212; position:relative; z-index: 10; }
.logo-ball { width:150px; height:150px; border-radius:50%; display:flex; justify-content:center; align-items:center; position:relative; overflow:hidden; box-shadow:0 10px 30px rgba(211,47,47,0.25); animation:slow-rotate 8s linear infinite; z-index: 20; }
.logo-ball .logo-img { width:86%; height:86%; object-fit:contain; border-radius:50%; filter: drop-shadow(0 6px 16px rgba(211,47,47,0.15)); }
@keyframes slow-rotate { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }
.welcome-container h1 { margin-top:34px; font-size:26px; font-weight:700; color:#d32f2f; line-height:1.1; z-index: 20; }
.welcome-container p { color:rgba(255,255,255,0.92); font-size:14.5px; margin-top:10px; max-width:320px; text-align:center; line-height:1.6; opacity:0.95; padding:0 6px; z-index: 20; }
.start-btn { position:relative; background:#d32f2f; color:#fff; border:none; border-radius:12px; font-size:17px; padding:14px 0; width:80%; max-width:320px; margin-top:36px; cursor:pointer; overflow:hidden; z-index: 100 !important; box-shadow: 0 4px 15px rgba(211,47,47,0.4); transition: transform 0.1s; }
.start-btn:active { transform: scale(0.95); }

/* Login Inputs */
.input-group { position: relative; width:100%; margin-bottom:20px; text-align:left; direction:ltr; z-index: 20; }
.input-group i { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-size: 18px; color: #666; }
.input-group input { width: 100%; padding: 16px 14px 16px 45px; border: none; border-radius: 12px; background: #2a2a2a; color: #fff; font-size: 16px; direction:ltr; outline:none; transition: 0.3s; }
.input-group input:focus { outline: 2px solid #d32f2f; background: #333; }
.continue-fab-login { position:absolute; bottom:110px; right:30px; width:60px; height:60px; border-radius:50%; display:flex; align-items:center; justify-content:center; background: #333; color:#777; border:none; cursor:not-allowed; box-shadow:0 6px 18px rgba(0,0,0,0.6); transition:0.3s; z-index:2000; }
.continue-fab-login.enabled { background: #d32f2f; color: #fff; cursor:pointer; box-shadow: 0 10px 30px rgba(211,47,47,0.4); }
.continue-fab-login svg { width:24px; height:24px; fill:currentColor; transform:rotate(180deg); } 
.login-container, .otp-container, .profile-container { display:flex; flex-direction:column; align-items:center; background:#121212; padding:30px; width:100%; height:100%; }
.otp-container { justify-content:center; }
.otp-boxes { display:flex; justify-content:center; gap:8px; margin-bottom:24px; direction:ltr; flex-wrap: wrap; }
.otp-box { width:45px; height:52px; text-align:center; font-size:22px; font-weight:bold; border:2px solid #333; border-radius:12px; background:#1e1e1e; color:#fff; outline:none; transition: 0.2s; }
.otp-box:focus { border-color:#d32f2f; background:#252525; transform: translateY(-2px); }
.otp-box.filled { border-color: #555; background: #2a2a2a; }
button.red { width: 100%; padding: 15px; font-size: 16px; border: none; border-radius: 12px; cursor: pointer; background-color:#d32f2f; color:#fff; font-weight: 700; box-shadow: 0 4px 15px rgba(211,47,47,0.3); transition: transform 0.1s; }
button.red:active { transform: scale(0.98); }

/* Profile */
.profile-card { width:100%; max-width:420px; display:flex; flex-direction:column; align-items:center; gap:12px; padding-top:8px; }
.avatar-wrapper { margin-top:10px; width:120px; height:120px; border-radius:50%; display:flex; align-items:center; justify-content:center; background: #1e1e1e; border: 2px dashed #444; position:relative; overflow:hidden; }
.avatar-btn { width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:transparent; border:none; cursor:pointer; }
.avatar-preview { width:100%; height:100%; object-fit:cover; display:none; border-radius:50%; }
.continue-fab { position:fixed; bottom:26px; right:26px; width:64px; height:64px; border-radius:50%; display:flex; align-items:center; justify-content:center; background: #333; color:#555; cursor:not-allowed; box-shadow:0 6px 18px rgba(0,0,0,0.6); transition:0.3s; z-index:2000; }
.continue-fab.enabled { background: #d32f2f; color:#fff; cursor:pointer; }
.continue-fab svg { width:24px; height:24px; fill:currentColor; transform:rotate(180deg); }

/* Modals */
.modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:none; align-items:center; justify-content:center; z-index:3000; backdrop-filter: blur(8px); }
.modal { width:90%; max-width:340px; background:#181818; border-radius:20px; padding:24px; color:#fff; display:flex; flex-direction:column; gap:14px; border: 1px solid #333; }
.modal button { padding:14px; border-radius:12px; border:none; background:#2a2a2a; color:#fff; cursor:pointer; font-weight: 500; display:flex; align-items:center; justify-content:center; gap:10px; font-size:15px; }
.camera-view { display:none; position:fixed; inset:0; z-index:3100; background:#000; align-items:center; justify-content:center; flex-direction:column; }
.camera-view video { width:100%; height:100%; object-fit:cover; transform:scaleX(-1); }

/* Toast Notifications */
.notification-toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #1e1e1e;
    color: white;
    padding: 12px 24px;
    border-radius: 9999px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.08);
    z-index: 10000;
    animation: toast-appear 0.3s cubic-bezier(0.4,0,0.2,1);
    font-size: 14px;
    font-weight: 500;
    backdrop-filter: blur(20px);
    max-width: 90vw;
    display: flex;
    align-items: center;
    gap: 10px;
    white-space: nowrap;
}

.notification-toast i {
    font-size: 16px;
}

.notification-toast.success {
    background: rgba(0,186,124,0.2);
    border-color: rgba(0,186,124,0.4);
    color: #00ba7c;
}

.notification-toast.error {
    background: rgba(244,33,46,0.2);
    border-color: rgba(244,33,46,0.3);
    color: #f4212e;
}

@keyframes toast-appear {
    from { top: -50px; opacity: 0; transform: translateX(-50%) scale(0.9); }
    to { top: 20px; opacity: 1; transform: translateX(-50%) scale(1); }
}

/* Connection Status */
.connection-status {
    position: fixed;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(30,30,30,0.9);
    color: white;
    padding: 8px 18px;
    border-radius: 9999px;
    font-size: 12px;
    z-index: 1000;
    display: none;
    font-weight: 600;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    white-space: nowrap;
    align-items: center;
    gap: 8px;
}

.connection-status.connected {
    background: rgba(0,186,124,0.2);
    border-color: rgba(0,186,124,0.4);
    color: #00ba7c;
}

.connection-status.disconnected {
    background: rgba(244,33,46,0.2);
    border-color: rgba(244,33,46,0.3);
    color: #f4212e;
}

.connection-status i {
    font-size: 14px;
}

.connection-status span {
    line-height: 1;
}

@keyframes pulse-dot {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(0.9); }
}

.connection-status .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    animation: pulse-dot 1.5s ease-in-out infinite;
}

/* Story Styles */
.stories-container {
    display: flex;
    overflow-x: auto;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid #2f3336;
    background: #000;
    scrollbar-width: none;
}
.stories-container::-webkit-scrollbar { display: none; }
.story-item { display: flex; flex-direction: column; align-items: center; min-width: 64px; cursor: pointer; position: relative; }
.story-avatar { width: 64px; height: 64px; border-radius: 50%; padding: 2px; position: relative; background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); display: flex; align-items: center; justify-content: center; }
.story-avatar.no-story { background: #555; }
.story-avatar img { width: 56px; height: 56px; border-radius: 50%; border: 2px solid #000; object-fit: cover; }
.story-add-btn { position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; background: #1d9bf0; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; border: 2px solid #000; }
.story-username { font-size: 12px; color: #fff; margin-top: 4px; text-align: center; max-width: 64px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* Story Ring States */
.story-ring-compressing {
    background: conic-gradient(
        #f09433 0deg 90deg,
        transparent 90deg 180deg,
        #e6683c 180deg 270deg,
        transparent 270deg 360deg
    );
    animation: story-ring-rotate 1s linear infinite;
    padding: 2px !important;
    border-radius: 50% !important;
}

.story-ring-uploading {
    background: conic-gradient(
        #dc2743 0deg 120deg,
        transparent 120deg 240deg,
        #cc2366 240deg 360deg
    );
    animation: story-ring-rotate 0.8s linear infinite;
    padding: 2px !important;
    border-radius: 50% !important;
}

.story-ring-ready {
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%) !important;
    padding: 2px !important;
    border-radius: 50% !important;
    animation: none !important;
}

.story-ring-error {
    background: linear-gradient(45deg, #ff4444 0%, #ff3333 50%, #cc0000 100%) !important;
    padding: 2px !important;
    border-radius: 50% !important;
    animation: pulse-error 1s infinite !important;
}

.story-ring-loading {
    background: conic-gradient(
        #1d9bf0 0deg 90deg,
        transparent 90deg 180deg,
        #0c7abf 180deg 270deg,
        transparent 270deg 360deg
    ) !important;
    animation: story-ring-rotate 1s linear infinite !important;
    padding: 2px !important;
    border-radius: 50% !important;
}

@keyframes pulse-error {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes story-ring-rotate {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Story Viewer Fixed */
#story-viewer {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 10000;
    display: none;
    flex-direction: column;
}

#story-viewer.active {
    display: flex;
}

.story-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: rgba(0, 0, 0, 0.5);
    position: relative;
    z-index: 2;
}

.story-progress-container {
    display: flex;
    gap: 4px;
    position: absolute;
    top: 8px;
    left: 16px;
    right: 16px;
    z-index: 3;
}

.story-progress-bar {
    flex: 1;
    height: 2px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 1px;
    overflow: hidden;
}

.story-progress-fill {
    height: 100%;
    background: #fff;
    width: 0%;
    transition: width 0.1s linear;
}

.story-user-info {
    display: flex;
    align-items: center;
    gap: 8px;
    color: white;
}

.story-user-info img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
}

.story-user-info span {
    font-weight: 600;
}

.story-time {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.7);
}

.story-content {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
}

.story-content img,
.story-content video {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

.story-text {
    position: absolute;
    color: white;
    font-size: 24px;
    text-align: center;
    padding: 20px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

.story-nav {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 50%;
    cursor: pointer;
    z-index: 5;
}

.story-nav.prev {
    left: 0;
}

.story-nav.next {
    right: 0;
}

/* Story Actions Container */
.story-actions-container {
    position: absolute !important;
    bottom: 20px !important;
    left: 20px !important;
    right: 20px !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    background: rgba(0, 0, 0, 0.7) !important;
    backdrop-filter: blur(10px) !important;
    border-radius: 20px !important;
    padding: 10px 15px !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    z-index: 10 !important;
}

.story-action-btn {
    background: none !important;
    border: none !important;
    color: white !important;
    font-size: 18px !important;
    cursor: pointer !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 5px !important;
    min-width: 40px !important;
    transition: transform 0.2s !important;
}

.story-action-btn:hover {
    transform: scale(1.1) !important;
}

.story-action-btn.reply-btn {
    background: rgba(255, 255, 255, 0.1) !important;
    border-radius: 15px !important;
    color: rgba(255, 255, 255, 0.7) !important;
    padding: 8px 15px !important;
    font-size: 14px !important;
    flex-grow: 1 !important;
    margin: 0 10px !important;
    text-align: right !important;
    justify-content: flex-start !important;
}

.story-action-btn.delete {
    color: #ff4444 !important;
}

/* Story Creator */
#story-creator {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 10001;
    display: none;
    flex-direction: column;
}

#story-creator.active {
    display: flex;
}

.story-creator-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #2f3336;
}

.story-creator-header h3 {
    color: white;
    font-size: 16px;
    font-weight: 600;
}

.story-creator-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    position: relative;
}

.story-preview {
    width: 100%;
    max-width: 300px;
    height: 500px;
    background: #1a1a1a;
    border-radius: 16px;
    overflow: hidden;
    position: relative;
    display: none;
}

.story-preview img,
.story-preview video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.story-preview-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 24px;
    text-align: center;
    padding: 20px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

.story-tools {
    display: flex;
    gap: 20px;
    margin-top: 30px;
}

.story-tool-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #1a1a1a;
    border: none;
    color: white;
    cursor: pointer;
    transition: transform 0.2s;
}

.story-tool-btn:active {
    transform: scale(0.95);
}

.story-tool-btn i {
    font-size: 24px;
    margin-bottom: 4px;
}

.story-tool-btn span {
    font-size: 10px;
}

/* Story Text Editor */
#story-text-editor {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 10002;
    display: none;
    flex-direction: column;
    padding: 20px;
}

#story-text-editor.active {
    display: flex;
}

.story-text-input-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}

#story-text-input {
    width: 100%;
    max-width: 400px;
    background: transparent;
    border: none;
    color: white;
    font-size: 32px;
    text-align: center;
    outline: none;
}

.color-picker {
    display: flex;
    gap: 10px;
    justify-content: center;
    padding: 20px;
    flex-wrap: wrap;
}

.color-option {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid transparent;
    transition: transform 0.2s;
}

.color-option.selected {
    border-color: white;
    transform: scale(1.1);
}

/* App UI */
.glass-header { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-bottom: 1px solid #2f3336; }
.glass-nav { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(15px); border-top: 1px solid #2f3336; }
.telegram-bg { background-color: #0f0f0f; background-image: radial-gradient(#222 15%, transparent 16%), radial-gradient(#222 15%, transparent 16%); background-size: 20px 20px; background-position: 0 0, 10px 10px; }
.hide-scrollbar::-webkit-scrollbar { display: none; }
.hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
.tab-content { transition: opacity 0.2s ease-in-out; }
.hidden-content { display: none !important; opacity: 0; }

/* Tweet & DM Styles */
.tweet-card { border-bottom: 1px solid #2f3336; padding: 12px 16px; display: flex; gap: 12px; transition: background 0.2s; position: relative; }
.tweet-card:active { background: rgba(255,255,255,0.03); }
.tweet-action { color: #71767b; display: flex; align-items: center; gap: 6px; font-size: 13px; transition: color 0.2s; cursor: pointer; }
.tweet-action.liked { color: #f91880; }
.tweet-action.bookmarked { color: #1d9bf0; }

/* Dropdown Menu */
.dropdown-menu {
    display: none !important;
    position: absolute;
    top: 35px;
    left: 16px;
    background: #000;
    border: 1px solid #2f3336;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(255,255,255,0.1);
    z-index: 1000;
    width: 160px;
    overflow: hidden;
}
.dropdown-menu.show {
    display: block !important;
    animation: fadeIn 0.1s ease;
}
.dropdown-item {
    padding: 12px 16px;
    font-size: 14px;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: 0.2s;
    width: 100%;
    background: #000;
}
.dropdown-item:hover { background: #16181c; }
.dropdown-item.delete,
.dropdown-item.report,
.dropdown-item.block { color: #f4212e; }

/* Profile Dropdown Menu */
.profile-dropdown-menu {
    display: none !important;
    position: absolute;
    top: 50px;
    right: 15px;
    background: #000;
    border: 1px solid #2f3336;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(255,255,255,0.1);
    z-index: 1000;
    width: 180px;
    overflow: hidden;
}
.profile-dropdown-menu.show {
    display: block !important;
    animation: fadeIn 0.1s ease;
}
.profile-dropdown-item {
    padding: 12px 16px;
    font-size: 14px;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: 0.2s;
}
.profile-dropdown-item:hover { background: #16181c; }
.profile-dropdown-item.report,
.profile-dropdown-item.block { color: #f4212e; }

/* DM Specific */
.dm-item { display: flex; align-items: center; padding: 14px; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); transition: background 0.2s; cursor: pointer; position: relative; }
.dm-item:active { background: rgba(255,255,255,0.08); }
.dm-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
.dm-content { flex: 1; min-width: 0; }
.dm-time { font-size: 11px; color: #71767b; margin-right: auto; }
.msg-badge { width: 18px; height: 18px; background: #1d9bf0; border-radius: 50%; position: absolute; top: 50%; transform: translateY(-50%); left: 14px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; box-shadow: 0 0 0 2px #000; display: none; }
.msg-badge.active { display: flex; }

/* Unread Badge */
.unread-badge { 
    position: absolute; 
    left: 12px; 
    top: 50%; 
    transform: translateY(-50%); 
    min-width: 20px;
    height: 20px;
    background: #1d9bf0; 
    color: white; 
    border-radius: 10px; 
    font-size: 11px; 
    font-weight: bold; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    padding: 0 4px;
    box-shadow: 0 0 0 2px #000; 
    z-index: 2;
    transition: all 0.2s ease;
}

/* Room Item */
.room-item { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); border-radius: 12px; margin: 12px; padding: 16px; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 15px; transition: all 0.3s ease; cursor: pointer; }
.room-item:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
.room-avatar { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
.room-content { flex: 1; }
.room-content .room-title { font-weight: bold; color: white; font-size: 17px; margin-bottom: 4px; }
.room-content .room-desc { color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 8px; }
.room-meta { display: flex; align-items: center; gap: 6px; }
.online-dot { width: 8px; height: 8px; background: #4CAF50; border-radius: 50%; }
.live-badge { background: #FF5722; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }

/* Reply UI */
.reply-context-bar { color: #71767b; font-size: 13px; margin-bottom: 8px; display: none; }
.reply-context-bar span { color: #1d9bf0; }
.reply-context-bar.show { display: block; }

/* Composer */
#composer-modal { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
#composer-modal.open { transform: translateY(0); }
#edit-profile-modal { transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
#edit-profile-modal.open { transform: translateY(0); }

/* Drawer Layout */
#drawer { display: flex; flex-direction: column; }
.drawer-content { flex: 1; overflow-y: auto; }
.drawer-footer { padding-top: 20px; margin-top: auto; border-top: 1px solid #2f3336; }

/* Premium Modal */
#premium-modal { display: none; position: fixed; inset: 0; z-index: 9999; background: #000; }
#premium-modal iframe { width: 100%; height: 100%; border: none; background: white; }

/* Verification Badge */
.verification-badge { width: 18px; height: 18px; display: inline-block; vertical-align: middle; margin-right: 4px; }
.verification-badge.gold { filter: brightness(0) saturate(100%) invert(73%) sepia(100%) saturate(500%) hue-rotate(3deg) brightness(105%) contrast(105%); }
.verification-badge.blue { filter: brightness(0) saturate(100%) invert(42%) sepia(93%) saturate(1352%) hue-rotate(176deg) brightness(101%) contrast(91%); }

/* Notification Badge */
.notification-badge { position: absolute; top: -3px; right: -3px; width: 6px; height: 6px; background: #ff4d4d; border-radius: 50%; display: none; }
.notification-badge.active { display: block; }

/* Admin Controls */
.admin-controls { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1); }
.admin-btn { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; border: none; }
.admin-btn.grant-blue { background: #1d9bf0; color: white; }
.admin-btn.grant-gold { background: #FFD700; color: black; }
.admin-btn.remove { background: #f4212e; color: white; }

/* Chat Message Options */
.message-options { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); display: none; }
.message-container:hover .message-options { display: block; }
.message-container { position: relative; }
.delete-msg-btn { width: 24px; height: 24px; border-radius: 50%; background: rgba(0,0,0,0.7); color: #ff4444; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; border: none; }
.delete-msg-btn:hover { background: rgba(255,68,68,0.2); }

/* Vibration */
@keyframes vibrate { 
    0% { transform: translateX(0); } 
    25% { transform: translateX(-2px); } 
    50% { transform: translateX(2px); } 
    75% { transform: translateX(-2px); } 
    100% { transform: translateX(0); } 
}
.vibrate { animation: vibrate 0.3s linear; }

/* Loading Animation */
.loading-spinner {
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top: 3px solid #1d9bf0;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* FAB Tweet */
#fab-tweet {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, #1d9bf0 0%, #0c7abf 100%);
    border-radius: 50%;
    box-shadow: 0 8px 32px rgba(29, 155, 240, 0.4);
    border: none;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    z-index: 1000;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    padding: 0;
}
#fab-tweet::before {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
    border-radius: 50%;
    opacity: 0;
    transition: opacity 0.3s;
}
#fab-tweet:hover {
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 12px 40px rgba(29, 155, 240, 0.6);
}
#fab-tweet:hover::before {
    opacity: 1;
}
#fab-tweet:active {
    transform: scale(0.95) rotate(90deg);
    box-shadow: 0 4px 20px rgba(29, 155, 240, 0.4);
}
#fab-tweet i {
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-weight: 900;
}
#fab-tweet:hover i {
    transform: scale(1.2);
}
@keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 0 0 rgba(29, 155, 240, 0.7); }
    50% { box-shadow: 0 0 0 10px rgba(29, 155, 240, 0); }
}
#fab-tweet.pulse { animation: pulse-glow 2s infinite; }
#fab-tweet.hidden { display: none !important; }

/* Story Avatar Indicators */
.tweet-avatar-with-story {
    position: relative;
    width: 40px;
    height: 40px;
    flex-shrink: 0;
}
.tweet-avatar-with-story .story-indicator {
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border-radius: 50%;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    padding: 2px;
    z-index: 1;
}
.tweet-avatar-with-story .story-indicator img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 2px solid #000;
    object-fit: cover;
    position: relative;
    z-index: 2;
}
.profile-avatar-with-story {
    position: relative;
    display: inline-block;
    width: 80px;
    height: 80px;
}
.profile-avatar-with-story .story-indicator {
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    border-radius: 50%;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    padding: 3px;
    z-index: 1;
    cursor: pointer;
}
.profile-avatar-with-story .story-indicator img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 3px solid #000;
    object-fit: cover;
    position: relative;
    z-index: 2;
}
.search-result-avatar-with-story {
    position: relative;
    width: 40px;
    height: 40px;
    flex-shrink: 0;
}
.search-result-avatar-with-story .story-indicator {
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border-radius: 50%;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    padding: 2px;
    z-index: 1;
}
.search-result-avatar-with-story .story-indicator img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 2px solid #000;
    object-fit: cover;
    position: relative;
    z-index: 2;
}
.header-avatar-container {
    position: relative;
    width: 32px;
    height: 32px;
    cursor: pointer;
}
.header-avatar-with-story .story-indicator {
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border-radius: 50%;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    padding: 2px;
    z-index: 1;
}
.header-avatar-with-story .story-indicator img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 2px solid #000;
    object-fit: cover;
    position: relative;
    z-index: 2;
}
.drawer-avatar-container {
    position: relative;
    width: 48px;
    height: 48px;
}
.drawer-avatar-with-story .story-indicator {
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border-radius: 50%;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    padding: 2px;
    z-index: 1;
}
.drawer-avatar-with-story .story-indicator img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 2px solid #000;
    object-fit: cover;
    position: relative;
    z-index: 2;
}
.story-content-inner {
    width: 100%;
    height: 100%;
    position: relative;
}

/* Story Options Modal */
.story-options-modal {
    position: fixed;
    inset: 0;
    z-index: 10000;
    display: flex;
    align-items: flex-end;
    justify-content: center;
}
.story-options-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(8px);
}
.story-options-content {
    position: relative;
    background: #000;
    width: 100%;
    max-width: 500px;
    border-radius: 20px 20px 0 0;
    padding: 20px;
    padding-bottom: calc(20px + env(safe-area-inset-bottom));
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 1;
    border-top: 1px solid #2f3336;
}
@keyframes slide-up {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}
.animate-slide-up { animation: slide-up 0.3s ease-out; }
.story-option-btn {
    background: #1a1a1a;
    border: none;
    border-radius: 12px;
    padding: 16px;
    color: white;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: background 0.2s;
    width: 100%;
    text-align: right;
}
.story-option-btn:hover { background: #222; }
.story-option-btn i { font-size: 20px; width: 24px; text-align: center; }
.story-option-btn.cancel {
    background: #f4212e;
    margin-top: 10px;
    justify-content: center;
}
.story-option-btn.cancel:hover { background: #e0202d; }

/* Profile Header */
.profile-header {
    position: sticky;
    top: 0;
    z-index: 40;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border-bottom: 1px solid #2f3336;
}

/* Pull-to-refresh */
.ptr--ptr {
    pointer-events: none;
    font-size: 0.85em;
    font-weight: bold;
    top: 0;
    height: 0;
    transition: height 0.3s, min-height 0.3s;
    text-align: center;
    width: 100%;
    overflow: hidden;
    display: flex;
    align-items: flex-end;
    justify-content: center;
}
.ptr--box {
    padding: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 0;
}
.ptr--pull {
    transition: none;
    position: absolute;
    bottom: 20px;
    left: 0;
    right: 0;
    text-align: center;
}

/* Infinite scroll */
.infinite-scroll-loader {
    text-align: center;
    padding: 20px;
    color: #666;
    font-size: 14px;
}

/* Service worker notification */
.sw-notification {
    position: fixed;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%);
    background: #1d9bf0;
    color: white;
    padding: 12px 20px;
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(29,155,240,0.3);
    z-index: 10000;
    display: none;
}

/* Optimistic UI */
.optimistic-transition { transition: all 0.3s ease; }

/* Lazy loading */
.lazy-image {
    opacity: 0;
    transition: opacity 0.3s ease;
}
.lazy-image.loaded { opacity: 1; }

/* RTL/LTR */
[dir="rtl"] .text-start { text-align: right; }
[dir="ltr"] .text-start { text-align: left; }
[dir="rtl"] .text-end { text-align: left; }
[dir="ltr"] .text-end { text-align: right; }

/* Date formatting */
.date-fa { font-family: 'Vazirmatn', sans-serif; }
.date-en { font-family: system-ui, sans-serif; }

/* Loading skeleton */
.skeleton {
    background: linear-gradient(90deg, #2a2a2a 25%, #333 50%, #2a2a2a 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}
@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}
.story-content-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
}
.story-progress-bar.paused .story-progress-fill { animation-play-state: paused; }

/* Drawer Link Fixed */
.drawer-link {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    text-decoration: none;
    color: white;
    font-weight: 600;
    border-radius: 8px;
    transition: background 0.2s;
    cursor: pointer;
}
.drawer-link:hover { background: rgba(255, 255, 255, 0.1); }
.drawer-link i { width: 24px; text-align: center; }

/* Safe area for newer iPhones */
.pb-safe { padding-bottom: env(safe-area-inset-bottom); }

/* Report System Styles */
.report-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
}
.report-modal {
    width: 90%;
    max-width: 500px;
    max-height: 85vh;
    background: #000;
    border-radius: 16px;
    border: 1px solid #2f3336;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
.report-header {
    padding: 20px;
    border-bottom: 1px solid #2f3336;
    position: sticky;
    top: 0;
    background: #000;
    z-index: 10;
}
.report-header h2 {
    color: white;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
}
.report-header p {
    color: #71767b;
    font-size: 14px;
    line-height: 1.4;
}
.report-content {
    flex: 1;
    overflow-y: auto;
    padding: 0 20px 20px;
}
.report-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin: 20px 0;
}
.report-option {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    border: 1px solid #2f3336;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    background: #000;
}
.report-option:hover { background: #16181c; }
.report-option.selected { border-color: #1d9bf0; background: rgba(29, 155, 240, 0.1); }
.radio-circle {
    width: 20px;
    height: 20px;
    border: 2px solid #71767b;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    margin-top: 2px;
    transition: all 0.2s;
}
.radio-circle.selected { border-color: #1d9bf0; }
.radio-circle.selected::after {
    content: '';
    width: 10px;
    height: 10px;
    background: #1d9bf0;
    border-radius: 50%;
}
.option-text {
    flex: 1;
    color: white;
    font-size: 15px;
    line-height: 1.4;
}
.option-description {
    color: #71767b;
    font-size: 13px;
    margin-top: 4px;
    line-height: 1.4;
}
.report-footer {
    padding: 20px;
    border-top: 1px solid #2f3336;
    display: flex;
    gap: 12px;
    position: sticky;
    bottom: 0;
    background: #000;
    z-index: 10;
}
.report-btn {
    flex: 1;
    padding: 14px;
    border-radius: 9999px;
    font-weight: 700;
    font-size: 15px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}
.report-btn.cancel {
    background: transparent;
    color: white;
    border: 1px solid #2f3336;
}
.report-btn.cancel:hover { background: #16181c; }
.report-btn.submit {
    background: white;
    color: black;
}
.report-btn.submit:hover:not(:disabled) { background: #e6e6e6; }
.report-btn.submit:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.success-modal {
    width: 90%;
    max-width: 400px;
    background: #000;
    border-radius: 16px;
    border: 1px solid #2f3336;
    padding: 30px;
    text-align: center;
}
.success-icon {
    width: 60px;
    height: 60px;
    background: #00ba7c;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    color: white;
    font-size: 28px;
}
.success-modal h3 {
    color: white;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 10px;
}
.success-modal p {
    color: #71767b;
    font-size: 15px;
    line-height: 1.5;
    margin-bottom: 20px;
}
.report-section {
    margin-top: 20px;
    text-align: right;
}
.report-section h4 {
    color: white;
    font-size: 16px;
    margin-bottom: 8px;
    font-weight: 600;
}
.report-section p {
    color: #71767b;
    font-size: 14px;
    line-height: 1.5;
}
.success-actions {
    display: flex;
    gap: 12px;
    margin-top: 15px;
}
.hide-tweet-btn {
    flex: 1;
    padding: 12px;
    border-radius: 9999px;
    background: #1d9bf0;
    color: white;
    border: none;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 14px;
}
.hide-tweet-btn:hover { background: #0c7abf; }
.block-user-btn {
    flex: 1;
    padding: 12px;
    border-radius: 9999px;
    background: transparent;
    color: #f4212e;
    border: 1px solid #2f3336;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.2s;
    font-size: 14px;
}
.block-user-btn:hover { background: rgba(244, 33, 46, 0.1); }
.done-btn {
    width: 100%;
    padding: 14px;
    border-radius: 9999px;
    background: white;
    color: black;
    border: none;
    font-weight: 700;
    cursor: pointer;
    margin-top: 20px;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}
.done-btn:hover { background: #e6e6e6; }
#report-form { display: none; }

/* Block Confirm Modal */
.block-confirm-modal {
    width: 90%;
    max-width: 400px;
    background: #000;
    border-radius: 16px;
    border: 1px solid #2f3336;
    padding: 24px;
    text-align: center;
}
.block-confirm-icon {
    width: 60px;
    height: 60px;
    background: rgba(244, 33, 46, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    color: #f4212e;
    font-size: 28px;
}
.block-confirm-text h3 {
    color: white;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
}
.block-confirm-text p {
    color: #71767b;
    font-size: 15px;
    line-height: 1.5;
    margin-bottom: 20px;
}
.block-confirm-actions {
    display: flex;
    gap: 12px;
}
.block-confirm-btn {
    flex: 1;
    padding: 14px;
    border-radius: 9999px;
    font-weight: 700;
    font-size: 15px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}
.block-confirm-btn.cancel {
    background: transparent;
    color: white;
    border: 1px solid #2f3336;
}
.block-confirm-btn.cancel:hover { background: #16181c; }
.block-confirm-btn.confirm {
    background: #f4212e;
    color: white;
}
.block-confirm-btn.confirm:hover { background: #e0202d; }
.blocked-user-notice {
    background: #000;
    border: 1px solid #2f3336;
    border-radius: 12px;
    padding: 16px;
    margin: 12px;
    text-align: center;
}
.blocked-notice-content {
    color: #71767b;
    font-size: 14px;
    line-height: 1.5;
}
.blocked-notice-content strong { color: white; }
.unblock-btn {
    background: transparent;
    border: 1px solid #2f3336;
    color: #1d9bf0;
    padding: 8px 16px;
    border-radius: 9999px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 12px;
    transition: all 0.2s;
}
.unblock-btn:hover { background: rgba(29, 155, 240, 0.1); }

/* Profile Options Menu */
.profile-options-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    transition: all 0.2s;
}
.profile-options-btn:hover {
    background: rgba(0, 0, 0, 0.8);
    transform: scale(1.1);
}

/* Auth Flow Premium Styles */
#auth-flow {
    position: relative;
    background: #030303;
}
#particle-canvas {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 1; pointer-events: none;
}
.ambient-glow {
    position: absolute; width: 70vw; height: 70vw;
    background: radial-gradient(circle, rgba(211, 47, 47, 0.12) 0%, transparent 70%);
    border-radius: 50%; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none; z-index: 0; filter: blur(80px);
}

.auth-flow-container > .page {
    position: relative;
    z-index: 10;
    background: transparent !important;
}

.logo-wrapper {
    position: relative; width: 154px; height: 154px;
    margin-bottom: 30px; border-radius: 50%;
    background: rgba(255, 255, 255, 0.03); padding: 5px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.05);
}
.logo-wrapper img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

.title-premium {
    font-size: 32px; font-weight: 900;
    background: linear-gradient(180deg, #ffffff 0%, #a0a0a0 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

.email-icon-wrapper {
    width: 76px; height: 76px;
    background: linear-gradient(135deg, rgba(211, 47, 47, 0.1) 0%, rgba(255, 255, 255, 0.02) 100%);
    border: 1px solid rgba(211, 47, 47, 0.3);
    border-radius: 22px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 15px 35px rgba(211, 47, 47, 0.2), inset 0 0 10px rgba(211, 47, 47, 0.1);
    backdrop-filter: blur(15px);
    transform-origin: center;
}

.input-premium {
    width: 100%; max-width: 320px;
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    backdrop-filter: blur(15px); border-radius: 16px;
    padding: 18px 20px; color: #fff; text-align: center;
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
}
.input-premium:focus {
    border-color: #d32f2f !important;
    box-shadow: 0 0 20px rgba(211, 47, 47, 0.15);
}

.btn-main {
    background: #d32f2f;
    color: #fff; padding: 16px 40px; border-radius: 100px;
    font-weight: 700; cursor: pointer; border: none;
    box-shadow: 0 10px 30px rgba(211, 47, 47, 0.3);
    transition: all 0.3s ease;
}
.btn-main:active { transform: scale(0.95); }

.otp-box {
    width: 45px; height: 55px; background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
    text-align: center; font-size: 22px; font-weight: 900; color: #fff;
    transition: all 0.3s;
}
.otp-box:focus {
    border-color: #d32f2f; background: rgba(211, 47, 47, 0.1);
    transform: translateY(-3px);
}

.profile-container { 
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    width: 100%; height: 100%; background: transparent;
    padding: 30px; position: relative; z-index: 20;
}

.avatar-premium-wrapper {
    position: relative;
    width: 140px;
    height: 140px;
    border-radius: 40px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.01) 100%);
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 20px 40px rgba(0,0,0,0.4), inset 0 0 20px rgba(211, 47, 47, 0.05);
    backdrop-filter: blur(20px);
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    margin: 0 auto 30px auto;
}

.avatar-premium-wrapper:hover {
    border-color: rgba(211, 47, 47, 0.5);
    box-shadow: 0 20px 40px rgba(211, 47, 47, 0.15), inset 0 0 20px rgba(211, 47, 47, 0.1);
    transform: translateY(-5px);
}

.avatar-btn-premium {
    width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
    background: transparent; border: none; cursor: pointer; border-radius: inherit; z-index: 10;
}

.camera-icon-glow {
    width: 54px; height: 54px; border-radius: 50%;
    background: rgba(211, 47, 47, 0.1); color: #d32f2f;
    font-size: 22px; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 0 15px rgba(211, 47, 47, 0.2);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.avatar-btn-premium:hover .camera-icon-glow {
    background: #d32f2f; color: #fff;
    box-shadow: 0 0 25px rgba(211, 47, 47, 0.5);
    transform: scale(1.1) rotate(5deg);
}

.avatar-preview-premium {
    position: absolute; inset: 0; width: 100%; height: 100%;
    object-fit: cover; border-radius: inherit; display: none; z-index: 5;
}

.input-premium-profile {
    width: 100%;
    background: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    backdrop-filter: blur(15px); 
    border-radius: 16px;
    padding: 16px 20px; 
    color: #fff;
    font-size: 15px;
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    outline: none;
}

.input-premium-profile:focus {
    border-color: #d32f2f !important;
    box-shadow: 0 0 20px rgba(211, 47, 47, 0.15);
    background: rgba(255, 255, 255, 0.08) !important;
}

.btn-main-profile {
    background: #d32f2f; color: #fff; 
    padding: 16px 0; width: 100%; max-width: 320px; 
    border-radius: 100px; font-weight: 700; font-size: 16px;
    cursor: pointer; border: none;
    box-shadow: 0 10px 30px rgba(211, 47, 47, 0.3);
    transition: all 0.3s ease;
    display: flex; align-items: center; justify-content: center; gap: 10px;
    margin-top: 10px;
}
.btn-main-profile:active { transform: scale(0.95); }

/* GIF Picker Styles */
#gif-picker-modal {
    position: fixed;
    inset: 0;
    z-index: 10005;
    background: #000;
    display: none;
    flex-direction: column;
    animation: slide-up-gif 0.3s ease-out;
}

#gif-picker-modal.active {
    display: flex;
}

@keyframes slide-up-gif {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}

.gif-chip {
    background: #1a1a1a;
    border: 1px solid #2f3336;
    color: white;
    padding: 8px 16px;
    border-radius: 9999px;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.2s ease;
    cursor: pointer;
    flex-shrink: 0;
}

.gif-chip.active {
    background: #1d9bf0;
    border-color: #1d9bf0;
    color: white;
}

.gif-chip:hover {
    background: #2f3336;
}

.gif-chip.active:hover {
    background: #1a8cd8;
}

.gif-grid-item {
    position: relative;
    aspect-ratio: 1/1;
    overflow: hidden;
    border-radius: 12px;
    cursor: pointer;
    transition: transform 0.2s ease;
    background: #1a1a1a;
}

.gif-grid-item:hover {
    transform: scale(1.02);
}

.gif-grid-item video,
.gif-grid-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.gif-grid-item .gif-badge {
    position: absolute;
    top: 8px;
    left: 8px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    backdrop-filter: blur(4px);
    z-index: 2;
}

.gif-grid-item .gif-overlay {
    position: absolute;
    bottom: 0;
    right: 0;
    left: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
    padding: 6px 8px;
    opacity: 0;
    transition: opacity 0.2s ease;
    z-index: 2;
}

.gif-grid-item:hover .gif-overlay {
    opacity: 1;
}

.gif-grid-item .gif-overlay span {
    color: white;
    font-size: 11px;
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#gif-chips-container {
    -ms-overflow-style: none;
    scrollbar-width: none;
}

#gif-chips-container::-webkit-scrollbar {
    display: none;
}

#composer-gif-preview {
    position: relative;
    margin-top: 12px;
    border-radius: 12px;
    overflow: hidden;
    background: #000;
    border: 1px solid #2f3336;
}

#composer-gif-preview video {
    width: 100%;
    max-height: 200px;
    object-fit: contain;
    background: #000;
}

#composer-gif-preview .gif-badge-preview {
    position: absolute;
    bottom: 8px;
    left: 8px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 9999px;
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    gap: 4px;
}

#composer-gif-icon {
    color: #1d9bf0 !important;
    transition: transform 0.2s ease;
}

#composer-gif-icon:hover {
    transform: scale(1.1);
}

#composer-gif-icon:active {
    transform: scale(0.95);
}
</style>
<script>
tailwind.config = {
    darkMode: 'class',
    theme: { extend: { colors: { x: { black: '#000000', dark: '#16181c', gray: '#71767b', line: '#2f3336', blue: '#1d9bf0', accent: '#eff3f4' } } }, fontFamily: { sans: ['Vazirmatn', 'ui-sans-serif', 'system-ui'] } }
}
</script>
</head>
<body>

<!-- Connection Status -->
<div id="connection-status" class="connection-status">
    <i class="fas fa-spinner fa-spin"></i> <span data-i18n="connecting">  ...</span>
</div>

<!-- Service Worker Notification -->
<div id="sw-notification" class="sw-notification">
    <span data-i18n="app_ready">    !</span>
    <button onclick="this.parentElement.style.display='none'" style="margin-right:10px; background:white; color:#1d9bf0; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">
        <span data-i18n="ok"></span>
    </button>
</div>

<!-- Audio Elements -->
<audio id="message-sound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" type="audio/mpeg">
</audio>
<audio id="dm-sound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" type="audio/mpeg">
</audio>

<!-- Auth Flow -->
<div id="auth-flow" class="auth-flow-container">
    <canvas id="particle-canvas"></canvas>
    <div class="ambient-glow" id="glow"></div>

    <!-- Welcome Page -->
    <div class="page active" id="welcomePage">
        <div class="welcome-container" style="background: transparent;">
            <div class="logo-wrapper" id="welcomeLogo">
                <img class="logo-img" src="https://i.postimg.cc/g04RCPnv/file-00000000475861fb83ecca74d2a5a38-1.png" alt="Logo" loading="lazy">
            </div>
            <h1 class="title-premium mb-4" data-i18n="welcome_title"> </h1>
            <p class="text-white/70 mb-10 leading-relaxed max-w-xs" data-i18n="welcome_description">
                 <strong>  </strong>  .<br>     .
            </p>
            <button class="btn-main" onclick="window.app.goToLogin()" data-i18n="start_messaging"> </button>
        </div>
    </div>

    <!-- Login Page -->
    <div class="page" id="loginPage">
        <div class="login-container" style="background: transparent; justify-content: center;">
            <div class="mb-8 flex flex-col items-center">
                <div class="w-12 h-1 bg-white/10 mx-auto mb-6 rounded-full"></div>
                
                <div class="email-icon-wrapper mx-auto mb-5" id="emailGraphic">
                    <i class="fas fa-envelope-open-text text-3xl" style="color: #d32f2f;"></i>
                </div>

                <h2 class="title-premium text-2xl mb-2" data-i18n="enter_email"> </h2>
                <p class="text-sm text-white/50" data-i18n="otp_will_sent">       </p>
            </div>

            <div class="input-group" style="margin-bottom: 30px; max-width: 320px;">
                <i class="far fa-envelope" style="left: 14px; color: #666;"></i>
                <input type="email" id="emailInput" class="input-premium !pl-12" placeholder="example@email.com" dir="ltr">
            </div>
            
            <button id="loginFab" class="btn-main w-64 flex items-center justify-center gap-2" onclick="window.app.sendOTP()" style="position: static; border-radius: 100px; width: 100%; max-width: 320px;">
                <span data-i18n="send_code">  </span>
                <i class="fas fa-arrow-left"></i>
            </button>
            <button class="mt-8 text-xs opacity-30" onclick="window.app.goToLogin(); document.getElementById('welcomePage').classList.add('active'); document.getElementById('loginPage').classList.remove('active');" data-i18n="back"></button>
        </div>
    </div>

    <!-- OTP Page -->
    <div class="page" id="otpPage">
        <div class="otp-container" style="background: transparent; justify-content: center;">
            <div class="mb-6">
                <i class="fas fa-shield-alt text-4xl mb-4" style="color: #d32f2f;"></i>
                <h2 class="text-xl font-bold" data-i18n="verification_code"> </h2>
                <p class="text-xs text-white/50 mt-2 leading-relaxed" id="otpText" data-i18n="code_sent_to_email">     .</p>
            </div>

            <div class="otp-boxes" style="gap: 8px; margin-bottom: 24px;">
                <input type="tel" maxlength="1" class="otp-box" id="otp1" data-next="otp2">
                <input type="tel" maxlength="1" class="otp-box" id="otp2" data-next="otp3" data-prev="otp1">
                <input type="tel" maxlength="1" class="otp-box" id="otp3" data-next="otp4" data-prev="otp2">
                <input type="tel" maxlength="1" class="otp-box" id="otp4" data-next="otp5" data-prev="otp3">
                <input type="tel" maxlength="1" class="otp-box" id="otp5" data-next="otp6" data-prev="otp4">
                <input type="tel" maxlength="1" class="otp-box" id="otp6" data-prev="otp5">
            </div>
            <div class="otp-error" id="otpError" style="color:#ff4d4d;font-size:13px;margin-bottom:20px;min-height:20px;"></div>
            
            <button class="btn-main w-64" id="verifyBtn" onclick="window.app.verifyOTP()" data-i18n="login_to_app">  </button>
            <button class="mt-6 text-xs text-white/30" onclick="document.getElementById('otpPage').classList.remove('active'); document.getElementById('loginPage').classList.add('active');" data-i18n="edit_email"> </button>
        </div>
    </div>

    <!-- Profile Page -->
    <div class="page" id="profilePage">
        <div class="profile-container">
            <div class="w-12 h-1 bg-white/10 mx-auto mb-6 rounded-full"></div>
            
            <h2 class="title-premium text-2xl mb-2" data-i18n="complete_profile"> </h2>
            <p class="text-sm text-white/50 mb-8" data-i18n="setup_avatar_username">      </p>

            <div class="w-full max-w-sm flex flex-col items-center relative">
                
                <div class="avatar-premium-wrapper" id="avatarWrapper">
                    <button class="avatar-btn-premium" id="avatarBtn" onclick="window.app.openImageChooser()">
                        <div class="camera-icon-glow">
                            <i class="fas fa-camera"></i>
                        </div>
                    </button>
                    <img id="avatarPreview" class="avatar-preview-premium">
                </div>

                <div class="w-full mb-5">
                    <div class="text-xs text-white/50 mb-2 mr-2 text-right" data-i18n="display_name_farsi">  ()</div>
                    <input id="displayName" class="input-premium-profile !text-right" placeholder=":  " type="text">
                </div>

                <div class="w-full mb-8">
                    <div class="text-xs text-white/50 mb-2 ml-2 text-left" data-i18n="username_english">  ()</div>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-white/30 text-lg font-bold">@</span>
                        <input id="usernameInput" class="input-premium-profile !text-left !pl-10" placeholder="username_id" type="text" dir="ltr">
                    </div>
                    <div id="usernameError" class="text-left text-[11px] text-[#ff4d4d] min-h-[15px] mt-2 ml-2 font-medium"></div>
                </div>

                <button id="continueFab" class="btn-main-profile" onclick="window.app.submitProfile()">
                    <span data-i18n="finish_and_enter">  </span>
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="chooserModal" class="modal-backdrop">
    <div class="modal">
        <div style="font-weight:600;font-size:16px;" data-i18n="choose_image"> </div>
        <button onclick="window.app.openFilePicker()"><i class="far fa-images"></i> <span data-i18n="choose_from_gallery">  </span></button>
        <button onclick="window.app.startCamera()"><i class="fas fa-camera"></i> <span data-i18n="open_camera">  </span></button>
        <button onclick="window.app.closeChooser()" style="background:transparent;border:1px solid #444;color:#aaa;" data-i18n="cancel"></button>
    </div>
</div>
<div id="cameraView" class="camera-view">
    <video id="cameraVideo" autoplay playsinline></video>
    <div style="display:flex;gap:20px;position:absolute;bottom:40px;z-index:3200;">
        <button onclick="window.app.stopCamera()" style="width:60px;height:60px;border-radius:50%;background:#333;color:#fff;border:none;"><i class="fas fa-times"></i></button>
        <button onclick="window.app.capturePhoto()" style="width:80px;height:80px;border-radius:50%;background:#d32f2f;border:4px solid #fff;color:#fff;"><i class="fas fa-camera"></i></button>
    </div>
</div>
<input type="file" id="fileInput" accept="image/*" style="display:none">

<!-- Story System -->
<div id="story-viewer" class="story-viewer">
    <div class="story-progress-container" id="story-progress-container"></div>
    <div class="story-header">
        <div class="story-user-info">
            <img id="current-story-avatar" src="" loading="lazy">
            <div>
                <span id="current-story-username"></span>
                <div id="current-story-time" class="story-time"></div>
            </div>
        </div>
        <button onclick="window.app.closeStoryViewer()" class="text-white">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div class="story-content" id="story-content"></div>
</div>

<div id="story-creator" class="story-creator">
    <div class="story-creator-header">
        <button onclick="window.app.closeStoryCreator()" class="text-white">
            <i class="fas fa-times"></i>
        </button>
        <h3 data-i18n="create_story"> </h3>
        <button onclick="window.app.postStory()" class="text-x-blue font-bold" data-i18n="send"></button>
    </div>
    <div class="story-creator-content">
        <div id="story-preview" class="story-preview">
            <div id="story-preview-text" class="story-preview-text"></div>
        </div>
        <div class="story-tools">
            <button class="story-tool-btn" onclick="window.app.openGalleryForStory()">
                <i class="fas fa-image"></i>
                <span data-i18n="photo"></span>
            </button>
            <button class="story-tool-btn" onclick="window.app.openCameraForStory()">
                <i class="fas fa-camera"></i>
                <span data-i18n="camera"></span>
            </button>
            <button class="story-tool-btn" onclick="window.app.openStoryTextEditor()">
                <i class="fas fa-font"></i>
                <span data-i18n="text"></span>
            </button>
        </div>
    </div>
</div>

<div id="story-text-editor" class="story-text-editor">
    <div class="story-creator-header">
        <button onclick="window.app.closeStoryTextEditor()" class="text-white">
            <i class="fas fa-arrow-right"></i>
        </button>
        <h3 data-i18n="add_text"> </h3>
        <button onclick="window.app.applyStoryText()" class="text-x-blue font-bold" data-i18n="confirm"></button>
    </div>
    <div class="story-text-input-container">
        <textarea id="story-text-input" placeholder="   ..." data-i18n="[placeholder]story_text_placeholder"></textarea>
    </div>
    <div class="color-picker" id="color-picker">
        <div class="color-option selected" style="background: #ffffff;" data-color="#ffffff"></div>
        <div class="color-option" style="background: #000000;" data-color="#000000"></div>
        <div class="color-option" style="background: #FF0000;" data-color="#FF0000"></div>
        <div class="color-option" style="background: #00FF00;" data-color="#00FF00"></div>
        <div class="color-option" style="background: #0000FF;" data-color="#0000FF"></div>
        <div class="color-option" style="background: #FFFF00;" data-color="#FFFF00"></div>
        <div class="color-option" style="background: #FF00FF;" data-color="#FF00FF"></div>
        <div class="color-option" style="background: #00FFFF;" data-color="#00FFFF"></div>
        <div class="color-option" style="background: #FF9900;" data-color="#FF9900"></div>
    </div>
</div>

<input type="file" id="story-media-input" accept="image/*,video/*" style="display: none">
<input type="file" id="story-gallery-input" accept="image/*,video/*" style="display: none">

<!-- Report System Modals -->
<div id="report-modal" class="report-modal-overlay">
    <div class="report-modal">
        <div class="report-header">
            <h2 data-i18n="report_title">    </h2>
            <p data-i18n="report_subtitle">          .</p>
        </div>
        <div class="report-content" id="report-options-container"></div>
        <div class="report-footer">
            <button class="report-btn cancel" onclick="window.app.closeReportModal()" data-i18n="cancel"></button>
            <button class="report-btn submit" id="submit-report-btn" onclick="window.app.submitReport()" disabled data-i18n="submit_report"> </button>
        </div>
    </div>
</div>

<div id="success-modal" class="report-modal-overlay" style="display: none;">
    <div class="success-modal">
        <div class="success-icon">
            <i class="fas fa-check"></i>
        </div>
        <h3 data-i18n="report_thanks">       .</h3>
        <p data-i18n="report_appreciate">              .</p>
        <div class="report-section">
            <h4 data-i18n="what_happens_now">  </h4>
            <p>
                <span data-i18n="report_received">    .            .</span>
            </p>
        </div>
        <div class="report-section">
            <h4 data-i18n="next_steps">  </h4>
            <p>
                <span data-i18n="review_time">           .                       .</span>
            </p>
        </div>
        <div class="report-section">
            <h4 data-i18n="additional_actions">        </h4>
            <div class="success-actions" id="success-actions-container"></div>
        </div>
        <button class="done-btn" onclick="window.app.closeSuccessModal()">
            <span data-i18n="done"> </span>
            <i class="fas fa-check"></i>
        </button>
    </div>
</div>

<form id="report-form" action="https://formspree.io/f/xdkwlpdd" method="POST">
    <input type="hidden" name="_subject" value="    - AJ Sports">
    <input type="hidden" name="tweet_id" id="report-tweet-id">
    <input type="hidden" name="tweet_content" id="report-tweet-content">
    <input type="hidden" name="tweet_user" id="report-tweet-user">
    <input type="hidden" name="reporter" id="report-reporter">
    <input type="hidden" name="reporter_email" id="report-reporter-email">
    <input type="hidden" name="category" id="report-category">
    <input type="hidden" name="category_description" id="report-category-desc">
    <input type="hidden" name="reported_at" id="report-reported-at">
    <input type="email" name="email" id="report-email" style="display: none;">
    <textarea name="message" id="report-message" style="display: none;"></textarea>
</form>

<!-- Block Confirmation Modal -->
<div id="block-confirm-modal" class="report-modal-overlay" style="display: none;">
    <div class="block-confirm-modal">
        <div class="block-confirm-icon">
            <i class="fas fa-ban"></i>
        </div>
        <div class="block-confirm-text">
            <h3 data-i18n="block_user_title">  </h3>
            <p id="block-confirm-message">
                     <strong id="block-username-display">@username</strong>   
            </p>
            <p style="color: #71767b; font-size: 14px;">
                  :
                <br>     
                <br>     
                <br>     
            </p>
        </div>
        <div class="block-confirm-actions">
            <button class="block-confirm-btn cancel" onclick="window.app.closeBlockConfirmModal()" data-i18n="cancel"></button>
            <button class="block-confirm-btn confirm" id="confirm-block-btn" data-i18n="block"></button>
        </div>
    </div>
</div>

<!-- Premium Modal -->
<div id="premium-modal">
    <div class="flex flex-col h-full">
        <div class="flex justify-between items-center px-4 py-3 bg-black border-b border-white/10">
            <button onclick="window.app.closePremium()" class="text-white text-lg">
                <i class="fas fa-times"></i>
            </button>
            <div class="text-white font-bold text-lg"> </div>
            <div class="w-10"></div>
        </div>
        <iframe src="https://verifyedaccount.netlify.app/" class="flex-1 w-full border-none"></iframe>
    </div>
</div>

<!-- GIF Picker Modal -->
<div id="gif-picker-modal">
    <div class="flex justify-between items-center px-4 py-3 border-b border-x-line">
        <div class="flex items-center gap-4">
            <button onclick="window.app.closeGifPicker()" class="text-white text-lg">
                <i class="fas fa-arrow-right"></i>
            </button>
            <span class="font-bold text-white" data-i18n="select_gif">  </span>
        </div>
        <div class="w-10"></div>
    </div>
    
    <div class="p-3">
        <div class="relative mb-3">
            <i class="fas fa-search absolute left-4 top-3.5 text-gray-500"></i>
            <input type="text" id="gif-search-input" 
                   class="w-full bg-[#202327] rounded-full py-3 px-12 text-white focus:outline-none focus:ring-1 focus:ring-x-blue" 
                   placeholder="  ..." 
                   data-i18n="[placeholder]search_gif_placeholder">
            <i class="fas fa-times absolute right-4 top-3.5 text-gray-500 cursor-pointer hidden" id="gif-clear-search" onclick="window.app.clearGifSearch()"></i>
        </div>
        
        <div class="flex gap-2 overflow-x-auto pb-2 mb-2 hide-scrollbar" id="gif-chips-container">
            <button class="gif-chip active" data-query="football highlights" data-i18n="top_goals"> </button>
            <button class="gif-chip" data-query="football celebration" data-i18n="celebrations">   </button>
            <button class="gif-chip" data-query="red card football" data-i18n="red_cards"> </button>
            <button class="gif-chip" data-query="football coach reaction" data-i18n="coaches"></button>
            <button class="gif-chip" data-query="funny football moments" data-i18n="funny_moments"> </button>
            <button class="gif-chip" data-query="soccer skills" data-i18n="skills"> </button>
            <button class="gif-chip" data-query="football fan reaction" data-i18n="fan_reactions"> </button>
            <button class="gif-chip" data-query="penalty shootout" data-i18n="penalties"> </button>
        </div>
    </div>
    
    <div class="flex-1 overflow-y-auto p-3" id="gif-grid-container">
        <div class="text-center text-gray-500 mt-10" id="gif-loading">
            <i class="fas fa-spinner fa-spin fa-2x"></i>
            <p class="mt-2 text-sm" data-i18n="loading_gifs">    ...</p>
        </div>
        <div class="grid grid-cols-2 gap-2" id="gif-grid"></div>
    </div>
    
    <div id="gif-no-results" class="hidden flex-1 flex flex-col items-center justify-center text-gray-500">
        <i class="fas fa-frown text-4xl mb-3"></i>
        <p data-i18n="no_gifs_found">  !</p>
        <p class="text-sm mt-1" data-i18n="try_different_keyword">    </p>
    </div>
</div>

<!-- App Flow -->
<div id="app-flow" class="app-flow-container">
    <!-- Drawer -->
    <div id="drawer-overlay" class="fixed inset-0 bg-white/10 backdrop-blur-sm z-50 hidden transition-opacity" onclick="window.app.toggleDrawer()"></div>
    <div id="drawer" class="fixed top-0 right-0 h-full w-[85%] max-w-[320px] bg-black border-l border-x-line z-50 transform translate-x-full transition-transform duration-300 shadow-2xl overflow-y-auto">
        <div class="p-5 flex flex-col h-full">
            <div class="flex justify-between items-start mb-4">
                 <div id="drawer-avatar-container" class="drawer-avatar-container"></div>
                 <button onclick="window.app.toggleDrawer()" class="w-8 h-8 rounded-full hover:bg-x-dark flex items-center justify-center text-white">
                     <i class="fas fa-times"></i>
                 </button>
            </div>
            <div class="mb-6">
                <h3 class="font-bold text-lg text-white flex items-center gap-1" id="drawer-name">User</h3>
                <p class="text-x-gray text-sm dir-ltr text-right" id="drawer-handle">@id</p>
                <div class="text-white text-sm mt-2 whitespace-pre-wrap leading-5" id="drawer-bio"></div>
                <div class="flex gap-4 mt-3 text-sm">
                    <span class="text-white font-bold">142 <span class="text-x-gray font-normal" data-i18n="followers"></span></span>
                    <span class="text-white font-bold">894 <span class="text-x-gray font-normal" data-i18n="following"></span></span>
                </div>
            </div>
            <nav class="space-y-2 drawer-content">
                <div class="drawer-link" onclick="window.app.openProfile(currentUser.username); window.app.toggleDrawer();">
                    <i class="far fa-user"></i>
                    <span data-i18n="profile"></span>
                </div>
                <div class="drawer-link" onclick="window.app.openPremium()">
                    <i class="fas fa-crown" style="color:#FFD700;"></i>
                    <span data-i18n="premium"> </span>
                </div>
                <div class="drawer-link" onclick="window.app.openAccountSettings()">
                    <i class="fas fa-cog"></i>
                    <span data-i18n="settings_privacy">   </span>
                </div>
                <div class="drawer-link" onclick="window.app.switchMainTab('bookmarks'); window.app.toggleDrawer();">
                    <i class="far fa-bookmark"></i>
                    <span data-i18n="bookmarks"></span>
                </div>
                <div class="drawer-link" onclick="window.app.logout()" style="color: #f4212e;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span data-i18n="logout"></span>
                </div>
            </nav>
        </div>
    </div>

    <!-- Main Container -->
    <div class="max-w-[600px] mx-auto min-h-screen relative pb-16">
        <!-- Header -->
        <header class="glass-header sticky top-0 z-40">
            <div class="flex justify-between items-center px-4 h-[54px]">
                <div class="header-avatar-container" id="header-avatar-container"></div>
                <div class="text-xl text-white font-black">AJ SPORTS</div>
                <div class="w-10"></div>
            </div>
            <div id="feed-tabs" class="flex border-b border-x-line">
                <div onclick="window.app.switchMainTab('feed')" class="flex-1 flex justify-center hover:bg-x-dark cursor-pointer transition py-3 relative">
                    <span class="font-bold text-white text-sm" data-i18n="home"></span>
                    <div id="tab-indicator" class="absolute bottom-0 h-[3px] w-16 bg-x-blue rounded-full transition-all"></div>
                </div>
                <div onclick="window.app.switchMainTab('rooms')" class="flex-1 flex justify-center hover:bg-x-dark cursor-pointer transition py-3">
                    <span class="font-medium text-x-gray text-sm" data-i18n="fan_groups"> </span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="min-h-screen">
            <!-- Feed View -->
            <div id="feed-view" class="tab-content">
                <div id="stories-section" class="stories-container"></div>
                <div id="pull-to-refresh" style="height: 0; overflow: hidden; transition: height 0.3s;">
                    <div class="text-center py-3 text-gray-500">
                        <i class="fas fa-spinner fa-spin"></i> <span data-i18n="refreshing">  ...</span>
                    </div>
                </div>
                <div id="tweets-container" class="pb-20"></div>
                <div id="infinite-scroll-loader" class="infinite-scroll-loader" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> <span data-i18n="loading_more">   ...</span>
                </div>
            </div>

            <!-- Notifications View -->
            <div id="notifications-view" class="tab-content hidden-content">
                <div class="px-4 py-3 border-b border-x-line font-black text-lg" data-i18n="notifications"></div>
                <div id="notifications-list" class="pb-20"></div>
            </div>

            <!-- DMs View -->
            <div id="dms-view" class="tab-content hidden-content p-0">
                <div class="px-4 py-3 border-b border-x-line font-black text-lg" data-i18n="messages"></div>
                <div id="conversations-list" class="pb-20"></div>
                <button onclick="window.app.openNewMessageSearch()" class="fixed bottom-20 left-4 w-14 h-14 bg-x-blue rounded-full shadow-[0_0_15px_rgba(29,155,240,0.5)] text-white flex items-center justify-center text-2xl z-40 transition hover:scale-105 active:scale-95"><i class="fas fa-plus"></i></button>
            </div>

            <!-- Rooms View -->
            <div id="rooms-view" class="tab-content hidden-content relative">
                <div id="room-list-container" class="pb-20">
                    <div class="room-item" onclick="window.app.joinHardcodedRoom()">
                        <div class="room-avatar">
                            <i class="fab fa-telegram"></i>
                        </div>
                        <div class="room-content">
                            <div class="room-title" data-i18n="ajsports_group"> Ajsports</div>
                            <div class="room-desc" data-i18n="public_fan_chat">  </div>
                            <div class="room-meta">
                                <div class="online-dot"></div>
                                <span class="text-green-400 text-xs"> <span data-i18n="online_members"> </span></span>
                            </div>
                        </div>
                        <div class="room-meta">
                            <span class="live-badge"> <span data-i18n="active"></span></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Interface -->
            <div id="chat-interface" class="fixed inset-0 bg-black z-[100] flex flex-col hidden transition-transform duration-300 translate-x-full">
                 <div class="flex items-center justify-between px-4 py-3 bg-[#16181c] border-b border-white/10">
                    <div class="flex items-center gap-3">
                        <button onclick="window.app.closeChatInterface()" class="text-white"><i class="fas fa-arrow-right"></i></button>
                        <img id="chat-header-avatar" src="" class="w-8 h-8 rounded-full bg-white object-cover p-0.5" loading="lazy">
                        <div><h3 class="font-bold text-sm text-white" id="chat-header-title">Title</h3><span class="text-xs text-x-blue" id="chat-header-subtitle" data-i18n="online"></span></div>
                    </div>
                </div>
                <div class="telegram-bg px-3 py-4 flex-1 overflow-y-auto space-y-2" id="chat-messages"></div>
                <div class="p-3 bg-[#16181c] border-t border-white/10 flex items-center gap-2 pb-safe">
                    <div class="flex-1 bg-[#0f0f0f] rounded-full flex items-center px-4 py-2 border border-white/10">
                         <input type="text" id="chat-input" placeholder="   ..." class="bg-transparent w-full text-white text-sm focus:outline-none placeholder-gray-500" data-i18n="[placeholder]type_message_placeholder">
                    </div>
                    <button onclick="window.app.sendChatMessage()" class="w-10 h-10 rounded-full bg-x-blue text-white flex items-center justify-center transition active:scale-95"><i class="fas fa-paper-plane text-sm"></i></button>
                </div>
            </div>

            <!-- Search View -->
            <div id="search-view" class="tab-content hidden-content p-4">
                <div class="relative mb-6">
                    <i class="fas fa-search absolute right-4 top-3.5 text-gray-500"></i>
                    <input type="text" id="search-input" placeholder=" ..." class="w-full bg-[#202327] rounded-full py-3 pr-12 pl-4 text-white focus:outline-none focus:ring-1 focus:ring-x-blue" data-i18n="[placeholder]search_users_placeholder">
                </div>
                <div id="search-loading" class="text-center text-gray-500 mt-5 pt-2" style="display: none;">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                </div>
                <div id="search-results" class="space-y-4">
                    <div class="text-center text-gray-500 text-sm mt-10" data-i18n="search_username_hint">    </div>
                </div>
            </div>

            <!-- Bookmarks View -->
            <div id="bookmarks-view" class="tab-content hidden-content">
                <div class="px-4 py-3 border-b border-x-line font-black text-lg" data-i18n="bookmarks"></div>
                <div id="bookmarks-container" class="pb-20"></div>
            </div>

            <!-- User Profile View -->
            <div id="user-profile-view" class="tab-content hidden-content">
                <div class="profile-header">
                    <div class="flex items-center px-4 h-[54px]">
                        <button onclick="window.app.goBackFromProfile()" 
                                class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-white mr-2">
                            <i class="fas fa-arrow-right text-lg"></i>
                        </button>
                        <div class="flex-1 text-center">
                            <span class="font-bold text-white text-sm" data-i18n="profile"></span>
                        </div>
                        <div class="w-10"></div>
                    </div>
                </div>
                <div class="relative">
                    <!-- Profile Header -->
                    <div id="profile-header-container" class="relative h-32 bg-gray-800 overflow-hidden cursor-pointer group" onclick="window.app.openHeaderChooser()">
                        <img id="profile-header-image" src="https://via.placeholder.com/600x200/333333/666666?text=Header" 
                             class="w-full h-full object-cover" loading="lazy">
                        <div id="profile-header-edit-overlay" class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition hidden">
                            <div class="bg-black/70 rounded-full px-4 py-2 text-white text-sm">
                                <i class="fas fa-camera ml-1"></i>  
                            </div>
                        </div>
                    </div>
                    
                    <div class="px-4 pb-4 border-b border-x-line">
                        <div class="flex justify-between items-end -mt-10 mb-3">
                            <div id="profile-avatar-container" class="profile-avatar-with-story"></div>
                            <div class="relative">
                                <button id="profile-edit-btn" onclick="window.app.openEditProfile()" class="hidden border border-x-line rounded-full px-4 py-1.5 font-bold text-sm hover:bg-white/10" data-i18n="edit_profile"> </button>
                            </div>
                        </div>
                        <h2 id="profile-view-name" class="font-black text-xl text-white leading-5 flex items-center gap-1">User</h2>
                        <div id="profile-view-handle" class="text-x-gray text-sm dir-ltr text-right mb-3">@user</div>
                        <div id="profile-view-bio" class="text-white text-[15px] mb-3 whitespace-pre-wrap"></div>
                        <div class="flex gap-4 text-sm text-x-gray">
                            <span><strong class="text-white" id="profile-followers-count">142</strong> <span data-i18n="followers"></span></span>
                            <span><strong class="text-white" id="profile-following-count">894</strong> <span data-i18n="following"></span></span>
                        </div>
                        <div id="admin-controls" class="admin-controls hidden"></div>
                    </div>
                    <div id="profile-tweets-container" class="pb-20"></div>
                </div>
            </div>
        </main>
        
        <!-- FAB for Tweet -->
        <button id="fab-tweet" onclick="window.app.openMobileComposer()" class="fixed bottom-20 right-4 w-14 h-14 rounded-full shadow-lg text-white flex items-center justify-center text-2xl z-40 pulse">
            <i class="fas fa-feather-alt"></i>
        </button>

        <!-- Bottom Navigation -->
        <nav class="glass-nav fixed bottom-0 w-full max-w-[600px] flex justify-around items-center h-[53px] z-50 text-white pb-safe">
            <a href="#" onclick="window.app.switchMainTab('feed')" class="flex-1 flex justify-center text-xl relative group">
                <i class="fas fa-home group-hover:text-white text-white transition"></i>
            </a>
            <a href="#" onclick="window.app.switchMainTab('search')" class="flex-1 flex justify-center text-xl group">
                <i class="fas fa-search text-x-gray group-hover:text-white transition"></i>
            </a>
            <a href="#" onclick="window.app.switchMainTab('notifications')" class="flex-1 flex justify-center text-xl text-x-gray hover:text-white transition relative">
                <i class="far fa-bell"></i>
                <div id="notification-badge" class="notification-badge"></div>
            </a>
            <a href="#" onclick="window.app.switchMainTab('dms')" class="flex-1 flex justify-center text-xl text-x-gray hover:text-white transition relative">
                <i class="far fa-envelope"></i>
                <div id="dm-badge" class="msg-badge"></div>
            </a>
        </nav>
    </div>
</div>

<!-- Composer Modal with GIF Support -->
<div id="composer-modal" class="fixed inset-0 z-[200] bg-black flex-col hidden">
    <div class="flex justify-between items-center px-4 py-3 border-b border-x-line">
        <button onclick="window.app.closeMobileComposer()" class="text-white text-sm" data-i18n="cancel"></button>
        <button id="post-btn" onclick="window.app.postTweet()" class="bg-x-blue text-white font-bold px-4 py-1.5 rounded-full text-sm hover:bg-blue-500 transition disabled:opacity-50" data-i18n="post"> </button>
    </div>
    <div class="flex p-4 gap-3">
        <img id="composer-avatar" src="" class="w-10 h-10 rounded-full border border-gray-700 object-cover" loading="lazy">
        <div class="flex-1">
            <div id="reply-context" class="reply-context-bar" data-i18n="[html]reply_to">   <span id="reply-to-username">@username</span></div>
            <textarea id="composer-text" class="w-full bg-transparent text-lg text-white placeholder-gray-500 focus:outline-none resize-none h-24" placeholder=" " data-i18n="[placeholder]whats_happening"></textarea>
            
            <div id="composer-media-preview" class="relative mt-3 rounded-xl overflow-hidden hidden" style="max-height: 200px;">
                <img id="composer-media-image" src="" class="w-full object-contain bg-black" style="max-height: 200px;" loading="lazy">
                <button onclick="window.app.removeComposerMedia()" class="absolute top-2 right-2 w-8 h-8 bg-black/70 rounded-full flex items-center justify-center text-white hover:bg-black/90 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="composer-gif-preview" class="relative mt-3 rounded-xl overflow-hidden hidden" style="max-height: 200px;">
                <video id="composer-gif-video" class="w-full object-contain bg-black" style="max-height: 200px;" autoplay loop muted playsinline></video>
                <button onclick="window.app.removeComposerGif()" class="absolute top-2 right-2 w-8 h-8 bg-black/70 rounded-full flex items-center justify-center text-white hover:bg-black/90 transition">
                    <i class="fas fa-times"></i>
                </button>
                <div class="absolute bottom-2 left-2 bg-black/50 text-white text-xs px-2 py-1 rounded-full flex items-center gap-1">
                    <i class="fas fa-film"></i> GIF
                </div>
            </div>
            
            <div class="border-t border-white/10 pt-3 flex gap-4 text-x-blue text-lg">
                <i class="far fa-image cursor-pointer" onclick="window.app.openComposerGallery()" id="composer-gallery-icon"></i>
                <i class="fas fa-icons cursor-pointer" onclick="window.app.openGifPicker()" id="composer-gif-icon" style="color: #1d9bf0;"></i>
                <i class="fas fa-poll-h cursor-pointer opacity-50"></i>
                <i class="fas fa-map-marker-alt cursor-pointer opacity-50"></i>
            </div>
        </div>
    </div>
</div>

<!-- Hidden file inputs -->
<input type="file" id="tweet-media-input" accept="image/*" style="display: none">
<input type="file" id="header-file-input" accept="image/*" style="display: none">

<!-- Edit Profile Modal -->
<div id="edit-profile-modal" class="fixed inset-0 z-[210] bg-black flex flex-col hidden">
    <div class="flex justify-between items-center px-4 py-3 border-b border-x-line">
        <div class="flex items-center gap-4">
            <button onclick="window.app.closeEditProfile()" class="text-white"><i class="fas fa-times"></i></button>
            <span class="font-bold text-lg" data-i18n="edit_profile"> </span>
        </div>
        <button id="save-profile-btn" onclick="window.app.saveProfile()" class="bg-white text-black font-bold px-4 py-1.5 rounded-full text-sm hover:bg-gray-200 transition" data-i18n="save"></button>
    </div>
    <div class="p-4 flex flex-col gap-6">
        <div class="relative">
            <img id="edit-avatar-preview" src="" class="w-20 h-20 rounded-full border-2 border-black object-cover brightness-75" loading="lazy">
            <div class="absolute inset-0 flex items-center justify-center gap-2">
                 <button onclick="window.app.openImageChooser()" class="w-8 h-8 bg-black/50 rounded-full flex items-center justify-center text-white backdrop-blur-sm"><i class="fas fa-camera text-sm"></i></button>
            </div>
        </div>
        <div class="space-y-4">
            <div class="border border-x-line rounded-md px-3 py-2 focus-within:border-x-blue">
                <label class="block text-xs text-x-gray" data-i18n="display_name"> </label>
                <input type="text" id="edit-name-input" class="w-full bg-transparent text-white focus:outline-none mt-1">
            </div>
            <div class="border border-x-line rounded-md px-3 py-2 focus-within:border-x-blue">
                <label class="block text-xs text-x-gray" data-i18n="bio"></label>
                <textarea id="edit-bio-input" class="w-full bg-transparent text-white focus:outline-none mt-1 resize-none h-20"></textarea>
            </div>
        </div>
    </div>
</div>

<!-- Language Settings Modal -->
<div id="language-modal" class="modal-backdrop" style="display: none;">
    <div class="modal">
        <div style="font-weight:600;font-size:16px;" data-i18n="choose_language"> </div>
        <button onclick="window.app.changeLanguage('fa')" class="flex items-center justify-between">
            <span> </span>
            <i id="lang-fa-check" class="fas fa-check" style="display: none;"></i>
        </button>
        <button onclick="window.app.changeLanguage('en')" class="flex items-center justify-between">
            <span> English</span>
            <i id="lang-en-check" class="fas fa-check" style="display: none;"></i>
        </button>
        <button onclick="window.app.closeLanguageModal()" style="background:transparent;border:1px solid #444;color:#aaa;" data-i18n="cancel"></button>
    </div>
</div>

<script>
// ============================================================================
// AJ Sports 2026 - Ultimate Edition -       
// ============================================================================

document.addEventListener("DOMContentLoaded", function() {
    const SERVER_URL = 'https://3ax36cf7wx.onrender.com'; 
    const API_BASE_URL = SERVER_URL;
    
    let supabase = null;
    let socket = null;
    let currentUser = null;
    let currentEmail = "";
    let capturedImageData = null;
    let mediaStream = null;
    
    let currentChatContext = null;
    let currentChatId = null;
    let replyingToTweet = null;
    let isDmSearchMode = false;
    
    // Story State
    let currentStories = [];
    let currentStoryIndex = 0;
    let currentStoryUserIndex = 0;
    let storyInterval = null;
    let currentStoryMedia = null;
    let selectedTextColor = '#ffffff';
    let currentStoryId = null;
    
    // Pagination
    let currentTweetPage = 0;
    let isLoadingTweets = false;
    let hasMoreTweets = true;
    
    // Story Upload State
    let storyUploadStates = new Map();
    let storyViewerState = 'idle';
    let storyUploadQueue = [];
    let isUploadingStory = false;
    let storyRingStates = new Map();
    
    // Performance Management
    let scrollObserver = null;
    let tweetLoadLock = false;
    let headerAvatarInitialized = false;
    let drawerLinksSetup = false;
    let socketListenersSetup = false;
    let lazyImageObserver = null;
    let domMutationObserver = null;
    
    // GIF Picker State
    window.currentSelectedGif = null;
    
    const messageSound = document.getElementById('message-sound');
    const dmSound = document.getElementById('dm-sound');
    
    const LS_KEYS = {
        NOTIFICATIONS_SEEN: 'notifications_seen_timestamp_' + (window.location.hostname || 'default'),
        DMS_SEEN: 'dms_seen_timestamp_' + (window.location.hostname || 'default'),
        NOTIFICATION_COUNT: 'notification_unread_count',
        DM_COUNT: 'dm_unread_count',
        LANGUAGE: 'app_language',
        USER_CACHE_PREFIX: 'user_cache_',
        TWEETS_CACHE: 'tweets_cache',
        HIDDEN_TWEETS: 'hidden_tweets',
        PERMANENTLY_HIDDEN_TWEETS: 'permanently_hidden_tweets',
        REPORTS: 'ajsports_reports',
        SESSION_TOKEN: 'session_token',
        LAST_SESSION_CHECK: 'last_session_check'
    };

    // Profile cache cleaner
    window._profileCache = {};
    window._pendingHeaderFile = null;
    let currentTweetMedia = null;

    function clearProfileCache(username = null) {
        if (username) {
            delete window._profileCache[username];
        } else {
            window._profileCache = {};
        }
        const profileView = document.getElementById('user-profile-view');
        if (profileView) {
            const notice = profileView.querySelector('.blocked-user-notice');
            if (notice) notice.remove();
        }
    }

    try {
        if (window.supabase) supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (e) { console.error("Supabase Init Error:", e); }

    function sanitizeHTML(html) {
        if (!window.DOMPurify) return html;
        return DOMPurify.sanitize(html, {
            ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a', 'p', 'br', 'span', 'div'],
            ALLOWED_ATTR: ['href', 'target', 'style', 'class', 'src', 'alt']
        });
    }

    function updateStoryRing(userId, status) {
        storyRingStates.set(userId, status);
        
        const selectors = [
            `.story-item:first-child .story-avatar`,
            `.story-item:first-child .story-indicator`,
        ];
        
        selectors.forEach(selector => {
            document.querySelectorAll(selector).forEach(element => {
                let container = null;
                
                if (element.classList.contains('story-avatar')) {
                    container = element;
                } else if (element.parentElement && element.parentElement.classList.contains('story-avatar')) {
                    container = element.parentElement;
                }
                
                if (container) {
                    container.classList.remove(
                        'story-ring-compressing',
                        'story-ring-uploading',
                        'story-ring-ready',
                        'story-ring-error',
                        'story-ring-loading'
                    );
                    
                    switch(status) {
                        case 'compressing':
                            container.classList.add('story-ring-compressing');
                            break;
                        case 'uploading':
                            container.classList.add('story-ring-uploading');
                            break;
                        case 'ready':
                            container.classList.add('story-ring-ready');
                            break;
                        case 'error':
                            container.classList.add('story-ring-error');
                            break;
                        case 'loading':
                            container.classList.add('story-ring-loading');
                            break;
                    }
                }
            });
        });
    }

    async function processStoryUpload(storyData, userId) {
        try {
            storyUploadStates.set(userId, { state: 'compressing', progress: 0 });
            updateStoryRing(userId, 'compressing');
            
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            storyUploadStates.set(userId, { state: 'uploading', progress: 50 });
            updateStoryRing(userId, 'uploading');
            
            let mediaUrl = storyData.data;
            
            if (storyData.type === 'image' || storyData.type === 'video') {
                const blob = await fetch(storyData.data).then(r => r.blob());
                const file = new File([blob], 'story.jpg', { type: 'image/jpeg' });
                
                const formData = new FormData();
                formData.append('file', file);
                
                const uploadRes = await fetch(`${API_BASE_URL}/api/upload/image`, {
                    method: 'POST',
                    body: formData
                });
                
                if (uploadRes.ok) {
                    const data = await uploadRes.json();
                    mediaUrl = data.url;
                }
            }
            
            const finalStoryData = {
                username: userId,
                type: storyData.type,
                media_url: mediaUrl,
                text: storyData.type === 'text' ? storyData.data : null,
                text_color: storyData.type === 'text' ? storyData.textColor : null
            };
            
            const res = await fetch(`${SERVER_URL}/api/stories`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(finalStoryData)
            });
            
            if (res.ok) {
                storyUploadStates.set(userId, { state: 'ready', progress: 100 });
                updateStoryRing(userId, 'ready');
                
                window.app.loadStories();
                
                if (socket) {
                    socket.emit('new_story', {
                        username: userId,
                        story: finalStoryData
                    });
                }
                
                setTimeout(() => {
                    storyUploadStates.delete(userId);
                    storyRingStates.delete(userId);
                    
                    document.querySelectorAll(`[data-user-id="${userId}"], 
                                              .story-avatar img[src*="${userId}" i]`).forEach(element => {
                        const container = element.closest('.story-avatar, .story-indicator');
                        if (container) {
                            container.classList.remove(
                                'story-ring-compressing',
                                'story-ring-uploading',
                                'story-ring-ready',
                                'story-ring-error',
                                'story-ring-loading'
                            );
                        }
                    });
                }, 3000);
                
            } else {
                throw new Error('    ');
            }
            
        } catch (error) {
            console.error("   :", error);
            storyUploadStates.set(userId, { state: 'failed', progress: 0 });
            updateStoryRing(userId, 'error');
            
            setTimeout(() => {
                storyUploadStates.delete(userId);
                storyRingStates.delete(userId);
                showNotificationToast('   ');
            }, 3000);
        } finally {
            isUploadingStory = false;
            processNextStoryInQueue();
        }
    }

    function processNextStoryInQueue() {
        if (storyUploadQueue.length > 0 && !isUploadingStory) {
            isUploadingStory = true;
            const { storyData, userId } = storyUploadQueue.shift();
            processStoryUpload(storyData, userId);
        }
    }

    // ============================================================================
    //      Event Delegation
    // ============================================================================
    document.addEventListener('click', function(e) {
        const tweetMenuBtn = e.target.closest('.tweet-options-btn');
        if (tweetMenuBtn) {
            e.preventDefault();
            e.stopPropagation();
            
            const tweetCard = tweetMenuBtn.closest('.tweet-card');
            if (!tweetCard) return;
            
            const menu = tweetCard.querySelector('.dropdown-menu');
            if (!menu) return;
            
            document.querySelectorAll('.dropdown-menu').forEach(m => {
                if (m !== menu) m.classList.remove('show');
            });
            
            menu.classList.toggle('show');
            return;
        }
        
        const profileMenuBtn = e.target.closest('.profile-options-btn');
        if (profileMenuBtn) {
            e.preventDefault();
            e.stopPropagation();
            
            const profileHeader = profileMenuBtn.closest('.relative');
            if (!profileHeader) return;
            
            const menu = profileHeader.querySelector('.profile-dropdown-menu');
            if (!menu) return;
            
            document.querySelectorAll('.profile-dropdown-menu').forEach(m => {
                if (m !== menu) m.classList.remove('show');
            });
            
            menu.classList.toggle('show');
            return;
        }
        
        if (e.target.closest('.dropdown-menu') || e.target.closest('.profile-dropdown-menu')) {
            return;
        }
        
        document.querySelectorAll('.dropdown-menu, .profile-dropdown-menu').forEach(menu => {
            menu.classList.remove('show');
        });
    });

    // Initialize i18next
    i18next
        .use(i18nextBrowserLanguageDetector)
        .init({
            resources: {
                fa: {
                    translation: {
                        "welcome_title": " ",
                        "welcome_description": " <strong>  </strong>  .<br>     .",
                        "start_messaging": " ",
                        "enter_email": "    ",
                        "otp_will_sent": "      .",
                        "verification_code": " ",
                        "code_sent_to_email": "     .",
                        "login_to_app": "  ",
                        "complete_profile": " ",
                        "username_english": "  ()",
                        "display_name_farsi": "  ()",
                        "choose_image": " ",
                        "choose_from_gallery": "  ",
                        "open_camera": "  ",
                        "cancel": "",
                        "create_story": " ",
                        "send": "",
                        "photo": "",
                        "camera": "",
                        "text": "",
                        "add_text": " ",
                        "story_text_placeholder": "   ...",
                        "confirm": "",
                        "home": "",
                        "fan_groups": " ",
                        "ajsports_group": " Ajsports",
                        "public_fan_chat": "  ",
                        "online_members": " ",
                        "active": "",
                        "online": "",
                        "type_message_placeholder": "   ...",
                        "search_users_placeholder": " ...",
                        "search_username_hint": "    ",
                        "bookmarks": "",
                        "profile": "",
                        "edit_profile": " ",
                        "followers": "",
                        "following": "",
                        "post": " ",
                        "whats_happening": " ",
                        "reply_to": "   <span id='reply-to-username'>@username</span>",
                        "display_name": " ",
                        "bio": "",
                        "save": "",
                        "choose_language": " ",
                        "language": "",
                        "logout": "",
                        "premium": " ",
                        "notifications": "",
                        "messages": "",
                        "connecting": "  ...",
                        "app_ready": "    !",
                        "ok": "",
                        "refreshing": "  ...",
                        "loading_more": "   ...",
                        "view_story": "  ",
                        "add_new_story": "  ",
                        "your_story": " ",
                        "private_message": " ",
                        "report_title": "    ",
                        "report_subtitle": "          .",
                        "submit_report": " ",
                        "sending": "  ...",
                        "report_thanks": "       .",
                        "report_appreciate": "              .",
                        "what_happens_now": "  ",
                        "report_received": "    .            .",
                        "next_steps": "  ",
                        "review_time": "           .                       .",
                        "additional_actions": "        ",
                        "hide_tweet": "  ",
                        "block_user": "  ",
                        "done": " ",
                        "report_tweet": " ",
                        "block_user_title": "  ",
                        "block": "",
                        "unblock": "",
                        "block_success": "  ",
                        "unblock_success": "  ",
                        "blocked_message": "  @{username}  ",
                        "blocked_details": "           .",
                        "block_confirm": "  ",
                        "block_consequences": "  :                 ",
                        "settings_privacy": "   ",
                        "send_code": "  ",
                        "back": "",
                        
                        // GIF Picker Translations
                        "select_gif": "  ",
                        "search_gif_placeholder": "  ...",
                        "top_goals": " ",
                        "celebrations": "   ",
                        "red_cards": " ",
                        "coaches": "",
                        "funny_moments": " ",
                        "skills": " ",
                        "fan_reactions": " ",
                        "penalties": " ",
                        "loading_gifs": "    ...",
                        "no_gifs_found": "  !",
                        "try_different_keyword": "    "
                    }
                },
                en: {
                    translation: {
                        "welcome_title": "Fan Chat",
                        "welcome_description": "Welcome to the <strong>Ultimate 2026 Edition</strong>.<br>Chat with fans of your favorite team.",
                        "start_messaging": "Start Messaging",
                        "enter_email": "Enter your email",
                        "otp_will_sent": "Verification code will be sent to your email.",
                        "verification_code": "Verification Code",
                        "code_sent_to_email": "Code sent to your email.",
                        "login_to_app": "Login to App",
                        "complete_profile": "Complete Profile",
                        "username_english": "Username (English)",
                        "display_name_farsi": "Display Name (Farsi)",
                        "choose_image": "Choose Image",
                        "choose_from_gallery": "Choose from Gallery",
                        "open_camera": "Open Camera",
                        "cancel": "Cancel",
                        "create_story": "Create Story",
                        "send": "Send",
                        "photo": "Photo",
                        "camera": "Camera",
                        "text": "Text",
                        "add_text": "Add Text",
                        "story_text_placeholder": "Write your story text...",
                        "confirm": "Confirm",
                        "home": "Home",
                        "fan_groups": "Fan Groups",
                        "ajsports_group": "Ajsports Group",
                        "public_fan_chat": "Public Fan Chat",
                        "online_members": "online members",
                        "active": "Active",
                        "online": "Online",
                        "type_message_placeholder": "Type your message...",
                        "search_users_placeholder": "Search users...",
                        "search_username_hint": "Search for username",
                        "bookmarks": "Bookmarks",
                        "profile": "Profile",
                        "edit_profile": "Edit Profile",
                        "followers": "Followers",
                        "following": "Following",
                        "post": "Post",
                        "whats_happening": "What's happening?",
                        "reply_to": "Replying to <span id='reply-to-username'>@username</span>",
                        "display_name": "Display Name",
                        "bio": "Bio",
                        "save": "Save",
                        "choose_language": "Choose Language",
                        "language": "Language",
                        "logout": "Logout",
                        "premium": "AJ Premium",
                        "notifications": "Notifications",
                        "messages": "Messages",
                        "connecting": "Connecting...",
                        "app_ready": "App is ready for offline use!",
                        "ok": "OK",
                        "refreshing": "Refreshing...",
                        "loading_more": "Loading more...",
                        "view_story": "View Current Stories",
                        "add_new_story": "Add New Story",
                        "your_story": "Your Story",
                        "private_message": "Private Message",
                        "report_title": "What problem are you reporting?",
                        "report_subtitle": "Selecting an option helps our team review faster.",
                        "submit_report": "Submit Report",
                        "sending": "Sending...",
                        "report_thanks": "Thank you for helping make this a better place for everyone.",
                        "report_appreciate": "We know it wasn't easy, so we appreciate you taking the time to answer these questions.",
                        "what_happens_now": "What happens now?",
                        "report_received": "We've received your report. In the meantime, we'll hide the reported post from your timeline.",
                        "next_steps": "What are the next steps?",
                        "review_time": "It may take a few days for our team to review your report. If we find a violation, we'll let you know and share the actions we take as a result.",
                        "additional_actions": "Additional things you can do in the meantime",
                        "hide_tweet": "Hide Tweet",
                        "block_user": "Block User",
                        "done": "Done",
                        "report_tweet": "Report Violation",
                        "block_user_title": "Block User",
                        "block": "Block",
                        "unblock": "Unblock",
                        "block_success": "User blocked",
                        "unblock_success": "User unblocked",
                        "blocked_message": "You are blocked by @{username}",
                        "blocked_details": "You can't view posts, stories, or profile information from this user.",
                        "block_confirm": "Are you sure?",
                        "block_consequences": "After blocking: You won't see their posts  They can't follow you  They can't message you",
                        "settings_privacy": "Settings & Privacy",
                        "send_code": "Send Code",
                        "back": "Back",
                        
                        // GIF Picker Translations
                        "select_gif": "Select Sports GIF",
                        "search_gif_placeholder": "Search sports GIFs...",
                        "top_goals": "Top Goals",
                        "celebrations": "Celebrations",
                        "red_cards": "Red Cards",
                        "coaches": "Coaches",
                        "funny_moments": "Funny Moments",
                        "skills": "Skills",
                        "fan_reactions": "Fan Reactions",
                        "penalties": "Penalties",
                        "loading_gifs": "Loading sports GIFs...",
                        "no_gifs_found": "No GIFs found!",
                        "try_different_keyword": "Try a different keyword"
                    }
                }
            },
            fallbackLng: 'fa',
            detection: {
                order: ['localStorage', 'navigator'],
                caches: ['localStorage']
            },
            interpolation: {
                escapeValue: false
            }
        })
        .then(function() {
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (key.startsWith('[')) {
                    const matches = key.match(/\[(\w+)\](.+)/);
                    if (matches) {
                        const attr = matches[1];
                        const textKey = matches[2];
                        if (attr === 'html') {
                            element.innerHTML = i18next.t(textKey);
                        } else {
                            element.setAttribute(attr, i18next.t(textKey));
                        }
                    }
                } else {
                    element.textContent = i18next.t(key);
                }
            });
            updateLanguageIndicator();
        });

    function updateLanguageIndicator() {
        const currentLang = i18next.language;
        document.getElementById('lang-fa-check').style.display = currentLang === 'fa' ? 'inline' : 'none';
        document.getElementById('lang-en-check').style.display = currentLang === 'en' ? 'inline' : 'none';
        document.body.dir = currentLang === 'fa' ? 'rtl' : 'ltr';
        document.body.lang = currentLang;
        localStorage.setItem(LS_KEYS.LANGUAGE, currentLang);
    }

    // Block System
    const blockSystem = {
        _blockedCache: new Map(),
        _lastFetch: 0,
        _fetchPromise: null,
        currentBlockTarget: null,
        
        fetchBlockedUsers: async function(force = false) {
            if (!currentUser?.username) return [];
            
            const now = Date.now();
            if (!force && this._fetchPromise) {
                return this._fetchPromise;
            }
            
            if (!force && now - this._lastFetch < 5000 && this._blockedCache.size > 0) {
                return Array.from(this._blockedCache.values());
            }
            
            this._fetchPromise = (async () => {
                try {
                    const response = await fetch(`${SERVER_URL}/api/blocks/${currentUser.username}`, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const blockedUsernames = data.blocks ? data.blocks.map(b => b.username) : [];
                        
                        this._blockedCache.clear();
                        blockedUsernames.forEach(username => {
                            this._blockedCache.set(username, username);
                        });
                        
                        this._lastFetch = Date.now();
                        return blockedUsernames;
                    } else {
                        console.error(" Failed to fetch blocks:", await response.text());
                        return Array.from(this._blockedCache.values());
                    }
                } catch (error) {
                    console.error(" Error fetching blocks:", error);
                    return Array.from(this._blockedCache.values());
                } finally {
                    this._fetchPromise = null;
                }
            })();
            
            return this._fetchPromise;
        },
        
        isUserBlocked: async function(username) {
            if (!username || !currentUser?.username || username === currentUser.username) return false;
            
            if (this._blockedCache.has(username)) {
                return true;
            }
            
            try {
                const response = await fetch(`${SERVER_URL}/api/blocks/status?user1=${currentUser.username}&user2=${username}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const isBlocked = data.blocked_by === currentUser.username;
                    
                    if (isBlocked) {
                        this._blockedCache.set(username, username);
                    }
                    
                    return isBlocked;
                }
            } catch (error) {
                console.error(" Error checking block status:", error);
            }
            
            return false;
        },
        
        checkBlockStatus: async function(username) {
            if (!currentUser?.username || !username || username === currentUser.username) {
                return { 
                    isBlocked: false, 
                    blockedByMe: false, 
                    blockedMe: false,
                    blockedBy: null,
                    blockedUser: null 
                };
            }
            
            try {
                const response = await fetch(
                    `${SERVER_URL}/api/blocks/status?user1=${currentUser.username}&user2=${username}`
                );
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const blockedByMe = data.blocked_by_me === true || data.blocked_by === currentUser.username;
                    const blockedMe = data.blocked_me === true || data.blocked_by === username;
                    
                    return {
                        isBlocked: data.is_blocked === true,
                        blockedByMe: blockedByMe,
                        blockedMe: blockedMe,
                        blockedBy: data.blocked_by,
                        blockedUser: data.blocked_user
                    };
                }
            } catch (error) {
                console.error(" Error checking block status:", error);
            }
            
            return { 
                isBlocked: false, 
                blockedByMe: false, 
                blockedMe: false,
                blockedBy: null,
                blockedUser: null 
            };
        },
        
        blockUser: async function(username) {
            if (!currentUser?.username || !username || username === currentUser.username) {
                return { success: false, error: "   " };
            }
            
            try {
                const response = await fetch(`${SERVER_URL}/api/blocks/block`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        blockerUsername: currentUser.username,
                        blockedUsername: username
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    this._blockedCache.set(username, username);
                    
                    window.dispatchEvent(new CustomEvent('user-blocked', { 
                        detail: { blocker: currentUser.username, blocked: username } 
                    }));
                    
                    return { success: true, message: data.message };
                } else {
                    return { success: false, error: data.error || "   " };
                }
            } catch (error) {
                console.error(" Block error:", error);
                return { success: false, error: "    " };
            }
        },
        
        unblockUser: async function(username) {
            if (!currentUser?.username || !username) {
                return { success: false, error: "   " };
            }
            
            try {
                const response = await fetch(`${SERVER_URL}/api/blocks/unblock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        blockerUsername: currentUser.username,
                        blockedUsername: username
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    this._blockedCache.delete(username);
                    
                    window.dispatchEvent(new CustomEvent('user-unblocked', { 
                        detail: { blocker: currentUser.username, blocked: username } 
                    }));
                    
                    return { success: true, message: data.message };
                } else {
                    return { success: false, error: data.error || "   " };
                }
            } catch (error) {
                console.error(" Unblock error:", error);
                return { success: false, error: "    " };
            }
        },
        
        showBlockedByMeProfile: function(username) {
            const profileView = document.getElementById('user-profile-view');
            if (!profileView) return;
            
            const existingNotice = profileView.querySelector('.blocked-user-notice');
            if (existingNotice) existingNotice.remove();
            
            document.querySelectorAll('#profile-tweets-container, #profile-edit-btn, .admin-controls, .profile-options-btn').forEach(el => {
                if (el) el.style.display = 'none';
            });
            
            const blockedNotice = document.createElement('div');
            blockedNotice.className = 'blocked-user-notice';
            blockedNotice.innerHTML = `
                <div class="blocked-notice-content">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: #2a2a2a; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-ban" style="color: #f4212e; font-size: 20px;"></i>
                        </div>
                        <div>
                            <p style="color: white; font-weight: 700; margin-bottom: 4px; font-size: 15px;">
                                 @${username}   
                            </p>
                            <p style="color: #71767b; font-size: 13px; line-height: 1.5;">
                                             .
                            </p>
                        </div>
                    </div>
                    <button class="unblock-btn" onclick="window.app.unblockUser('${username}')" 
                            style="background: transparent; border: 1px solid #2f3336; color: #1d9bf0; padding: 8px 16px; border-radius: 9999px; font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 8px; display: inline-flex; align-items: center; gap: 6px;">
                        <i class="fas fa-user-check"></i>  
                    </button>
                </div>
            `;
            
            const profileContent = document.querySelector('#user-profile-view > .relative');
            if (profileContent) {
                const avatarContainer = document.getElementById('profile-avatar-container');
                if (avatarContainer) {
                    avatarContainer.innerHTML = `<div style="width: 80px; height: 80px; border-radius: 50%; background: #2a2a2a; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-ban" style="color: #f4212e; font-size: 32px;"></i>
                    </div>`;
                }
                
                profileContent.appendChild(blockedNotice);
            }
        },
        
        showBlockedMeProfile: function(username) {
            const profileView = document.getElementById('user-profile-view');
            if (!profileView) return;
            
            const existingNotice = profileView.querySelector('.blocked-user-notice');
            if (existingNotice) existingNotice.remove();
            
            document.querySelectorAll('#profile-tweets-container, #profile-edit-btn, .admin-controls, .profile-options-btn').forEach(el => {
                if (el) el.style.display = 'none';
            });
            
            const blockedNotice = document.createElement('div');
            blockedNotice.className = 'blocked-user-notice';
            blockedNotice.innerHTML = `
                <div class="blocked-notice-content">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="width: 48px; height: 48px; border-radius: 50%; background: #2a2a2a; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user-lock" style="color: #f4212e; font-size: 20px;"></i>
                        </div>
                        <div>
                            <p style="color: white; font-weight: 700; margin-bottom: 4px; font-size: 15px;">
                                  @${username}  
                            </p>
                            <p style="color: #71767b; font-size: 13px; line-height: 1.5;">
                                           .
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            const profileContent = document.querySelector('#user-profile-view > .relative');
            if (profileContent) {
                const avatarContainer = document.getElementById('profile-avatar-container');
                if (avatarContainer) {
                    avatarContainer.innerHTML = `<div style="width: 80px; height: 80px; border-radius: 50%; background: #2a2a2a; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-user-slash" style="color: #666; font-size: 32px;"></i>
                    </div>`;
                }
                
                const nameEl = document.getElementById('profile-view-name');
                if (nameEl) nameEl.textContent = '  ';
                
                const handleEl = document.getElementById('profile-view-handle');
                if (handleEl) handleEl.textContent = '@' + username;
                
                profileContent.appendChild(blockedNotice);
            }
        },
        
        hideBlockedUserContent: function(username) {
            document.querySelectorAll('.tweet-card').forEach(tweet => {
                const usernameElement = tweet.querySelector('.text-gray-500.truncate.text-\\[14px\\]');
                if (usernameElement && usernameElement.textContent.includes(`@${username}`)) {
                    tweet.style.display = 'none';
                }
            });
            
            document.querySelectorAll('.story-item').forEach(storyItem => {
                const usernameElement = storyItem.querySelector('.story-username');
                if (usernameElement && usernameElement.textContent.includes(username)) {
                    storyItem.style.display = 'none';
                }
            });
            
            document.querySelectorAll('.search-result, [class*="search"] .flex.items-center.gap-3').forEach(result => {
                const usernameElement = result.querySelector('.text-gray-500.text-xs, .text-gray-500.text-\\[12px\\]');
                if (usernameElement && usernameElement.textContent.includes(`@${username}`)) {
                    result.style.display = 'none';
                }
            });
        },
        
        showUnblockedUserContent: function(username) {
            document.querySelectorAll('.tweet-card, .story-item, .search-result, [class*="search"] .flex.items-center.gap-3').forEach(el => {
                if (el.style.display === 'none') {
                    const usernameElement = el.querySelector('.text-gray-500.truncate.text-\\[14px\\], .story-username, .text-gray-500.text-xs, .text-gray-500.text-\\[12px\\]');
                    if (usernameElement && usernameElement.textContent.includes(username)) {
                        el.style.display = '';
                    }
                }
            });
        },
        
        init: async function() {
            if (currentUser?.username) {
                const blockedUsers = await this.fetchBlockedUsers(true);
                
                blockedUsers.forEach(username => {
                    this.hideBlockedUserContent(username);
                });
                
                const profileView = document.getElementById('user-profile-view');
                if (profileView && !profileView.classList.contains('hidden-content')) {
                    const profileUsername = document.getElementById('profile-view-handle')?.innerText.replace('@', '');
                    if (profileUsername) {
                        const status = await this.checkBlockStatus(profileUsername);
                        if (status.blockedByMe) {
                            this.showBlockedByMeProfile(profileUsername);
                        } else if (status.blockedMe) {
                            this.showBlockedMeProfile(profileUsername);
                        }
                    }
                }
                
                console.log(` BlockSystem initialized: ${blockedUsers.length} blocked users`);
            }
        }
    };

    // ============================================================================
    //  NEW:    (  v2.6.3)
    // ============================================================================
    
    window.app = window.app || {};
    
    // =====       =====
    window.app.fetchConversationsV2 = async function() {
        const container = document.getElementById('conversations-list');
        container.innerHTML = '<div class="text-center text-gray-500 mt-5 pt-10"><i class="fas fa-spinner fa-spin"></i></div>';
        
        try {
            const response = await fetch(`${SERVER_URL}/api/conversations/${currentUser.username}`);
            
            if (!response.ok) {
                throw new Error("   ");
            }
            
            const data = await response.json();
            const conversations = data.conversations || [];
            
            container.innerHTML = '';
            
            if (conversations.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 mt-10 text-sm">  .<br>     +  .</div>';
                return;
            }
            
            conversations.forEach(conv => {
                const div = document.createElement('div');
                div.className = 'dm-item';
                div.setAttribute('data-conversation-id', conv.id);
                div.onclick = () => window.app.startConversationV2(conv.otherUser.username, conv.id);
                
                const lastMessage = conv.lastMessage || {};
                const lastMessageText = lastMessage.content || '...';
                const lastMessageTime = lastMessage.createdAt ? formatTime(new Date(lastMessage.createdAt)) : formatTime(new Date(conv.lastMessageTime));
                
                const unreadCount = conv.unreadCount || 0;
                const badge = unreadCount > 0 ? 
                    `<div class="unread-badge">${unreadCount > 9 ? '9+' : unreadCount}</div>` : '';
                
                div.innerHTML = `
                    ${badge}
                    <img src="${conv.otherUser.avatar || 'https://via.placeholder.com/150'}" class="dm-avatar" loading="lazy">
                    <div class="dm-content">
                        <div class="flex items-center gap-1">
                            <span class="font-bold text-white text-sm">${sanitizeHTML(conv.otherUser.displayName || conv.otherUser.username)}</span>
                            ${conv.otherUser.verification ? 
                                `<img src="https://upload.wikimedia.org/wikipedia/commons/${conv.otherUser.verification === 'gold' ? '8/81/Twitter_Verified_Badge_Gold.svg' : 'e/e4/Twitter_Verified_Badge.svg'}" class="verification-badge ${conv.otherUser.verification}" alt="Verified" loading="lazy">` 
                                : ''}
                            <span class="text-gray-500 text-xs dir-ltr">@${conv.otherUser.username}</span>
                            <span class="dm-time">${lastMessageTime}</span>
                        </div>
                        <div class="text-gray-500 text-sm truncate text-right dir-rtl">
                            ${lastMessage.isFromMe ? ': ' : ''}
                            ${sanitizeHTML(lastMessageText)}
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            //     
            window.app.getTotalUnreadCount();
            
        } catch (error) {
            console.error(" Error fetching conversations:", error);
            container.innerHTML = '<div class="text-center text-gray-500 mt-10 text-sm">   </div>';
            
            // fallback   
            window.app.fetchConversations();
        }
    };

    // =====    API  =====
    window.app.startConversationV2 = async function(targetUsername, conversationId = null) {
        try {
            let targetId = conversationId;
            
            if (!targetId) {
                const res = await fetch(`${SERVER_URL}/api/dm/conversation`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username1: currentUser.username, 
                        username2: targetUsername 
                    })
                });
                
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || "   ");
                }
                
                const data = await res.json();
                targetId = data.conversation.id;
            }
            
            currentChatContext = 'dm';
            currentChatId = targetId;
            
            const ui = document.getElementById('chat-interface');
            ui.classList.remove('hidden');
            setTimeout(() => ui.classList.remove('translate-x-full'), 10);
            
            //    
            const otherUserRes = await fetch(`${SERVER_URL}/api/users/profile/${targetUsername}?me=${currentUser.username}`);
            const otherUser = await otherUserRes.json();
            
            document.getElementById('chat-header-title').innerText = otherUser.display_name || targetUsername;
            document.getElementById('chat-header-avatar').src = otherUser.avatar_url || 'https://via.placeholder.com/150';
            document.getElementById('chat-header-subtitle').innerText = i18next.t('private_message');

            //    API 
            await window.app.loadMessages(targetId);
            
            if (socket) {
                socket.emit('join_conversation', targetId);
                
                setTimeout(() => {
                    window.app.markMessagesAsSeen(targetId);
                }, 1000);
            }

        } catch (error) { 
            console.error(" Error starting conversation:", error);
            alert("   : " + error.message); 
        }
    };

// ============================================================================
//    API  -      
// ============================================================================
window.app.startConversationV2 = async function(targetUsername, conversationId = null) {
    try {
        let targetId = conversationId;
        
        if (!targetId) {
            const res = await fetch(`${SERVER_URL}/api/dm/conversation`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username1: currentUser.username, 
                    username2: targetUsername 
                })
            });
            
            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.error || "   ");
            }
            
            const data = await res.json();
            targetId = data.conversation.id;
        }
        
        // ==========    Socket.io ==========
        // 1.          
        if (currentChatId && socket) {
            console.log(` Leaving previous conversation: ${currentChatId}`);
            socket.emit('leave_conversation', currentChatId);
            
            //        
            await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        // 2.   
        currentChatContext = 'dm';
        currentChatId = targetId;
        
        // 3.    
        const ui = document.getElementById('chat-interface');
        ui.classList.remove('hidden');
        setTimeout(() => ui.classList.remove('translate-x-full'), 10);
        
        // 4.    
        const otherUserRes = await fetch(`${SERVER_URL}/api/users/profile/${targetUsername}?me=${currentUser.username}`);
        const otherUser = await otherUserRes.json();
        
        document.getElementById('chat-header-title').innerText = otherUser.display_name || targetUsername;
        document.getElementById('chat-header-avatar').src = otherUser.avatar_url || 'https://via.placeholder.com/150';
        document.getElementById('chat-header-subtitle').innerText = i18next.t('private_message');

        // 5.   
        await window.app.loadMessages(targetId);
        
        // 6.      Socket.io
        if (socket) {
            console.log(` Joining new conversation: ${targetId}`);
            socket.emit('join_conversation', targetId);
            
            // 7.           
            setTimeout(() => {
                if (currentChatId === targetId) { //        
                    window.app.markMessagesAsSeen(targetId);
                }
            }, 1000);
        }

    } catch (error) { 
        console.error(" Error starting conversation:", error);
        alert("   : " + error.message); 
    }
};

// ============================================================================
//    API  -    
// ============================================================================
window.app.loadMessages = async function(conversationId) {
    //         
    if (currentChatId !== conversationId) {
        console.log(" Conversation changed, aborting load");
        return;
    }
    
    const messagesBox = document.getElementById('chat-messages');
    messagesBox.innerHTML = '<div class="text-center text-gray-600 text-xs py-4">  ...</div>';
    
    try {
        const response = await fetch(
            `${SERVER_URL}/api/messages/${conversationId}?username=${currentUser.username}&page=0&limit=50`
        );
        
        if (!response.ok) throw new Error("   ");
        
        const data = await response.json();
        
        //   -           
        if (currentChatId !== conversationId) {
            console.log(" Conversation changed during load, aborting");
            return;
        }
        
        messagesBox.innerHTML = '';
        
        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
                //         
                if (msg.conversationId === conversationId || !msg.conversationId) {
                    window.app.renderMessageV2(msg, msg.sender_id === currentUser.id);
                }
            });
            
            setTimeout(() => {
                if (currentChatId === conversationId) {
                    messagesBox.scrollTop = messagesBox.scrollHeight;
                }
            }, 100);
            
            if (data.totalUnread > 0 && currentChatId === conversationId) {
                window.app.markMessagesAsSeen(conversationId);
            }
        } else {
            messagesBox.innerHTML = '<div class="text-center text-gray-600 text-xs py-4"> .  !</div>';
        }
        
    } catch (error) {
        console.error(" Error loading messages:", error);
        if (currentChatId === conversationId) {
            messagesBox.innerHTML = '<div class="text-center text-red-500 text-xs py-4">   </div>';
        }
    }
};

// ============================================================================
//   -  
// ============================================================================
window.app.closeChatInterface = function() {
    const ui = document.getElementById('chat-interface');
    ui.classList.add('translate-x-full');
    
    //      Socket.io
    if (currentChatId && socket) {
        console.log(` Leaving conversation on close: ${currentChatId}`);
        socket.emit('leave_conversation', currentChatId);
    }
    
    setTimeout(() => {
        ui.classList.add('hidden');
        //         
        currentChatContext = null;
        currentChatId = null;
    }, 300);
};

    // =====        =====
    window.app.renderMessageV2 = function(msg, isMe) {
        const box = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = `flex gap-2 mb-2 message-container ${isMe ? 'flex-row-reverse' : ''}`;
        div.setAttribute('data-message-id', msg.id);
        
        const avatar = msg.sender_avatar || msg.avatar || 'https://via.placeholder.com/40';
        
        let statusIcon = '';
        if (isMe) {
            if (msg.status === 'seen') {
                statusIcon = '<span class="text-x-blue text-xs mr-1 flex items-center gap-0.5"><i class="fas fa-check-circle"></i><i class="fas fa-check-circle -ml-1"></i></span>';
            } else if (msg.status === 'delivered' || msg.status === 'sent') {
                statusIcon = '<span class="text-gray-500 text-xs mr-1 flex items-center gap-0.5"><i class="fas fa-check-circle"></i><i class="fas fa-check-circle -ml-1"></i></span>';
            }
        }
        
        let verificationBadge = '';
        if (msg.sender_verification === 'gold' || msg.verification === 'gold') {
            verificationBadge = '<img src="https://upload.wikimedia.org/wikipedia/commons/8/81/Twitter_Verified_Badge_Gold.svg" class="verification-badge gold" style="width: 14px; height: 14px; margin-right: 2px;" loading="lazy">';
        } else if (msg.sender_verification === 'blue' || msg.verification === 'blue') {
            verificationBadge = '<img src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg" class="verification-badge blue" style="width: 14px; height: 14px; margin-right: 2px;" loading="lazy">';
        }
        
        div.innerHTML = `
            ${isMe ? `<div class="message-options"><button class="delete-msg-btn" onclick="window.app.deleteMessage('${msg.id}')"><i class="fas fa-trash"></i></button></div>` : ''}
            <img src="${avatar}" class="w-8 h-8 rounded-full border border-white/10 object-cover bg-black" loading="lazy">
            <div class="px-3 py-2 rounded-2xl max-w-[75%] text-sm ${isMe ? 'bg-[#1d9bf0] text-white rounded-bl-sm' : 'bg-[#212121] text-white rounded-br-sm'}">
                ${!isMe ? `<div class="text-[11px] text-[#e58e38] font-bold mb-0.5 flex items-center">${sanitizeHTML(msg.sender_display_name || msg.sender_username || 'User')} ${verificationBadge}</div>` : ''}
                ${sanitizeHTML(msg.content)}
                <div class="flex items-center justify-end gap-1 mt-1">
                    <span class="text-[10px] text-gray-400">${formatTime(new Date(msg.created_at))}</span>
                    ${statusIcon}
                </div>
            </div>
        `;
        box.appendChild(div);
    };

    // =====   :      =====
    // =====   :   =====
window.app.sendMessageV2 = async function() {
    const inp = document.getElementById('chat-input');
    const txt = inp.value.trim();
    
    if (!txt || !currentChatId || currentChatContext !== 'dm') {
        window.app.sendChatMessage();
        return;
    }
    
    inp.value = '';
    
    try {
        const response = await fetch(`${SERVER_URL}/api/messages/send`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                conversationId: currentChatId,
                senderUsername: currentUser.username,
                content: sanitizeHTML(txt)
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || "   ");
        }
        
        const data = await response.json();
        
        //      UI (   )
        const tempMsg = {
            id: 'temp_' + Date.now(),
            content: txt,
            sender_id: currentUser.id,
            sender_username: currentUser.username,
            sender_display_name: currentUser.display_name,
            sender_avatar: currentUser.avatar_url,
            sender_verification: currentUser.verification,
            status: 'sent',
            created_at: new Date().toISOString()
        };
        window.app.renderMessageV2(tempMsg, true);
        
        const messagesBox = document.getElementById('chat-messages');
        messagesBox.scrollTop = messagesBox.scrollHeight;
        
        //        
        setTimeout(async () => {
            try {
                //      
                const refreshRes = await fetch(
                    `${SERVER_URL}/api/messages/${currentChatId}?username=${currentUser.username}&page=0&limit=50`
                );
                if (refreshRes.ok) {
                    const refreshData = await refreshRes.json();
                    if (refreshData.messages && refreshData.messages.length > 0) {
                        const lastMsg = refreshData.messages[refreshData.messages.length - 1];
                        if (lastMsg.content === txt) {
                            //   
                            const tempElement = document.querySelector(`[data-message-id="${tempMsg.id}"]`);
                            if (tempElement) tempElement.remove();
                            //   
                            window.app.renderMessageV2(lastMsg, true);
                        }
                    }
                }
            } catch (e) {
                console.log("    :", e);
            }
        }, 1000);
        
    } catch (error) {
        console.error(" Send message error:", error);
        showNotificationToast('    ');
        inp.value = txt;
    }
};

    // =====       =====
    window.app.markMessagesAsSeen = async function(conversationId, lastMessageId = null) {
        if (!conversationId || !currentUser?.username) return;
        
        try {
            const response = await fetch(`${SERVER_URL}/api/messages/mark-seen`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    conversationId: conversationId,
                    username: currentUser.username,
                    lastSeenMessageId: lastMessageId
                })
            });
            
            if (response.ok) {
                document.querySelectorAll(`.message-container[data-message-id]`).forEach(el => {
                    const msgId = el.getAttribute('data-message-id');
                    if (msgId && !msgId.startsWith('temp_')) {
                        const statusEl = el.querySelector('.text-xs.flex.items-center.gap-1');
                        if (statusEl && statusEl.innerHTML.includes('fa-check-circle')) {
                            statusEl.innerHTML = '<span class="text-x-blue text-xs mr-1 flex items-center gap-0.5"><i class="fas fa-check-circle"></i><i class="fas fa-check-circle -ml-1"></i></span>';
                        }
                    }
                });
                
                const convElement = document.querySelector(`.dm-item[data-conversation-id="${conversationId}"]`);
                if (convElement) {
                    const badge = convElement.querySelector('.unread-badge');
                    if (badge) badge.remove();
                }
                
                window.app.getTotalUnreadCount();
            }
        } catch (error) {
            console.error(" Error marking messages as seen:", error);
        }
    };

    // =====      =====
    window.app.getTotalUnreadCount = async function() {
        try {
            const response = await fetch(`${SERVER_URL}/api/messages/unread-count/${currentUser.username}`);
            
            if (response.ok) {
                const data = await response.json();
                const totalUnread = data.totalUnread || 0;
                
                const dmBadge = document.getElementById('dm-badge');
                
                if (totalUnread > 0) {
                    dmBadge.classList.add('active');
                    dmBadge.textContent = totalUnread > 9 ? '9+' : totalUnread;
                    dmBadge.style.display = 'flex';
                    localStorage.setItem(LS_KEYS.DM_COUNT, totalUnread);
                } else {
                    dmBadge.classList.remove('active');
                    dmBadge.style.display = 'none';
                    localStorage.setItem(LS_KEYS.DM_COUNT, 0);
                }
            }
        } catch (error) {
            console.error(" Error getting unread count:", error);
        }
    };

    // ============================================================================
    //  NEW: GIF Picker Integration
    // ============================================================================
    
    window.app.gifPickerState = {
        currentQuery: 'football highlights',
        isLoading: false,
        currentPage: 0,
        hasMore: true,
        gifs: [],
        selectedGif: null,
        searchDebounceTimer: null,
        abortController: null,
        gifObserver: null
    };

    window.app.GIPHY_API_KEY = '3xL2RggW8gk1UmpNFXhmmAXMHp1JI5tP';
    window.app.GIPHY_BASE_URL = 'https://api.giphy.com/v1/gifs';

    window.app.openGifPicker = function() {
        const modal = document.getElementById('gif-picker-modal');
        modal.classList.add('active');
        
        window.app.gifPickerState = {
            currentQuery: 'football highlights',
            isLoading: false,
            currentPage: 0,
            hasMore: true,
            gifs: [],
            selectedGif: null,
            searchDebounceTimer: null,
            abortController: null,
            gifObserver: null
        };
        
        document.querySelectorAll('.gif-chip').forEach(chip => {
            chip.classList.remove('active');
            if (chip.getAttribute('data-query') === 'football highlights') {
                chip.classList.add('active');
            }
        });
        
        const searchInput = document.getElementById('gif-search-input');
        searchInput.value = '';
        document.getElementById('gif-clear-search').classList.add('hidden');
        
        window.app.loadGifs('football highlights', true);
    };

    window.app.closeGifPicker = function() {
        const modal = document.getElementById('gif-picker-modal');
        modal.classList.remove('active');
        
        if (window.app.gifPickerState.abortController) {
            window.app.gifPickerState.abortController.abort();
        }
        
        if (window.app.gifPickerState.searchDebounceTimer) {
            clearTimeout(window.app.gifPickerState.searchDebounceTimer);
        }
        
        document.getElementById('gif-grid').innerHTML = '';
        document.getElementById('gif-no-results').classList.add('hidden');
        document.getElementById('gif-loading').classList.remove('hidden');
    };

    window.app.clearGifSearch = function() {
        const searchInput = document.getElementById('gif-search-input');
        searchInput.value = '';
        document.getElementById('gif-clear-search').classList.add('hidden');
        
        document.querySelectorAll('.gif-chip').forEach(chip => {
            chip.classList.remove('active');
            if (chip.getAttribute('data-query') === 'football highlights') {
                chip.classList.add('active');
            }
        });
        
        window.app.loadGifs('football highlights', true);
    };

    window.app.loadGifs = async function(query, reset = true) {
        if (!query) return;
        
        if (reset) {
            window.app.gifPickerState.currentPage = 0;
            window.app.gifPickerState.hasMore = true;
            window.app.gifPickerState.gifs = [];
            document.getElementById('gif-grid').innerHTML = '';
            document.getElementById('gif-no-results').classList.add('hidden');
        }
        
        if (window.app.gifPickerState.isLoading || !window.app.gifPickerState.hasMore) return;
        
        window.app.gifPickerState.isLoading = true;
        document.getElementById('gif-loading').classList.remove('hidden');
        
        if (window.app.gifPickerState.abortController) {
            window.app.gifPickerState.abortController.abort();
        }
        
        window.app.gifPickerState.abortController = new AbortController();
        
        try {
            let sportsQuery = query;
            
            if (!sportsQuery.includes('football') && !sportsQuery.includes('soccer') && !sportsQuery.includes('sports')) {
                sportsQuery = `${query} football sports`;
            }
            
            const params = new URLSearchParams({
                api_key: window.app.GIPHY_API_KEY,
                q: sportsQuery,
                limit: 20,
                offset: window.app.gifPickerState.currentPage * 20,
                rating: 'g',
                lang: 'en'
            });
            
            const response = await fetch(`${window.app.GIPHY_BASE_URL}/search?${params}`, {
                signal: window.app.gifPickerState.abortController.signal
            });
            
            if (!response.ok) throw new Error('GIPHY API error');
            
            const data = await response.json();
            
            document.getElementById('gif-loading').classList.add('hidden');
            
            if (data.data && data.data.length > 0) {
                window.app.gifPickerState.gifs = reset ? data.data : [...window.app.gifPickerState.gifs, ...data.data];
                window.app.gifPickerState.hasMore = data.data.length === 20;
                
                window.app.renderGifs(data.data, reset);
                
            } else {
                if (reset) {
                    document.getElementById('gif-grid').innerHTML = '';
                    document.getElementById('gif-no-results').classList.remove('hidden');
                }
                window.app.gifPickerState.hasMore = false;
            }
            
        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error(' GIPHY load error:', error);
                document.getElementById('gif-loading').classList.add('hidden');
                
                if (reset) {
                    document.getElementById('gif-grid').innerHTML = `
                        <div class="col-span-2 text-center text-red-500 py-8">
                            <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                            <p>   </p>
                            <button onclick="window.app.loadGifs('${query}', true)" 
                                    class="mt-3 px-4 py-2 bg-x-blue rounded-full text-sm">
                                 
                            </button>
                        </div>
                    `;
                }
            }
        } finally {
            window.app.gifPickerState.isLoading = false;
        }
    };

    window.app.renderGifs = function(gifs, reset) {
        const grid = document.getElementById('gif-grid');
        
        if (reset) {
            grid.innerHTML = '';
        }
        
        gifs.forEach(gif => {
            const item = document.createElement('div');
            item.className = 'gif-grid-item';
            
            const previewUrl = gif.images.fixed_width_small?.url || gif.images.fixed_width?.url;
            const mp4Url = gif.images.original?.mp4 || gif.images.downsized_medium?.mp4;
            
            if (mp4Url) {
                item.innerHTML = `
                    <video src="${mp4Url}" autoplay loop muted playsinline></video>
                    <div class="gif-badge">GIF</div>
                    <div class="gif-overlay">
                        <span class="text-white text-xs truncate block">${gif.title || ' '}</span>
                    </div>
                `;
            } else {
                item.innerHTML = `
                    <img src="${previewUrl}" alt="${gif.title || 'GIF'}" loading="lazy">
                    <div class="gif-badge">GIF</div>
                    <div class="gif-overlay">
                        <span class="text-white text-xs truncate block">${gif.title || ' '}</span>
                    </div>
                `;
            }
            
            item.onclick = () => {
                window.app.selectGif(gif);
            };
            
            grid.appendChild(item);
        });
        
        window.app.setupInfiniteScrollGif();
    };

    window.app.setupInfiniteScrollGif = function() {
        const grid = document.getElementById('gif-grid');
        if (!grid) return;
        
        if (window.app.gifPickerState.gifObserver) {
            window.app.gifPickerState.gifObserver.disconnect();
        }
        
        window.app.gifPickerState.gifObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && 
                    !window.app.gifPickerState.isLoading && 
                    window.app.gifPickerState.hasMore) {
                    
                    window.app.gifPickerState.currentPage++;
                    window.app.loadGifs(window.app.gifPickerState.currentQuery, false);
                }
            });
        }, { threshold: 0.1, rootMargin: '100px' });
        
        const lastItem = grid.lastElementChild;
        if (lastItem) {
            window.app.gifPickerState.gifObserver.observe(lastItem);
        }
    };

    window.app.selectGif = function(gif) {
        window.app.closeGifPicker();
        
        window.app.gifPickerState.selectedGif = gif;
        
        const preview = document.getElementById('composer-gif-preview');
        const video = document.getElementById('composer-gif-video');
        
        const mp4Url = gif.images.original?.mp4 || gif.images.downsized_medium?.mp4;
        const gifUrl = gif.images.original?.url || gif.images.downsized?.url;
        
        if (mp4Url) {
            video.src = mp4Url;
            video.load();
            video.play().catch(e => console.log('Autoplay prevented:', e));
        } else {
            preview.innerHTML = `
                <img src="${gifUrl}" class="w-full object-contain bg-black" style="max-height: 200px;" loading="lazy">
                <button onclick="window.app.removeComposerGif()" class="absolute top-2 right-2 w-8 h-8 bg-black/70 rounded-full flex items-center justify-center text-white hover:bg-black/90 transition">
                    <i class="fas fa-times"></i>
                </button>
                <div class="absolute bottom-2 left-2 bg-black/50 text-white text-xs px-2 py-1 rounded-full flex items-center gap-1">
                    <i class="fas fa-film"></i> GIF
                </div>
            `;
        }
        
        preview.classList.remove('hidden');
        
        document.getElementById('composer-media-preview').classList.add('hidden');
        currentTweetMedia = null;
        
        window.currentSelectedGif = {
            mp4: mp4Url,
            gif: gifUrl,
            title: gif.title,
            id: gif.id
        };
        
        showNotificationToast('     ');
    };

    window.app.removeComposerGif = function() {
        document.getElementById('composer-gif-preview').classList.add('hidden');
        const video = document.getElementById('composer-gif-video');
        video.pause();
        video.src = '';
        window.currentSelectedGif = null;
    };

    window.app.searchGifs = function(query) {
        if (window.app.gifPickerState.searchDebounceTimer) {
            clearTimeout(window.app.gifPickerState.searchDebounceTimer);
        }
        
        document.getElementById('gif-clear-search').classList.toggle('hidden', !query);
        
        if (!query || query.trim() === '') {
            document.querySelectorAll('.gif-chip').forEach(chip => {
                chip.classList.remove('active');
                if (chip.getAttribute('data-query') === 'football highlights') {
                    chip.classList.add('active');
                }
            });
            
            window.app.loadGifs('football highlights', true);
            return;
        }
        
        document.querySelectorAll('.gif-chip').forEach(chip => {
            chip.classList.remove('active');
        });
        
        window.app.gifPickerState.searchDebounceTimer = setTimeout(() => {
            window.app.gifPickerState.currentQuery = query;
            window.app.loadGifs(query, true);
        }, 500);
    };

    window.app.onGifChipClick = function(chip) {
        const query = chip.getAttribute('data-query');
        
        document.querySelectorAll('.gif-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        
        document.getElementById('gif-search-input').value = '';
        document.getElementById('gif-clear-search').classList.add('hidden');
        
        window.app.gifPickerState.currentQuery = query;
        window.app.loadGifs(query, true);
    };

    // ============================================================================
    //    app (  )
    // ============================================================================
    
    window.app = {
        ...window.app,
        
        // Auth & Initial
        goToLogin: () => {
            document.getElementById('welcomePage').classList.remove('active');
            document.getElementById('loginPage').classList.add('active');
            setTimeout(() => document.getElementById('emailInput').focus(), 100);
        },
        
        sendOTP: async () => {
            const btn = document.getElementById('loginFab');
            const email = document.getElementById('emailInput').value.trim();
            currentEmail = email;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/send-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || "   ");
                }
                
                document.getElementById('loginPage').classList.remove('active');
                document.getElementById('otpPage').classList.add('active');
                document.getElementById('otpText').innerHTML = `  <strong>${email}</strong>  .`;
                document.getElementById('otp1').focus();
                
            } catch (err) {
                alert(": " + err.message);
            } finally {
                btn.innerHTML = '  ';
            }
        },
        
        verifyOTP: async () => {
            const btn = document.getElementById('verifyBtn');
            if (btn.disabled) return;
            
            btn.disabled = true;
            btn.innerText = "...";
            
            const token = Array.from(document.querySelectorAll('.otp-box')).map(i => i.value).join('');
            if(token.length !== 6) {
                document.getElementById('otpError').innerText = "    ";
                btn.disabled = false;
                btn.innerText = "  ";
                return;
            }
            
            try {
                const verifyRes = await fetch(`${API_BASE_URL}/api/auth/verify-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: currentEmail, 
                        token: token 
                    })
                });
                
                const verifyData = await verifyRes.json();
                
                if (!verifyRes.ok) {
                    throw new Error(verifyData.error || "  ");
                }
                
                const checkRes = await fetch(`${API_BASE_URL}/api/auth/check-account`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentEmail })
                });
                
                const accountData = await checkRes.json();
                
                if (accountData.exists && accountData.has_profile && accountData.user) {
                    currentUser = accountData.user;
                    currentUser.email = currentEmail;
                    localStorage.setItem('x_user_v2', JSON.stringify(currentUser));
                    initAppUI(currentUser);
                    return;
                }
                
                document.getElementById('otpPage').classList.remove('active');
                document.getElementById('profilePage').classList.add('active');
                
            } catch(err) {
                document.getElementById('otpError').innerText = err.message;
                btn.disabled = false;
                btn.innerText = "  ";
            }
        },
        
        checkUsername: async (username) => {
            try {
                const res = await fetch(`${SERVER_URL}/api/users/search?q=${username}`);
                if (!res.ok) throw new Error("Server Error");
                const users = await res.json();
                const exists = users.some(u => u.username === username);
                return !exists;
            } catch (e) { 
                console.error("    :", e);
                return false; 
            }
        },
        
        submitProfile: async () => {
            const fab = document.getElementById('continueFab');
            if(!fab.classList.contains('enabled')) return;

            const originalIcon = fab.innerHTML;
            fab.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            fab.style.pointerEvents = 'none';
            
            const username = document.getElementById('usernameInput').value.trim();
            const displayName = document.getElementById('displayName').value.trim();

            if (!/^[a-zA-Z0-9_]{3,30}$/.test(username)) {
                document.getElementById('usernameError').innerText = '             _ ';
                fab.innerHTML = originalIcon;
                fab.style.pointerEvents = 'auto';
                return;
            }

            try {
                let finalAvatarUrl = 'https://via.placeholder.com/150';
                if (capturedImageData) {
                    const blob = await fetch(capturedImageData).then(r => r.blob());
                    const file = new File([blob], 'avatar.jpg', { type: 'image/jpeg' });
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const uploadRes = await fetch(`${API_BASE_URL}/api/upload/image`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (uploadRes.ok) {
                        const uploadData = await uploadRes.json();
                        finalAvatarUrl = uploadData.url;
                    } else {
                        throw new Error('   ');
                    }
                }

                const payload = {
                    email: currentEmail,
                    username: username,
                    display_name: displayName || username,
                    avatar_url: finalAvatarUrl 
                };

                const res = await fetch(`${API_BASE_URL}/api/auth/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || '    ');
                }

                const data = await res.json();
                if(data.success || data.user) {
                    currentUser = data.user || payload;
                    if(data.user) {
                        currentUser.displayName = displayName || username;
                        if(currentUser.email === "Shahriyarjadidi@gmail.com") {
                            currentUser.verification = 'gold';
                            currentUser.is_admin = true;
                        }
                    }
                    localStorage.setItem('x_user_v2', JSON.stringify(currentUser));
                    initAppUI(currentUser);
                } else {
                    throw new Error(data.error || '    ');
                }
            } catch (error) {
                document.getElementById('usernameError').innerText = error.message || '   ';
                fab.innerHTML = originalIcon;
                fab.style.pointerEvents = 'auto';
            }
        },

        // Camera & Images
        openImageChooser: () => document.getElementById('chooserModal').style.display='flex',
        closeChooser: () => document.getElementById('chooserModal').style.display='none',
        openFilePicker: () => { window.app.closeChooser(); document.getElementById('fileInput').click(); },
        
        startCamera: async (context = 'profile') => {
            if (context === 'story') {
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "user" },
                        audio: false
                    });
                    
                    const cameraView = document.createElement('div');
                    cameraView.id = 'story-camera-view';
                    cameraView.className = 'fixed inset-0 z-[10003] bg-black flex flex-col';
                    
                    cameraView.innerHTML = `
                        <video id="story-camera-video" autoplay playsinline class="flex-1 object-cover w-full" style="transform: scaleX(-1);"></video>
                        <div class="absolute bottom-10 left-0 right-0 flex justify-center gap-8">
                            <button onclick="window.app.stopStoryCamera()" class="w-16 h-16 rounded-full bg-gray-800 text-white flex items-center justify-center">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                            <button onclick="window.app.captureStoryPhoto()" class="w-20 h-20 rounded-full bg-white border-4 border-gray-800 flex items-center justify-center">
                                <div class="w-16 h-16 rounded-full bg-white"></div>
                            </button>
                            <button onclick="window.app.switchStoryCamera()" class="w-16 h-16 rounded-full bg-gray-800 text-white flex items-center justify-center">
                                <i class="fas fa-sync-alt text-2xl"></i>
                            </button>
                        </div>
                    `;
                    
                    document.body.appendChild(cameraView);
                    const video = document.getElementById('story-camera-video');
                    video.srcObject = mediaStream;
                } catch (err) {
                    alert('   ');
                }
            } else {
                window.app.closeChooser();
                try {
                    mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                    document.getElementById('cameraVideo').srcObject = mediaStream;
                    document.getElementById('cameraView').style.display = 'flex';
                } catch (err) {
                    alert('   ');
                }
            }
        },
        
        capturePhoto: () => {
            const vid = document.getElementById('cameraVideo');
            const cvs = document.createElement('canvas');
            const MAX_SIZE = 500;
            let width = vid.videoWidth;
            let height = vid.videoHeight;
            if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } 
            else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
            
            cvs.width = width; cvs.height = height;
            const ctx = cvs.getContext('2d');
            ctx.translate(cvs.width, 0); ctx.scale(-1, 1);
            ctx.drawImage(vid, 0, 0, width, height);
            
            window.app.setProfileImage(cvs.toDataURL('image/jpeg', 0.6));
            window.app.stopCamera();
        },
        
        captureStoryPhoto: () => {
            const video = document.getElementById('story-camera-video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            window.app.setStoryMedia('image', imageData);
            window.app.stopStoryCamera();
        },
        
        stopCamera: () => {
            document.getElementById('cameraView').style.display='none'; 
            if(mediaStream) {
                mediaStream.getTracks().forEach(track => {
                    track.stop();
                    track.enabled = false;
                    mediaStream.removeTrack(track);
                });
                mediaStream = null;
            }
            
            const video = document.getElementById('cameraVideo');
            if (video && video.srcObject) {
                video.srcObject = null;
            }
        },
        
        stopStoryCamera: () => {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => {
                    track.stop();
                    track.enabled = false;
                    if (mediaStream) {
                        mediaStream.removeTrack(track);
                    }
                });
                mediaStream = null;
            }
            
            const cameraView = document.getElementById('story-camera-view');
            if (cameraView) {
                const video = cameraView.querySelector('video');
                if (video && video.srcObject) {
                    video.srcObject = null;
                }
                cameraView.remove();
            }
        },
        
        switchStoryCamera: async () => {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                if (videoDevices.length > 1) {
                    const currentFacingMode = mediaStream ? 'user' : 'environment';
                    const newFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
                    
                    mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: newFacingMode }
                    });
                    
                    const video = document.getElementById('story-camera-video');
                    video.srcObject = mediaStream;
                }
            } catch (err) {
                console.error('   :', err);
            }
        },
        
        setProfileImage: (dataUrl) => {
            capturedImageData = dataUrl;
            document.getElementById('avatarPreview').src = dataUrl;
            document.getElementById('avatarPreview').style.display = 'block';
            document.getElementById('avatarBtn').style.opacity = '0';
            const editPreview = document.getElementById('edit-avatar-preview');
            if(editPreview) editPreview.src = dataUrl;
            validateProfileForm();
        },

        // Story System
        loadStories: async () => {
            try {
                const res = await fetch(`${SERVER_URL}/api/stories/following/${currentUser.username}`);
                if (res.ok) {
                    const storiesData = await res.json();
                    currentStories = storiesData;
                    window.app.renderStories(storiesData);
                    window.app.updateHeaderAvatar();
                    window.app.updateDrawerAvatar();
                    window.app.updateProfileAvatar();
                }
            } catch (e) {
                console.error("   :", e);
            }
        },

        renderStories: (storiesData) => {
            const container = document.getElementById('stories-section');
            if (!container) return;
            
            container.innerHTML = '';
            
            const userHasStory = storiesData.some(s => 
                s.username === currentUser.username && s.stories && s.stories.length > 0
            );
            
            const userStoryItem = document.createElement('div');
            userStoryItem.className = 'story-item';
            userStoryItem.onclick = (e) => {
                e.stopPropagation();
                window.app.handleUserAvatarClick(e.target);
            };
            
            userStoryItem.innerHTML = `
                <div class="story-avatar ${!userHasStory ? 'no-story' : ''}">
                    <img src="${currentUser.avatar_url || 'https://via.placeholder.com/150'}" 
                         alt="${currentUser.display_name || currentUser.username}"
                         style="width: 56px; height: 56px; object-fit: cover;" loading="lazy">
                    ${!userHasStory ? '<div class="story-add-btn"><i class="fas fa-plus"></i></div>' : ''}
                </div>
                <div class="story-username" data-i18n="your_story"> </div>
            `;
            container.appendChild(userStoryItem);
            
            storiesData.forEach(userStory => {
                if (userStory.username === currentUser.username) return;
                
                if (userStory.stories && userStory.stories.length > 0) {
                    const storyItem = document.createElement('div');
                    storyItem.className = 'story-item';
                    storyItem.onclick = (e) => {
                        e.stopPropagation();
                        window.app.openStoryViewer(userStory.username, 0);
                    };
                    
                    storyItem.innerHTML = `
                        <div class="story-avatar">
                            <img src="${userStory.avatar_url || 'https://via.placeholder.com/150'}" 
                                 alt="${userStory.display_name || userStory.username}"
                                 style="width: 56px; height: 56px; object-fit: cover;" loading="lazy">
                        </div>
                        <div class="story-username">${userStory.display_name || userStory.username}</div>
                    `;
                    container.appendChild(storyItem);
                }
            });
        },

        updateHeaderAvatar: () => {
            const container = document.getElementById('header-avatar-container');
            if (!container) return;
            
            const userHasStory = currentStories && currentStories.some(s => 
                s.username === currentUser.username && s.stories && s.stories.length > 0
            );
            
            container.innerHTML = '';
            
            if (userHasStory) {
                container.innerHTML = `
                    <div class="header-avatar-with-story">
                        <div class="story-indicator">
                            <img src="${currentUser.avatar_url || 'https://via.placeholder.com/150'}" 
                                 alt="${currentUser.display_name || currentUser.username}"
                                 style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <img src="${currentUser.avatar_url || 'https://via.placeholder.com/150'}" 
                         class="w-8 h-8 rounded-full object-cover" loading="lazy">
                `;
            }
        },

        updateDrawerAvatar: () => {
            const container = document.getElementById('drawer-avatar-container');
            if (!container) return;
            
            const userHasStory = currentStories && currentStories.some(s => 
                s.username === currentUser.username && s.stories && s.stories.length > 0
            );
            
            if (userHasStory) {
                container.innerHTML = `
                    <div class="drawer-avatar-with-story">
                        <div class="story-indicator">
                            <img src="${currentUser.avatar_url || 'https://via.placeholder.com/150'}" 
                                 alt="${currentUser.display_name || currentUser.username}"
                                 style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <img id="drawer-avatar" src="${currentUser.avatar_url || 'https://via.placeholder.com/150'}" 
                         class="w-12 h-12 rounded-full border border-x-line object-cover" loading="lazy">
                `;
            }
        },

        updateProfileAvatar: () => {
            const container = document.getElementById('profile-avatar-container');
            if (!container) return;
            
            const userHasStory = currentStories && currentStories.some(s => 
                s.username === currentUser.username && s.stories && s.stories.length > 0
            );
            
            if (userHasStory) {
                container.innerHTML = `
                    <div class="story-indicator">
                        <img id="profile-view-avatar" src="${currentUser.avatar_url || 'https://via.placeholder.com/150'}" 
                             style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <img id="profile-view-avatar" src="${currentUser.avatar_url || 'https://via.placeholder.com/150'}" 
                         style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 3px solid #000;" loading="lazy">
                `;
            }
        },

        goBackFromProfile: () => {
            const profileView = document.getElementById('user-profile-view');
            if (!profileView.classList.contains('hidden-content')) {
                
                const existingNotice = profileView.querySelector('.blocked-user-notice');
                if (existingNotice) existingNotice.remove();
                
                if (window._profileCache) {
                    window._profileCache = {};
                }
                
                const avatarContainer = document.getElementById('profile-avatar-container');
                if (avatarContainer) {
                    avatarContainer.innerHTML = '';
                }
                
                window.app.switchMainTab('feed');
                
                const fab = document.getElementById('fab-tweet');
                if (fab) fab.classList.remove('hidden');
                
                const indicator = document.getElementById('tab-indicator');
                if (indicator) {
                    indicator.style.display = 'block';
                    indicator.style.transition = 'all 0.2s ease';
                }
            }
        },

        handleUserAvatarClick: (clickedElement) => {
            if (!clickedElement || !clickedElement.closest) {
                const isFromStoryList = document.querySelector('.story-item:first-child') && 
                                       document.querySelector('.story-item:first-child').contains(clickedElement);
                
                if (isFromStoryList) {
                    const userHasStory = currentStories && currentStories.some(s => 
                        s.username === currentUser.username && s.stories && s.stories.length > 0
                    );
                    
                    if (userHasStory) {
                        window.app.showStoryOptionsModal();
                    } else {
                        window.app.openStoryCreator();
                    }
                }
                return;
            }
            
            const isFromHeader = clickedElement.closest('#header-avatar-container');
            const isFromDrawer = clickedElement.closest('#drawer-avatar-container');
            const isFromProfile = clickedElement.closest('#profile-avatar-container');
            const isFromStoryList = clickedElement.closest('.story-item:first-child');
            
            if (isFromHeader || isFromDrawer) {
                window.app.toggleDrawer();
                return;
            }
            
            if (isFromProfile) {
                const profileView = document.getElementById('user-profile-view');
                if (!profileView.classList.contains('hidden-content')) {
                    const profileUsername = document.getElementById('profile-view-handle').innerText.replace('@', '');
                    
                    if (profileUsername === currentUser.username) {
                        const userHasStory = currentStories && currentStories.some(s => 
                            s.username === currentUser.username && s.stories && s.stories.length > 0
                        );
                        
                        if (userHasStory) {
                            window.app.showStoryOptionsModal();
                        } else {
                            window.app.openStoryCreator();
                        }
                    } else {
                        const userHasStory = currentStories && currentStories.some(s => 
                            s.username === profileUsername && s.stories && s.stories.length > 0
                        );
                        
                        if (userHasStory) {
                            window.app.openStoryViewer(profileUsername, 0);
                        }
                    }
                }
                return;
            }
            
            if (isFromStoryList) {
                const userHasStory = currentStories && currentStories.some(s => 
                    s.username === currentUser.username && s.stories && s.stories.length > 0
                );
                
                if (userHasStory) {
                    window.app.showStoryOptionsModal();
                } else {
                    window.app.openStoryCreator();
                }
                return;
            }
        },

        showStoryOptionsModal: () => {
            const existingModal = document.querySelector('.story-options-modal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.className = 'story-options-modal';
            modal.innerHTML = `
                <div class="story-options-overlay" onclick="this.parentElement.remove()"></div>
                <div class="story-options-content animate-slide-up">
                    <button class="story-option-btn" id="view-stories-btn">
                        <i class="fas fa-eye"></i>
                        <span data-i18n="view_story">  </span>
                    </button>
                    <button class="story-option-btn" id="add-new-story-btn">
                        <i class="fas fa-plus"></i>
                        <span data-i18n="add_new_story">  </span>
                    </button>
                    <button class="story-option-btn cancel" id="cancel-story-btn">
                        <span data-i18n="cancel"></span>
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                const viewBtn = document.getElementById('view-stories-btn');
                const addBtn = document.getElementById('add-new-story-btn');
                const cancelBtn = document.getElementById('cancel-story-btn');
                
                if (viewBtn) {
                    viewBtn.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        modal.remove();
                        const userStories = currentStories.find(s => s.username === currentUser.username);
                        if (userStories && userStories.stories && userStories.stories.length > 0) {
                            window.app.openStoryViewer(currentUser.username, 0);
                        } else {
                            window.app.openStoryCreator();
                        }
                    };
                }
                
                if (addBtn) {
                    addBtn.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        modal.remove();
                        window.app.openStoryCreator();
                    };
                }
                
                if (cancelBtn) {
                    cancelBtn.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        modal.remove();
                    };
                }
                
                i18next.changeLanguage(i18next.language);
            }, 100);
        },

        openStoryCreator: () => {
            currentStoryMedia = null;
            document.getElementById('story-creator').classList.add('active');
            document.getElementById('story-preview').style.display = 'none';
        },

        closeStoryCreator: () => {
            document.getElementById('story-creator').classList.remove('active');
        },

        openGalleryForStory: () => {
            document.getElementById('story-gallery-input').click();
        },

        openCameraForStory: () => {
            window.app.startCamera('story');
        },

        setStoryMedia: (type, data) => {
            currentStoryMedia = { type, data };
            const preview = document.getElementById('story-preview');
            const previewText = document.getElementById('story-preview-text');
            
            preview.style.display = 'block';
            previewText.style.display = 'none';
            
            if (type === 'image') {
                preview.innerHTML = `<img src="${data}" alt="Story Preview" style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">`;
            } else if (type === 'video') {
                preview.innerHTML = `<video src="${data}" controls style="width: 100%; height: 100%; object-fit: cover;"></video>`;
            } else if (type === 'text') {
                previewText.style.display = 'block';
                previewText.style.color = selectedTextColor;
                previewText.textContent = data;
                preview.innerHTML = '';
                preview.appendChild(previewText);
            }
        },

        openStoryTextEditor: () => {
            document.getElementById('story-text-editor').classList.add('active');
        },

        closeStoryTextEditor: () => {
            document.getElementById('story-text-editor').classList.remove('active');
        },

        applyStoryText: () => {
            const text = document.getElementById('story-text-input').value.trim();
            if (text) {
                window.app.setStoryMedia('text', text);
                window.app.closeStoryTextEditor();
                document.getElementById('story-text-input').value = '';
            }
        },

        postStory: async () => {
            if (!currentStoryMedia) {
                alert('     ');
                return;
            }
            
            try {
                updateStoryRing(currentUser.username, 'compressing');
                window.app.closeStoryCreator();
                
                storyUploadQueue.push({
                    storyData: currentStoryMedia,
                    userId: currentUser.username
                });
                
                setTimeout(() => {
                    updateStoryRing(currentUser.username, 'uploading');
                    
                    if (!isUploadingStory) {
                        processNextStoryInQueue();
                    }
                }, 1500);
                
                currentStoryMedia = null;
                
            } catch (e) {
                console.error("    :", e);
                updateStoryRing(currentUser.username, 'error');
                setTimeout(() => {
                    storyUploadStates.delete(currentUser.username);
                }, 3000);
            }
        },

        openStoryViewer: async (username, storyIndex) => {
            const currentProfile = document.getElementById('user-profile-view');
            const isInProfileView = currentProfile && !currentProfile.classList.contains('hidden-content');
            
            if (isInProfileView) {
                const profileUsername = document.getElementById('profile-view-handle').innerText.replace('@', '');
                if (username !== profileUsername) {
                }
            }
            
            if (username === currentUser.username) {
                return;
            }
            
            updateStoryRing(username, 'loading');
            
            const userStories = currentStories.find(s => s.username === username);
            if (!userStories || !userStories.stories || userStories.stories.length === 0) {
                updateStoryRing(username, 'ready');
                return;
            }
            
            currentStoryUserIndex = currentStories.findIndex(s => s.username === username);
            currentStoryIndex = storyIndex;
            
            const viewer = document.getElementById('story-viewer');
            viewer.classList.add('active');
            
            const contentContainer = document.getElementById('story-content');
            contentContainer.innerHTML = `
                <div class="story-nav prev" onclick="window.app.prevStory()"></div>
                <div class="story-nav next" onclick="window.app.nextStory()"></div>
                <div class="flex items-center justify-center h-full bg-black">
                    <div class="text-center">
                        <div class="loading-spinner mb-4"></div>
                        <div class="text-gray-400 text-sm">   ...</div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                window.app.loadCurrentStory();
                updateStoryRing(username, 'ready');
                window.app.startStoryProgress();
            }, 1000);
        },

        closeStoryViewer: () => {
            const viewer = document.getElementById('story-viewer');
            viewer.classList.remove('active');
            
            if (storyInterval !== null && storyInterval !== undefined) {
                clearInterval(storyInterval);
                storyInterval = null;
            }
            
            storyViewerState = 'idle';
            currentStoryId = null;
        },

        loadCurrentStory: () => {
            const userStories = currentStories[currentStoryUserIndex];
            const story = userStories.stories[currentStoryIndex];
            
            if (!story) return;
            
            currentStoryId = story.id;
            const isOwner = userStories.username === currentUser.username;
            
            document.getElementById('current-story-avatar').src = userStories.avatar_url || 'https://via.placeholder.com/150';
            document.getElementById('current-story-username').textContent = userStories.display_name || userStories.username;
            
            const storyTime = new Date(story.created_at);
            const now = new Date();
            const diffMinutes = Math.floor((now - storyTime) / 60000);
            
            let timeText = ' ';
            if (diffMinutes < 60) {
                timeText = `${diffMinutes}  `;
            } else if (diffMinutes < 1440) {
                timeText = `${Math.floor(diffMinutes / 60)}  `;
            } else {
                timeText = `${Math.floor(diffMinutes / 1440)}  `;
            }
            
            document.getElementById('current-story-time').textContent = timeText;
            
            const contentContainer = document.getElementById('story-content');
            
            contentContainer.innerHTML = `
                <div class="story-nav prev" onclick="window.app.prevStory()"></div>
                <div class="story-nav next" onclick="window.app.nextStory()"></div>
                <div class="story-content-inner">
                    ${story.type === 'image' ? 
                        `<img src="${story.media_url}" alt="Story" style="width: 100%; height: 100%; object-fit: contain;" loading="lazy">` : 
                     story.type === 'video' ? 
                        `<video src="${story.media_url}" autoplay controls style="width: 100%; height: 100%; object-fit: contain;"></video>` :
                     story.type === 'text' ? 
                        `<div class="story-text" style="color: ${story.text_color || '#ffffff'}; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 24px; text-align: center; padding: 20px;">${sanitizeHTML(story.text)}</div>` : ''}
                    
                    <div class="story-actions-container">
                        <button class="story-action-btn" onclick="window.app.shareStory('${story.id}')" title="">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        
                        <button class="story-action-btn" id="story-like-btn" 
                                onclick="window.app.likeStory('${story.id}')" 
                                title="">
                            <i class="far fa-heart"></i>
                        </button>
                        
                        <button class="story-action-btn reply-btn" onclick="window.app.replyToStory()" title="">
                            <i class="far fa-comment" style="margin-left: 5px;"></i>
                              ...
                        </button>
                        
                        ${isOwner ? 
                            `<button class="story-action-btn delete" onclick="window.app.deleteStory()" title="">
                                <i class="far fa-trash-alt"></i>
                            </button>` : ''}
                    </div>
                </div>
            `;
            
            window.app.updateProgressBars();
            window.app.startStoryProgress();
        },

        pauseStoryProgress: () => {
            if (storyInterval) {
                clearInterval(storyInterval);
                storyInterval = null;
            }
        },

        resumeStoryProgress: () => {
            if (!storyInterval) {
                window.app.startStoryProgress();
            }
        },

        startStoryProgress: () => {
            if (storyInterval !== null && storyInterval !== undefined) {
                clearInterval(storyInterval);
                storyInterval = null;
            }
            
            const userStories = currentStories[currentStoryUserIndex];
            if (!userStories) return;
            
            const totalStories = userStories.stories.length;
            const storyDuration = 5000;
            
            storyInterval = setInterval(() => {
                const progressFill = document.getElementById(`progress-fill-${currentStoryIndex}`);
                
                if (progressFill) {
                    const currentWidth = parseFloat(progressFill.style.width || '0');
                    const increment = (100 / (storyDuration / 50));
                    
                    if (currentWidth < 100) {
                        progressFill.style.width = `${currentWidth + increment}%`;
                    } else {
                        window.app.nextStory();
                    }
                }
            }, 50);
        },

        updateProgressBars: () => {
            const container = document.getElementById('story-progress-container');
            const userStories = currentStories[currentStoryUserIndex];
            
            container.innerHTML = '';
            
            userStories.stories.forEach((story, index) => {
                const progressBar = document.createElement('div');
                progressBar.className = 'story-progress-bar';
                
                const progressFill = document.createElement('div');
                progressFill.className = 'story-progress-fill';
                progressFill.id = `progress-fill-${index}`;
                
                if (index < currentStoryIndex) {
                    progressFill.style.width = '100%';
                } else if (index === currentStoryIndex) {
                    progressFill.style.width = '0%';
                }
                
                progressBar.appendChild(progressFill);
                container.appendChild(progressBar);
            });
        },

        nextStory: () => {
            const userStories = currentStories[currentStoryUserIndex];
            
            if (currentStoryIndex < userStories.stories.length - 1) {
                currentStoryIndex++;
                window.app.loadCurrentStory();
            } else if (currentStoryUserIndex < currentStories.length - 1) {
                currentStoryUserIndex++;
                currentStoryIndex = 0;
                window.app.loadCurrentStory();
            } else {
                window.app.closeStoryViewer();
            }
        },

        prevStory: () => {
            if (currentStoryIndex > 0) {
                currentStoryIndex--;
                window.app.loadCurrentStory();
            } else if (currentStoryUserIndex > 0) {
                currentStoryUserIndex--;
                const prevUserStories = currentStories[currentStoryUserIndex];
                currentStoryIndex = prevUserStories.stories.length - 1;
                window.app.loadCurrentStory();
            }
        },

        replyToStory: () => {
            const userStories = currentStories[currentStoryUserIndex];
            
            window.app.closeStoryViewer();
            
            setTimeout(() => {
                window.app.startConversation(userStories.username);
                
                setTimeout(() => {
                    const chatInput = document.getElementById('chat-input');
                    if (chatInput) {
                        chatInput.focus();
                        chatInput.placeholder = "  ...";
                    }
                }, 300);
            }, 200);
        },

        likeStory: async (storyId) => {
            const likeBtn = document.getElementById('story-like-btn');
            const likeIcon = likeBtn.querySelector('i');
            
            likeIcon.classList.remove('far', 'fa-heart');
            likeIcon.classList.add('fas', 'fa-heart', 'text-red-500');
            likeBtn.style.transform = 'scale(1.2)';
            
            setTimeout(() => {
                likeBtn.style.transform = 'scale(1)';
            }, 200);
            
            try {
                await fetch(`${SERVER_URL}/api/stories/${storyId}/like`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: currentUser.username })
                });
            } catch (error) {
                console.error("   :", error);
                likeIcon.classList.remove('fas', 'fa-heart', 'text-red-500');
                likeIcon.classList.add('far', 'fa-heart');
            }
        },

        shareStory: (storyId) => {
            const userStories = currentStories[currentStoryUserIndex];
            const story = userStories.stories[currentStoryIndex];
            
            const shareModal = document.createElement('div');
            shareModal.className = 'modal-backdrop';
            shareModal.innerHTML = `
                <div class="modal">
                    <div style="font-weight:600;font-size:16px;"> </div>
                    <button onclick="navigator.share({url: '${window.location.origin}/story/${storyId}'})">
                        <i class="fas fa-share-alt"></i>  
                    </button>
                    <button onclick="navigator.clipboard.writeText('${window.location.origin}/story/${storyId}')">
                        <i class="far fa-copy"></i>  
                    </button>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background:transparent;border:1px solid #444;color:#aaa;">
                        
                    </button>
                </div>
            `;
            
            document.body.appendChild(shareModal);
            shareModal.style.display = 'flex';
        },

        deleteStory: async () => {
            if (!currentStoryId) return;
            
            if (!confirm('      ')) return;
            
            try {
                const res = await fetch(`${SERVER_URL}/api/stories/${currentStoryId}`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: currentUser.username})
                });
                
                if (res.ok) {
                    alert('    !');
                    window.app.loadStories();
                    window.app.closeStoryViewer();
                } else {
                    const errorData = await res.json();
                    throw new Error(errorData.error || '   ');
                }
            } catch (e) {
                console.error("   :", e);
                alert('   : ' + e.message);
            }
        },

        // Language Functions
        openLanguageSettings: () => {
            window.app.openLanguageModal();
            window.app.toggleDrawer();
        },
        openLanguageModal: () => {
            document.getElementById('language-modal').style.display = 'flex';
            updateLanguageIndicator();
        },
        closeLanguageModal: () => {
            document.getElementById('language-modal').style.display = 'none';
        },
        changeLanguage: (lang) => {
            i18next.changeLanguage(lang).then(() => {
                updateLanguageIndicator();
                window.app.closeLanguageModal();
                
                document.querySelectorAll('[data-i18n]').forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    if (key.startsWith('[')) {
                        const matches = key.match(/\[(\w+)\](.+)/);
                        if (matches) {
                            const attr = matches[1];
                            const textKey = matches[2];
                            if (attr === 'html') {
                                element.innerHTML = i18next.t(textKey);
                            } else {
                                element.setAttribute(attr, i18next.t(textKey));
                            }
                        }
                    } else {
                        element.textContent = i18next.t(key);
                    }
                });
            });
        },

        // Premium Modal
        openPremium: () => {
            document.getElementById('premium-modal').style.display = 'block';
            window.app.toggleDrawer();
        },
        closePremium: () => {
            document.getElementById('premium-modal').style.display = 'none';
        },

        // Navigation & UI
        toggleDrawer: () => {
            const d = document.getElementById('drawer');
            const o = document.getElementById('drawer-overlay');
            const isOpen = !d.classList.contains('translate-x-full');
            
            if (isOpen) {
                d.classList.add('translate-x-full');
                o.classList.add('hidden');
            } else {
                d.classList.remove('translate-x-full');
                o.classList.remove('hidden');
                o.onclick = window.app.toggleDrawer;
            }
        },
        logout: () => { 
            cleanupInfiniteScroll();
            cleanupLazyLoading();
            
            if (storyInterval !== null && storyInterval !== undefined) {
                clearInterval(storyInterval);
                storyInterval = null;
            }
            
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            storyUploadStates.clear();
            storyUploadQueue = [];
            storyRingStates.clear();
            isUploadingStory = false;
            
            localStorage.removeItem('x_user_v2');
            localStorage.removeItem(LS_KEYS.NOTIFICATIONS_SEEN);
            localStorage.removeItem(LS_KEYS.DMS_SEEN);
            localStorage.removeItem(LS_KEYS.NOTIFICATION_COUNT);
            localStorage.removeItem(LS_KEYS.DM_COUNT);
            
            location.reload();
        },
        
        switchMainTab: (tab) => {
            const views = ['feed', 'rooms', 'search', 'user-profile', 'dms', 'notifications', 'bookmarks'];
            views.forEach(v => {
                const el = document.getElementById(v + '-view');
                if (el) el.classList.add('hidden-content');
            });
            
            const fab = document.getElementById('fab-tweet');
            const indicator = document.getElementById('tab-indicator');

            isDmSearchMode = false;

            if(tab === 'feed') {
                document.getElementById('feed-view').classList.remove('hidden-content');
                fab.classList.remove('hidden');
                indicator.style.display = 'block'; 
                indicator.parentElement.appendChild(indicator);
                fetchTweets();
                window.app.loadStories();
            } else if(tab === 'rooms') {
                document.getElementById('rooms-view').classList.remove('hidden-content');
                fab.classList.add('hidden');
                indicator.style.display = 'block';
            } else if (tab === 'search') {
                document.getElementById('search-view').classList.remove('hidden-content');
                fab.classList.add('hidden');
                indicator.style.display = 'none';
                document.getElementById('search-input').focus();
            } else if (tab === 'dms') {
                document.getElementById('dms-view').classList.remove('hidden-content');
                fab.classList.add('hidden');
                indicator.style.display = 'none';
                localStorage.setItem(LS_KEYS.DMS_SEEN, Date.now());
                localStorage.setItem(LS_KEYS.DM_COUNT, 0);
                document.getElementById('dm-badge').classList.remove('active');
                document.getElementById('dm-badge').innerHTML = '';
                
                //   API    
                if (window.app.fetchConversationsV2) {
                    window.app.fetchConversationsV2();
                } else {
                    window.app.fetchConversations();
                }
            } else if (tab === 'notifications') {
                document.getElementById('notifications-view').classList.remove('hidden-content');
                fab.classList.add('hidden');
                indicator.style.display = 'none';
                localStorage.setItem(LS_KEYS.NOTIFICATIONS_SEEN, Date.now());
                localStorage.setItem(LS_KEYS.NOTIFICATION_COUNT, 0);
                document.getElementById('notification-badge').classList.remove('active');
                window.app.fetchNotifications();
            } else if (tab === 'bookmarks') {
                document.getElementById('bookmarks-view').classList.remove('hidden-content');
                fab.classList.add('hidden');
                indicator.style.display = 'none';
                window.app.fetchBookmarks();
            }
        },

     // ============================================================================
// NOTIFICATIONS -       
// ============================================================================
fetchNotifications: async function() {
    const container = document.getElementById('notifications-list');
    if (!container) return;
    
    container.innerHTML = '<div class="text-center text-gray-500 mt-5 pt-10"><i class="fas fa-spinner fa-spin"></i></div>';
    
    try {
        const res = await fetch(`${SERVER_URL}/api/notifications/${currentUser.username}`);
        
        if (!res.ok) {
            throw new Error(`    (${res.status})`);
        }
        
        const data = await res.json();
        
        //   
        container.innerHTML = '';
        
        //    
        let notifications = [];
        
        if (Array.isArray(data)) {
            //    
            notifications = data;
        } else if (data && data.notifications && Array.isArray(data.notifications)) {
            //      notifications 
            notifications = data.notifications;
        } else if (data && data.data && Array.isArray(data.data)) {
            //   data 
            notifications = data.data;
        } else {
            console.warn("  :", data);
            notifications = [];
        }
        
        if (notifications.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 mt-10 text-sm">  .</div>';
            return;
        }
        
        notifications.forEach(notif => {
            const div = document.createElement('div');
            div.className = 'notification-item';
            div.style.cssText = `
                padding: 16px;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                display: flex;
                align-items: center;
                gap: 12px;
                background: ${notif.read ? 'transparent' : 'rgba(29, 155, 240, 0.1)'};
                cursor: pointer;
            `;
            
            //     
            let icon = '';
            const type = (notif.type || '').toUpperCase();
            
            if (type === 'LIKE') icon = '';
            else if (type === 'REPLY') icon = '';
            else if (type === 'FOLLOW') icon = '';
            else if (type === 'MENTION') icon = '@';
            else if (type === 'VERIFICATION') icon = '';
            else if (type === 'DM') icon = '';
            
            //   
            let content = notif.content || '';
            if (!content && notif.sender_username) {
                if (type === 'LIKE') content = `${notif.sender_username}     `;
                else if (type === 'REPLY') content = `${notif.sender_username}     `;
                else if (type === 'FOLLOW') content = `${notif.sender_username}    `;
                else if (type === 'MENTION') content = `${notif.sender_username}    `;
                else if (type === 'DM') content = `   ${notif.sender_username}`;
                else content = notif.sender_username;
            }
            
            // 
            let timeText = '';
            try {
                if (notif.created_at) {
                    timeText = formatTime(new Date(notif.created_at));
                }
            } catch (e) {
                timeText = '';
            }
            
            div.innerHTML = `
                <div style="font-size: 20px;">${icon}</div>
                <div style="flex: 1;">
                    <div class="text-white text-sm">${sanitizeHTML(content)}</div>
                    <div class="text-gray-500 text-xs mt-1">${timeText}</div>
                </div>
            `;
            
            //   
            div.onclick = () => {
                if (notif.reference_id) {
                    //      
                    if (notif.sender_username) {
                        window.app.openProfile(notif.sender_username);
                    }
                }
            };
            
            container.appendChild(div);
        });
        
        //    
        const unreadCount = notifications.filter(n => !n.read).length;
        const badge = document.getElementById('notification-badge');
        if (badge) {
            if (unreadCount > 0) {
                badge.classList.add('active');
                badge.style.display = 'block';
                localStorage.setItem(LS_KEYS.NOTIFICATION_COUNT, unreadCount);
            } else {
                badge.classList.remove('active');
                badge.style.display = 'none';
                localStorage.setItem(LS_KEYS.NOTIFICATION_COUNT, 0);
            }
        }
        
    } catch(e) {
        console.error("    :", e);
        container.innerHTML = `
            <div class="text-center text-gray-500 mt-10 text-sm">
                <i class="fas fa-exclamation-circle text-xl mb-2"></i>
                <div>   </div>
                <button onclick="window.app.fetchNotifications()" 
                        class="mt-3 px-4 py-2 bg-x-blue rounded-full text-xs">
                     
                </button>
            </div>
        `;
    }
},
        // Direct Messages (Legacy -  fallback)
        fetchConversations: async () => {
             const c = document.getElementById('conversations-list');
             c.innerHTML = '<div class="text-center text-gray-500 mt-5 pt-10"><i class="fas fa-spinner fa-spin"></i></div>';
             try {
                 const res = await fetch(`${SERVER_URL}/api/dm/list/${currentUser.username}`);
                 if (!res.ok) throw new Error("   ");
                 const convos = await res.json();
                 c.innerHTML = '';
                 if(!convos || convos.length === 0) {
                     c.innerHTML = '<div class="text-center text-gray-500 mt-10 text-sm">  .<br>     +  .</div>';
                     return;
                 }
                 
                 convos.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                 
                 convos.forEach(conv => {
                     const div = document.createElement('div');
                     div.className = 'dm-item';
                     div.onclick = () => window.app.startConversation(conv.other_user);
                     
                     const unreadCount = conv.unread_count || 0;
                     const badge = unreadCount > 0 ? 
                         `<div class="unread-badge">${unreadCount}</div>` : '';
                     
                     div.innerHTML = `
                        ${badge}
                        <img src="${conv.other_avatar || 'https://via.placeholder.com/150'}" class="dm-avatar" loading="lazy">
                        <div class="dm-content">
                            <div class="flex items-center gap-1">
                                <span class="font-bold text-white text-sm">${sanitizeHTML(conv.other_display_name || conv.other_user)}</span>
                                <span class="text-gray-500 text-xs dir-ltr">@${conv.other_user}</span>
                                <span class="dm-time">${formatTime(new Date(conv.updated_at))}</span>
                            </div>
                            <div class="text-gray-500 text-sm truncate text-right dir-rtl">${sanitizeHTML(conv.last_message || '...')}</div>
                        </div>
                     `;
                     c.appendChild(div);
                 });
             } catch(e) { 
                 console.error("   :", e);
                 c.innerHTML = '<div class="text-center text-gray-500 mt-10 text-sm">   </div>'; 
             }
        },
        
        deleteMessage: async (messageId) => {
            if(!confirm('      ')) return;
            try {
                const res = await fetch(`${SERVER_URL}/api/dm/${messageId}`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: currentUser.username})
                });
                
                if (res.ok) {
                    const msgEl = document.querySelector(`[data-message-id="${messageId}"]`);
                    if (msgEl) msgEl.remove();
                    
                    if (currentChatContext === 'room') {
                        const messagesBox = document.getElementById('chat-messages');
                        messagesBox.innerHTML = '<div class="text-center text-gray-600 text-xs py-4">  ...</div>';
                        
                        const res = await fetch(`${SERVER_URL}/api/rooms/${currentChatId}/messages`);
                        if(res.ok) {
                            const messages = await res.json();
                            messagesBox.innerHTML = '';
                            messages.forEach(msg => renderMsg(msg, msg.username === currentUser.username));
                        }
                    }
                }
            } catch (e) {
                console.error("   :", e);
                alert("   ");
            }
        },
        
        openNewMessageSearch: () => {
             isDmSearchMode = true;
             document.getElementById('dms-view').classList.add('hidden-content');
             document.getElementById('search-view').classList.remove('hidden-content');
             document.getElementById('search-input').focus();
             document.getElementById('search-results').innerHTML = '<div class="text-center text-gray-500 text-sm mt-10">       </div>';
        },
        
        startConversation: async (targetUsername) => {
             //   API  
             if (window.app.startConversationV2) {
                 await window.app.startConversationV2(targetUsername);
                 return;
             }
             
             // Fallback   
             try {
                 const res = await fetch(`${SERVER_URL}/api/dm/conversation`, {
                     method: 'POST',
                     headers: {'Content-Type': 'application/json'},
                     body: JSON.stringify({ 
                         username1: currentUser.username, 
                         username2: targetUsername 
                     })
                 });
                 
                 if (!res.ok) {
                     const errorData = await res.json();
                     throw new Error(errorData.error || "   ");
                 }
                 
                 const data = await res.json();
                 const conversation = data.conversation;
                 const messages = data.messages;
                 
                 currentChatContext = 'dm';
                 currentChatId = conversation.id;
                 
                 const ui = document.getElementById('chat-interface');
                 ui.classList.remove('hidden');
                 setTimeout(() => ui.classList.remove('translate-x-full'), 10);
                 
                 document.getElementById('chat-header-title').innerText = conversation.other_display_name || targetUsername;
                 document.getElementById('chat-header-avatar').src = conversation.other_avatar || 'https://via.placeholder.com/150';
                 document.getElementById('chat-header-subtitle').innerText = i18next.t('private_message');

                 const messagesBox = document.getElementById('chat-messages');
                 messagesBox.innerHTML = '';
                 
                 if(messages && messages.length > 0) {
                     messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                     messages.forEach(msg => renderMsg(msg, msg.username === currentUser.username));
                 } else {
                     messagesBox.innerHTML = '<div class="text-center text-gray-600 text-xs py-4"> .  !</div>';
                 }

                 if(socket) socket.emit('join_conversation', conversation.id);

             } catch(e) { 
                 console.error("   :", e);
                 alert("   : " + e.message); 
             }
        },

        // Hardcoded Room Logic
        joinHardcodedRoom: async () => {
             currentChatContext = 'room';
             currentChatId = 'ajsports_global';
             
             const ui = document.getElementById('chat-interface');
             ui.classList.remove('hidden');
             setTimeout(() => ui.classList.remove('translate-x-full'), 10);
             
             document.getElementById('chat-header-title').innerText = i18next.t('ajsports_group');
             document.getElementById('chat-header-subtitle').innerText = i18next.t('online');
             document.getElementById('chat-header-avatar').src = 'https://cdn-icons-png.flaticon.com/512/53/53283.png';
             
             const messagesBox = document.getElementById('chat-messages');
             messagesBox.innerHTML = '<div class="text-center text-gray-600 text-xs py-4">  ...</div>';

             if(socket) socket.emit('join_room', currentChatId);

             try {
                const res = await fetch(`${SERVER_URL}/api/rooms/${currentChatId}/messages`);
                if(res.ok) {
                    const messages = await res.json();
                    messagesBox.innerHTML = '';
                    if(messages.length === 0) messagesBox.innerHTML = '<div class="text-center text-gray-600 text-xs py-4">   .</div>';
                    messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    messages.forEach(msg => renderMsg(msg, msg.username === currentUser.username));
                }
             } catch(e) { 
                 console.error("    :", e);
                 messagesBox.innerHTML = '<div class="text-center text-gray-600 text-xs py-4"> .</div>'; 
             }
        },
        closeChatInterface: () => {
             const ui = document.getElementById('chat-interface');
             ui.classList.add('translate-x-full');
             setTimeout(() => ui.classList.add('hidden'), 300);
             currentChatContext = null;
             currentChatId = null;
        },
        
        sendChatMessage: async () => {
            const inp = document.getElementById('chat-input');
            const txt = inp.value.trim();
            
            if(!txt || !currentChatId || !socket) return;

            if (currentChatContext === 'dm' && window.app.sendMessageV2) {
                await window.app.sendMessageV2();
            } else if (currentChatContext === 'room') {
                socket.emit('send_message', { 
                    matchId: currentChatId, 
                    username: currentUser.username, 
                    content: sanitizeHTML(txt) 
                });
                playMessageSound();
                inp.value = '';
                inp.focus();
            } else if (currentChatContext === 'dm') {
                socket.emit('send_dm', { 
                    conversationId: currentChatId, 
                    senderUsername: currentUser.username, 
                    content: sanitizeHTML(txt) 
                });
                playMessageSound();
                inp.value = '';
                inp.focus();
            }
        },

        // Tweet Media Functions
        openComposerGallery: function() {
            document.getElementById('tweet-media-input').click();
        },
        removeComposerMedia: function() {
            currentTweetMedia = null;
            const preview = document.getElementById('composer-media-preview');
            const image = document.getElementById('composer-media-image');
            preview.classList.add('hidden');
            image.src = '';
            document.getElementById('tweet-media-input').value = '';
        },
        
        uploadTweetMedia: async function(file) {
            try {
                showNotificationToast('   ...');
                
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE_URL}/api/upload/image`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '   ');
                }
                
                return data.url;
                
            } catch (error) {
                console.error(" Upload error:", error);
                showNotificationToast('   ');
                return null;
            }
        },

        postTweet: async function() {
            const txt = document.getElementById('composer-text').value.trim();
            const btn = document.getElementById('post-btn');
            
            if(!txt && !currentTweetMedia && !window.currentSelectedGif) {
                showNotificationToast('      ');
                return;
            }
            
            btn.disabled = true;
            btn.innerText = '  ...';
            
            try {
                let mediaUrl = null;
                let mediaType = null;
                
                if (window.currentSelectedGif) {
                    mediaUrl = window.currentSelectedGif.mp4 || window.currentSelectedGif.gif;
                    mediaType = 'gif';
                }
                else if (currentTweetMedia) {
                    mediaUrl = await window.app.uploadTweetMedia(currentTweetMedia);
                    mediaType = 'image';
                    if (!mediaUrl) {
                        throw new Error('   ');
                    }
                }
                
                const payload = { 
                    username: currentUser.username, 
                    content: sanitizeHTML(txt || ''),
                    parentId: replyingToTweet ? replyingToTweet.id : null,
                    media_url: mediaUrl,
                    media_type: mediaType
                };
                
                const res = await fetch(`${SERVER_URL}/api/tweets`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || ' ');
                }
                
                const data = await res.json();
                if(data.success) {
                    window.app.closeMobileComposer();
                    document.getElementById('composer-text').value = '';
                    window.app.removeComposerMedia();
                    window.app.removeComposerGif();
                    document.getElementById('reply-context').classList.remove('show');
                    replyingToTweet = null;
                    
                    fetchTweets();
                    
                    showNotificationToast('     ');
                } else {
                    throw new Error(data.error || ' ');
                }
            } catch (e) { 
                alert("  : " + (e.message || "   .")); 
            } finally { 
                btn.disabled = false; 
                btn.innerText = i18next.t('post'); 
            }
        },

        openImageModal: function(imageUrl) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-[10000] bg-black/95 flex items-center justify-center';
            modal.onclick = () => modal.remove();
            
            modal.innerHTML = `
                <div class="relative max-w-[90vw] max-h-[90vh]">
                    <img src="${imageUrl}" class="max-w-full max-h-[90vh] object-contain" loading="lazy">
                    <button onclick="this.closest('.fixed').remove()" 
                            class="absolute top-4 right-4 w-10 h-10 bg-black/70 rounded-full flex items-center justify-center text-white hover:bg-black/90">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        },

        // Header Functions
        openHeaderChooser: function() {
            const isOwner = document.getElementById('profile-view-handle').innerText.replace('@', '') === currentUser.username;
            if (!isOwner) return;
            document.getElementById('header-file-input').click();
        },

        uploadHeader: async function(file) {
            try {
                showNotificationToast('   ...');
                
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE_URL}/api/upload/image`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '   ');
                }
                
                return data.url;
                
            } catch (error) {
                console.error(" Header upload error:", error);
                showNotificationToast('   ');
                return null;
            }
        },

        saveProfile: async function() {
            const btn = document.getElementById('save-profile-btn');
            btn.innerText = '  ...';
            
            const newName = document.getElementById('edit-name-input').value;
            const newBio = document.getElementById('edit-bio-input').value;
            let newAvatar = document.getElementById('edit-avatar-preview').src;
            let newHeader = currentUser.header_url || null;

            try {
                if(capturedImageData) {
                    const blob = await fetch(capturedImageData).then(r => r.blob());
                    const file = new File([blob], 'avatar.jpg', { type: 'image/jpeg' });
                    
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const uploadRes = await fetch(`${API_BASE_URL}/api/upload/image`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (uploadRes.ok) {
                        const uploadData = await uploadRes.json();
                        newAvatar = uploadData.url;
                    }
                }
                
                if (window._pendingHeaderFile) {
                    const headerUrl = await window.app.uploadHeader(window._pendingHeaderFile);
                    if (headerUrl) newHeader = headerUrl;
                    window._pendingHeaderFile = null;
                }

                const res = await fetch(`${SERVER_URL}/api/users/update`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser.username,
                        display_name: newName,
                        bio: newBio,
                        avatar_url: newAvatar,
                        header_url: newHeader
                    })
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || '  ');
                }

                const data = await res.json();
                if(data.success) {
                    currentUser.display_name = newName;
                    currentUser.bio = newBio;
                    currentUser.avatar_url = newAvatar;
                    currentUser.header_url = newHeader;
                    localStorage.setItem('x_user_v2', JSON.stringify(currentUser));
                    
                    document.getElementById('profile-view-name').innerText = newName;
                    document.getElementById('profile-view-bio').innerText = newBio;
                    document.getElementById('profile-view-avatar').src = newAvatar;
                    if (newHeader) {
                        document.getElementById('profile-header-image').src = newHeader;
                    }
                    
                    window.app.updateHeaderAvatar();
                    window.app.updateDrawerAvatar();
                    window.app.updateProfileAvatar();
                    
                    document.getElementById('drawer-name').innerText = newName;
                    
                    window.app.closeEditProfile();
                    window.app.loadStories();
                    
                    showNotificationToast('     ');
                }
            } catch(e) { 
                console.error("   :", e);
                alert("   : " + e.message); 
            }
            finally { btn.innerText = i18next.t('save'); }
        },

        // Profile Functions
        openProfile: async function(username) {
            const profileView = document.getElementById('user-profile-view');
            
            const existingNotice = profileView.querySelector('.blocked-user-notice');
            if (existingNotice) existingNotice.remove();
            
            if (window._profileCache) {
                window._profileCache = {};
            }
            
            const avatarContainer = document.getElementById('profile-avatar-container');
            if (avatarContainer) {
                avatarContainer.innerHTML = '';
            }
            
            ['feed', 'rooms', 'search', 'dms', 'notifications', 'bookmarks'].forEach(v => {
                const el = document.getElementById(v + '-view');
                if (el) el.classList.add('hidden-content');
            });
            
            const fab = document.getElementById('fab-tweet');
            if (fab) fab.classList.add('hidden');
            
            profileView.classList.remove('hidden-content');
            const indicator = document.getElementById('tab-indicator');
            if (indicator) indicator.style.display = 'none';

            document.getElementById('profile-view-name').innerHTML = username;
            document.getElementById('profile-view-handle').innerText = '@' + username;
            document.getElementById('profile-view-bio').innerText = '';
            document.getElementById('profile-edit-btn').classList.add('hidden');
            document.getElementById('admin-controls').classList.add('hidden');
            document.getElementById('admin-controls').innerHTML = '';
            
            const headerImage = document.getElementById('profile-header-image');
            const headerOverlay = document.getElementById('profile-header-edit-overlay');
            if (headerOverlay) headerOverlay.classList.add('hidden');
            
            const tweetsContainer = document.getElementById('profile-tweets-container');
            if (tweetsContainer) tweetsContainer.innerHTML = '';

            const status = await blockSystem.checkBlockStatus(username);
            
            if (status.blockedByMe) {
                if (typeof blockSystem.showBlockedByMeProfile === 'function') {
                    blockSystem.showBlockedByMeProfile(username);
                }
                return;
            } else if (status.blockedMe) {
                if (typeof blockSystem.showBlockedMeProfile === 'function') {
                    blockSystem.showBlockedMeProfile(username);
                }
                return;
            }
            
            try {
                const res = await fetch(`${SERVER_URL}/api/users/profile/${username}?me=${currentUser.username}`);
                if (res.ok) {
                    const data = await res.json();
                    if(data) {
                        updateProfileUI(data);
                    }
                }
            } catch(e) { 
                console.error("Profile fetch error", e);
            } finally {
                fetchUserTweets(username);
            }
            
            function updateProfileUI(data) {
                const userHasStory = currentStories && currentStories.some(s => 
                    s.username === username && s.stories && s.stories.length > 0
                );
                
                const avatarContainer = document.getElementById('profile-avatar-container');
                avatarContainer.className = 'profile-avatar-with-story';
                
                if (userHasStory) {
                    avatarContainer.innerHTML = `
                        <div class="story-indicator">
                            <img id="profile-view-avatar" src="${data.avatar_url || 'https://via.placeholder.com/150'}" 
                                 style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">
                        </div>
                    `;
                } else {
                    avatarContainer.innerHTML = `
                        <img id="profile-view-avatar" src="${data.avatar_url || 'https://via.placeholder.com/150'}" 
                             style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 3px solid #000;" loading="lazy">
                    `;
                }
                
                document.getElementById('profile-view-name').innerHTML = data.display_name || data.username;
                document.getElementById('profile-view-handle').innerText = '@' + data.username;
                document.getElementById('profile-view-bio').innerText = data.bio || '';
                
                document.getElementById('profile-followers-count').innerText = data.followers_count || 0;
                document.getElementById('profile-following-count').innerText = data.following_count || 0;
                
                if(data.verification === 'gold') {
                    document.getElementById('profile-view-name').innerHTML = 
                        `${sanitizeHTML(data.display_name || data.username)} <img src="https://upload.wikimedia.org/wikipedia/commons/8/81/Twitter_Verified_Badge_Gold.svg" class="verification-badge gold" alt="Verified Gold" loading="lazy">`;
                } else if(data.verification === 'blue') {
                    document.getElementById('profile-view-name').innerHTML = 
                        `${sanitizeHTML(data.display_name || data.username)} <img src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg" class="verification-badge blue" alt="Verified Blue" loading="lazy">`;
                }
                
                if (data.header_url) {
                    headerImage.src = data.header_url;
                } else {
                    headerImage.src = 'https://via.placeholder.com/600x200/333333/666666?text=Header';
                }
                
                if (username === currentUser.username) {
                    headerOverlay.classList.remove('hidden');
                    
                    document.getElementById('profile-header-container').onclick = (e) => {
                        if (e.target === headerImage || e.target.closest('#profile-header-container')) {
                            window.app.openHeaderChooser();
                        }
                    };
                } else {
                    headerOverlay.classList.add('hidden');
                    document.getElementById('profile-header-container').onclick = null;
                }
                
                if(currentUser.username === username) {
                    document.getElementById('profile-edit-btn').classList.remove('hidden');
                    
                    const existingOptionsBtn = document.querySelector('.profile-options-btn');
                    if (existingOptionsBtn) existingOptionsBtn.remove();
                } else {
                    document.getElementById('profile-edit-btn').classList.add('hidden');
                    
                    const profileHeader = document.querySelector('#user-profile-view > .relative');
                    if (profileHeader) {
                        const existingOptionsBtn = document.querySelector('.profile-options-btn');
                        if (existingOptionsBtn) existingOptionsBtn.remove();
                        
                        const optionsBtn = document.createElement('button');
                        optionsBtn.className = 'profile-options-btn';
                        optionsBtn.innerHTML = '<i class="fas fa-ellipsis-h"></i>';
                        optionsBtn.onclick = (e) => {
                            e.stopPropagation();
                            window.app.toggleProfileOptionsMenu(username);
                        };
                        
                        profileHeader.appendChild(optionsBtn);
                    }
                }
                
                const adminControls = document.getElementById('admin-controls');
                if(currentUser.is_admin && currentUser.username !== username) {
                    adminControls.classList.remove('hidden');
                    
                    let controlsHtml = '';
                    if(data.verification !== 'blue') {
                        controlsHtml += `<button class="admin-btn grant-blue" onclick="window.app.grantVerification('${username}', 'blue')">  </button>`;
                    }
                    
                    if(data.verification !== 'gold') {
                        controlsHtml += `<button class="admin-btn grant-gold" onclick="window.app.grantVerification('${username}', 'gold')">  </button>`;
                    }
                    
                    if(data.verification) {
                        controlsHtml += `<button class="admin-btn remove" onclick="window.app.removeVerification('${username}')"> </button>`;
                    }
                    
                    adminControls.innerHTML = controlsHtml;
                } else {
                    adminControls.classList.add('hidden');
                }
            }
            
            setTimeout(() => {
                const profileAvatar = document.getElementById('profile-avatar-container');
                if (profileAvatar) {
                    const newAvatar = profileAvatar.cloneNode(true);
                    profileAvatar.parentNode.replaceChild(newAvatar, profileAvatar);
                    
                    const currentProfileAvatar = document.getElementById('profile-avatar-container');
                    currentProfileAvatar.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        if (username === currentUser.username) {
                            window.app.handleUserAvatarClick(e.target);
                        } else {
                            const userHasStory = currentStories && currentStories.some(s => 
                                s.username === username && s.stories && s.stories.length > 0
                            );
                            
                            if (userHasStory) {
                                window.app.openStoryViewer(username, 0);
                            }
                        }
                    };
                }
            }, 300);
        },

        // Tweet & Reply Logic
        openMobileComposer: () => {
             replyingToTweet = null;
             document.getElementById('reply-context').classList.remove('show');
             
             const modal = document.getElementById('composer-modal');
             modal.classList.remove('hidden');
             document.getElementById('composer-avatar').src = currentUser.avatar_url || currentUser.avatar || 'https://via.placeholder.com/150';
             setTimeout(() => modal.classList.add('open'), 10);
             document.getElementById('composer-text').focus();
        },
        openReplyComposer: (tweetId, username) => {
             replyingToTweet = { id: tweetId, username: username };
             
             const modal = document.getElementById('composer-modal');
             modal.classList.remove('hidden');
             document.getElementById('composer-avatar').src = currentUser.avatar_url || currentUser.avatar || 'https://via.placeholder.com/150';
             
             document.getElementById('reply-context').classList.add('show');
             document.getElementById('reply-to-username').innerText = '@' + username;

             setTimeout(() => modal.classList.add('open'), 10);
             document.getElementById('composer-text').focus();
        },
        closeMobileComposer: () => {
             const modal = document.getElementById('composer-modal');
             modal.classList.remove('open');
             setTimeout(() => {
                 modal.classList.add('hidden');
                 window.app.removeComposerGif();
             }, 300);
        },

        // Interactions
        likeTweet: async (tweetId) => {
            const icon = document.getElementById(`like-icon-${tweetId}`);
            const countEl = document.getElementById(`like-count-${tweetId}`);
            
            if (icon && countEl) {
                const isLiked = icon.classList.contains('liked');
                const currentCount = parseInt(countEl.innerText || 0);
                
                if (isLiked) {
                    icon.classList.remove('liked');
                    countEl.innerText = Math.max(currentCount - 1, 0);
                } else {
                    icon.classList.add('liked');
                    countEl.innerText = currentCount + 1;
                }
                
                icon.classList.add('optimistic-transition');
            }
            
            try {
                const res = await fetch(`${SERVER_URL}/api/tweets/${tweetId}/like`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: currentUser.username })
                });
                
                if(!res.ok) {
                    if (icon && countEl) {
                        if (icon.classList.contains('liked')) {
                            icon.classList.remove('liked');
                            countEl.innerText = Math.max(parseInt(countEl.innerText || 1) - 1, 0);
                        } else {
                            icon.classList.add('liked');
                            countEl.innerText = parseInt(countEl.innerText || 0) + 1;
                        }
                    }
                }
            } catch (e) { 
                console.error("  :", e);
                if (icon && countEl) {
                    if (icon.classList.contains('liked')) {
                        icon.classList.remove('liked');
                        countEl.innerText = Math.max(parseInt(countEl.innerText || 1) - 1, 0);
                    } else {
                        icon.classList.add('liked');
                        countEl.innerText = parseInt(countEl.innerText || 0) + 1;
                    }
                }
            }
        },
        
        toggleTweetMenu: function(tweetId) {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                if (menu.id !== `menu-${tweetId}`) {
                    menu.classList.remove('show');
                }
            });
            
            const menu = document.getElementById(`menu-${tweetId}`);
            if (menu) {
                menu.classList.toggle('show');
                menu.onclick = (e) => e.stopPropagation();
            }
        },
        
        toggleProfileOptionsMenu: async (username) => {
            document.querySelectorAll('.profile-dropdown-menu').forEach(m => m.classList.remove('show'));
            
            const menuId = `profile-menu-${username}`;
            let menu = document.getElementById(menuId);
            
            if (!menu) {
                const profileHeader = document.querySelector('#user-profile-view > .relative');
                if (!profileHeader) return;
                
                menu = document.createElement('div');
                menu.id = menuId;
                menu.className = 'profile-dropdown-menu';
                
                const status = await blockSystem.checkBlockStatus(username);
                
                let menuHtml = '';
                
                if (username !== currentUser.username) {
                    menuHtml += `
                        <div class="profile-dropdown-item report" onclick="window.app.openReportModalFromProfile('${username}')">
                            <i class="fas fa-flag"></i>  
                        </div>`;
                    
                    if (status.blockedByMe) {
                        menuHtml += `
                            <div class="profile-dropdown-item" onclick="window.app.unblockUser('${username}')">
                                <i class="fas fa-user-check"></i>  
                            </div>`;
                    } else {
                        menuHtml += `
                            <div class="profile-dropdown-item block" onclick="window.app.openBlockConfirmModal('${username}')">
                                <i class="fas fa-user-slash"></i>  
                            </div>`;
                    }
                }
                
                menu.innerHTML = menuHtml;
                profileHeader.appendChild(menu);
            }
            
            menu.classList.toggle('show');
        },
        
        openReportModalFromProfile: function(username) {
            const userTweet = document.querySelector(`.tweet-card .text-gray-500.truncate.text-\\[14px\\][innerText*="@${username}"]`);
            let tweetId = null;
            
            if (userTweet) {
                const tweetCard = userTweet.closest('.tweet-card');
                if (tweetCard && tweetCard.id) {
                    tweetId = tweetCard.id.replace('tweet-', '');
                }
            }
            
            window.app.openReportModal(tweetId || `profile_${username}_${Date.now()}`, username);
        },
        
        deleteTweet: async (id) => {
            if(!confirm('      ')) return;
            
            const el = document.getElementById(`tweet-${id}`);
            if(el) {
                el.style.opacity = '0';
                el.style.transition = 'opacity 0.3s ease';
                
                setTimeout(() => {
                    el.remove();
                    
                    const profileView = document.getElementById('user-profile-view');
                    if (profileView && !profileView.classList.contains('hidden-content')) {
                        const username = document.getElementById('profile-view-handle').innerText.replace('@', '');
                        if (username === currentUser.username) {
                            fetchUserTweets(username);
                        }
                    }
                }, 300);
            }
            
            try {
                const res = await fetch(`${SERVER_URL}/api/tweets/${id}`, { 
                    method: 'DELETE', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({username: currentUser.username}) 
                });
                
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.error || '   ');
                }
                
                showNotificationToast('    ');
                
            } catch(e) { 
                console.error("   :", e);
                alert("   : " + e.message);
                
                if (el) {
                    el.style.opacity = '1';
                }
            }
        },
        
        toggleBookmark: async (id) => {
             const icon = document.getElementById(`bookmark-icon-${id}`);
             if(icon) {
                 icon.classList.toggle('bookmarked');
                 
                 try {
                     await fetch(`${SERVER_URL}/api/tweets/${id}/bookmark`, {
                         method: 'POST',
                         headers: {'Content-Type': 'application/json'},
                         body: JSON.stringify({ username: currentUser.username })
                     });
                 } catch (e) {
                     console.error("  :", e);
                     icon.classList.toggle('bookmarked');
                 }
             }
        },

        // Admin Functions
        grantVerification: async (targetUsername, type) => {
            if(!confirm(`   ${type === 'blue' ? '' : ''}   @${targetUsername}  `)) return;
            
            try {
                const res = await fetch(`${SERVER_URL}/api/admin/verification`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        adminUsername: currentUser.username,
                        targetUsername: targetUsername,
                        type: type
                    })
                });
                
                if(res.ok) {
                    alert(` ${type === 'blue' ? '' : ''}    !`);
                    window.app.openProfile(targetUsername);
                }
            } catch(e) {
                console.error("   :", e);
                alert("   : " + e.message);
            }
        },
        
        removeVerification: async (targetUsername) => {
            if(!confirm(`   @${targetUsername}   `)) return;
            
            try {
                const res = await fetch(`${SERVER_URL}/api/admin/remove-verification`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        adminUsername: currentUser.username,
                        targetUsername: targetUsername
                    })
                });
                
                if(res.ok) {
                    alert("    !");
                    window.app.openProfile(targetUsername);
                }
            } catch(e) {
                console.error("   :", e);
                alert("   : " + e.message);
            }
        },

        openEditProfile: () => {
             const modal = document.getElementById('edit-profile-modal');
             modal.classList.remove('hidden');
             setTimeout(() => modal.classList.add('open'), 10);
             document.getElementById('edit-name-input').value = document.getElementById('profile-view-name').innerText.replace(/<img[^>]*>/g, '').trim();
             document.getElementById('edit-bio-input').value = document.getElementById('profile-view-bio').innerText;
             document.getElementById('edit-avatar-preview').src = document.getElementById('profile-view-avatar').src;
        },
        closeEditProfile: () => {
             const modal = document.getElementById('edit-profile-modal');
             modal.classList.remove('open');
             setTimeout(() => modal.classList.add('hidden'), 300);
             capturedImageData = null; 
        },
        
        // Bookmarks
        fetchBookmarks: async () => {
            const container = document.getElementById('bookmarks-container');
            container.innerHTML = '<div class="text-center text-gray-500 mt-5 pt-10"><i class="fas fa-spinner fa-spin"></i></div>';
            
            try {
                const res = await fetch(`${SERVER_URL}/api/bookmarks/${currentUser.username}`);
                const tweets = await res.json();
                container.innerHTML = '';
                
                if(!tweets || tweets.length === 0) {
                    container.innerHTML = '<div class="text-center text-gray-500 mt-10 text-sm">  .</div>';
                    return;
                }
                
                tweets.forEach(t => renderTweet(t, false, true));
            } catch(e) {
                console.error("   :", e);
                container.innerHTML = '<div class="text-center text-red-500 mt-10 text-xs">   </div>';
            }
        },

        // Report System
        reportSystem: {
            currentTweetId: null,
            currentTweetUsername: null,
            selectedReportCategory: null,
            reportCategories: [
                {
                    id: 'hate',
                    title: '',
                    description: '               '
                },
                {
                    id: 'abuse',
                    title: '    ',
                    description: '       NSFW                 '
                },
                {
                    id: 'violence',
                    title: ' ',
                    description: '           '
                },
                {
                    id: 'privacy',
                    title: ' ',
                    description: '     /                '
                },
                {
                    id: 'illegal',
                    title: '    ',
                    description: '             '
                },
                {
                    id: 'spam',
                    title: '',
                    description: '      '
                },
                {
                    id: 'selfharm',
                    title: '  ',
                    description: '         '
                },
                {
                    id: 'sensitive',
                    title: '   ',
                    description: '                         '
                },
                {
                    id: 'impersonation',
                    title: ' ',
                    description: '        /   '
                },
                {
                    id: 'extremism',
                    title: '   ',
                    description: '       '
                },
                {
                    id: 'integrity',
                    title: ' ',
                    description: '             '
                }
            ]
        },

        openReportModal: function(tweetId, tweetUsername) {
            window.app.reportSystem.currentTweetId = tweetId;
            window.app.reportSystem.currentTweetUsername = tweetUsername;
            window.app.reportSystem.selectedReportCategory = null;
            
            const modal = document.getElementById('report-modal');
            const container = document.getElementById('report-options-container');
            
            container.innerHTML = window.app.reportSystem.reportCategories.map((cat, index) => `
                <div class="report-option" onclick="window.app.selectReportCategory('${cat.id}')" id="report-option-${cat.id}">
                    <div class="radio-circle" id="radio-${cat.id}"></div>
                    <div class="option-text">
                        ${index + 1}. ${cat.title}
                        <div class="option-description">${cat.description}</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('submit-report-btn').disabled = true;
            modal.style.display = 'flex';
            
            document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.remove('show'));
        },

        closeReportModal: function() {
            document.getElementById('report-modal').style.display = 'none';
            window.app.reportSystem.currentTweetId = null;
            window.app.reportSystem.selectedReportCategory = null;
        },

        selectReportCategory: function(categoryId) {
            document.querySelectorAll('.report-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelectorAll('.radio-circle').forEach(radio => {
                radio.classList.remove('selected');
            });
            
            const selectedOption = document.getElementById(`report-option-${categoryId}`);
            const selectedRadio = document.getElementById(`radio-${categoryId}`);
            
            if (selectedOption && selectedRadio) {
                selectedOption.classList.add('selected');
                selectedRadio.classList.add('selected');
                window.app.reportSystem.selectedReportCategory = categoryId;
                
                document.getElementById('submit-report-btn').disabled = false;
            }
        },

        submitReport: async function() {
            if (!window.app.reportSystem.selectedReportCategory || 
                !window.app.reportSystem.currentTweetId) {
                return;
            }
            
            const submitBtn = document.getElementById('submit-report-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span data-i18n="sending">  ...</span>';
            submitBtn.disabled = true;
            
            try {
                const tweetInfo = window.app.getTweetInfo(window.app.reportSystem.currentTweetId);
                
                const success = await window.app.sendReportToAdmin({
                    tweetId: window.app.reportSystem.currentTweetId,
                    tweetContent: tweetInfo.content,
                    tweetUser: tweetInfo.username,
                    reporter: currentUser.username,
                    reporterEmail: currentUser.email || 'user@example.com',
                    category: window.app.reportSystem.selectedReportCategory
                });
                
                if (success) {
                    window.app.closeReportModal();
                    window.app.showSuccessModal(tweetInfo.username);
                    
                    window.app.hideTweetFromTimeline(window.app.reportSystem.currentTweetId);
                } else {
                    throw new Error('   ');
                }
                
            } catch (error) {
                console.error("   :", error);
                alert("   .    .");
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        },

        getTweetInfo: function(tweetId) {
            const tweetElement = document.getElementById(`tweet-${tweetId}`);
            let content = '';
            let username = window.app.reportSystem.currentTweetUsername || 'unknown';
            
            if (tweetElement) {
                const contentEl = tweetElement.querySelector('.text-white.text-\\[15px\\]');
                if (contentEl) {
                    content = contentEl.textContent.substring(0, 300);
                }
                
                const usernameEl = tweetElement.querySelector('.text-gray-500.truncate.text-\\[14px\\]');
                if (usernameEl) {
                    username = usernameEl.textContent.replace('@', '');
                }
            }
            
            return { content, username };
        },

        sendReportToAdmin: async function(reportData) {
            const selectedCategory = window.app.reportSystem.reportCategories.find(
                cat => cat.id === reportData.category
            );
            
            document.getElementById('report-tweet-id').value = reportData.tweetId;
            document.getElementById('report-tweet-content').value = reportData.tweetContent;
            document.getElementById('report-tweet-user').value = reportData.tweetUser;
            document.getElementById('report-reporter').value = reportData.reporter;
            document.getElementById('report-reporter-email').value = reportData.reporterEmail;
            document.getElementById('report-category').value = selectedCategory?.title || reportData.category;
            document.getElementById('report-category-desc').value = selectedCategory?.description || '';
            document.getElementById('report-reported-at').value = new Date().toLocaleString('fa-IR');
            
            document.getElementById('report-email').value = 'Shahriyarjadidi@gmail.com';
            
            const fullMessage = `
    - AJ Sports

  :
  : ${reportData.tweetId}
  : @${reportData.tweetUser}
 : ${reportData.tweetContent}

 :
  : @${reportData.reporter}
 : ${reportData.reporterEmail}

  :
 ${selectedCategory?.title || reportData.category}
 : ${selectedCategory?.description || ''}

  :
${new Date().toLocaleString('fa-IR')}

  :
${window.location.origin}/tweet/${reportData.tweetId}
            `;
            
            document.getElementById('report-message').value = fullMessage;
            
            const form = document.getElementById('report-form');
            
            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const existingReports = JSON.parse(localStorage.getItem(LS_KEYS.REPORTS) || '[]');
                    existingReports.push({
                        tweetId: reportData.tweetId,
                        category: selectedCategory?.title,
                        reportedAt: new Date().toISOString()
                    });
                    localStorage.setItem(LS_KEYS.REPORTS, JSON.stringify(existingReports));
                    
                    return true;
                } else {
                    throw new Error('Formspree response not ok');
                }
            } catch (error) {
                console.error("Formspree error:", error);
                
                const existingReports = JSON.parse(localStorage.getItem('ajsports_reports_pending') || '[]');
                existingReports.push({
                    tweetId: reportData.tweetId,
                    tweetContent: reportData.tweetContent,
                    tweetUser: reportData.tweetUser,
                    reporter: reportData.reporter,
                    category: selectedCategory?.title,
                    reportedAt: new Date().toISOString()
                });
                localStorage.setItem('ajsports_reports_pending', JSON.stringify(existingReports));
                
                return true;
            }
        },

        showSuccessModal: function(tweetUsername) {
            const modal = document.getElementById('success-modal');
            const actionsContainer = document.getElementById('success-actions-container');
            
            actionsContainer.innerHTML = `
                <button class="hide-tweet-btn" onclick="window.app.permanentlyHideTweet('${window.app.reportSystem.currentTweetId}')" data-i18n="hide_tweet">  </button>
                <button class="block-user-btn" onclick="window.app.openBlockConfirmModal('${tweetUsername}')" data-i18n="block_user">  @${tweetUsername}</button>
            `;
            
            modal.style.display = 'flex';
        },

        closeSuccessModal: function() {
            document.getElementById('success-modal').style.display = 'none';
            
            window.app.reportSystem.currentTweetId = null;
            window.app.reportSystem.currentTweetUsername = null;
            window.app.reportSystem.selectedReportCategory = null;
        },

        hideTweetFromTimeline: function(tweetId) {
            const tweetElement = document.getElementById(`tweet-${tweetId}`);
            if (tweetElement) {
                tweetElement.style.opacity = '0.3';
                tweetElement.style.transition = 'opacity 0.3s ease';
                
                const hiddenTweets = JSON.parse(localStorage.getItem(LS_KEYS.HIDDEN_TWEETS) || '[]');
                if (!hiddenTweets.includes(tweetId)) {
                    hiddenTweets.push(tweetId);
                    localStorage.setItem(LS_KEYS.HIDDEN_TWEETS, JSON.stringify(hiddenTweets));
                }
            }
        },

        permanentlyHideTweet: function(tweetId) {
            const tweetElement = document.getElementById(`tweet-${tweetId}`);
            if (tweetElement) {
                tweetElement.style.display = 'none';
                
                const permanentlyHidden = JSON.parse(localStorage.getItem(LS_KEYS.PERMANENTLY_HIDDEN_TWEETS) || '[]');
                if (!permanentlyHidden.includes(tweetId)) {
                    permanentlyHidden.push(tweetId);
                    localStorage.setItem(LS_KEYS.PERMANENTLY_HIDDEN_TWEETS, JSON.stringify(permanentlyHidden));
                }
                
                alert('         .');
            }
        },

        // Block System Integration
        blockSystem: blockSystem,

        openBlockConfirmModal: function(username) {
            blockSystem.currentBlockTarget = username;
            
            const modal = document.getElementById('block-confirm-modal');
            const message = document.getElementById('block-confirm-message');
            const usernameDisplay = document.getElementById('block-username-display');
            
            usernameDisplay.textContent = '@' + username;
            message.innerHTML = `     <strong>@${username}</strong>   `;
            
            const confirmBtn = document.getElementById('confirm-block-btn');
            confirmBtn.onclick = () => window.app.confirmBlockUser(username);
            
            modal.style.display = 'flex';
        },

        closeBlockConfirmModal: function() {
            document.getElementById('block-confirm-modal').style.display = 'none';
            blockSystem.currentBlockTarget = null;
        },

        blockUser: async function(username) {
            if (!currentUser?.username || !username) {
                showNotificationToast('  ');
                return { success: false };
            }
            
            try {
                const response = await fetch(`${SERVER_URL}/api/blocks/block`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        blockerUsername: currentUser.username,
                        blockedUsername: username
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    await blockSystem.fetchBlockedUsers(true);
                    
                    blockSystem.hideBlockedUserContent(username);
                    
                    if (window._profileCache) {
                        delete window._profileCache[username];
                    }
                    
                    const profileView = document.getElementById('user-profile-view');
                    if (!profileView.classList.contains('hidden-content')) {
                        const currentUserInProfile = document.getElementById('profile-view-handle')?.innerText.replace('@', '');
                        
                        if (currentUserInProfile === username) {
                            const existingNotice = profileView.querySelector('.blocked-user-notice');
                            if (existingNotice) existingNotice.remove();
                            
                            await window.app.openProfile(username);
                        }
                    }
                    
                    document.querySelectorAll(`.dropdown-menu`).forEach(menu => {
                        const unblockOption = menu.querySelector('.dropdown-item[onclick*="unblockUser"]');
                        const reportOption = menu.querySelector('.dropdown-item.report');
                        
                        if (unblockOption && menu.closest('.tweet-card')) {
                            const tweetCard = menu.closest('.tweet-card');
                            const tweetUsername = tweetCard.querySelector('.text-gray-500.truncate.text-\\[14px\\]')?.textContent.replace('@', '');
                            
                            if (tweetUsername === username) {
                                unblockOption.remove();
                                
                                if (reportOption) {
                                    reportOption.insertAdjacentHTML('afterend', `
                                        <div class="dropdown-item block" onclick="event.stopPropagation(); window.app.openBlockConfirmModal('${username}')">
                                            <i class="fas fa-user-slash w-5" style="color: #f4212e;"></i>  
                                        </div>
                                    `);
                                }
                            }
                        }
                    });
                    
                    showNotificationToast(` @${username}  `);
                    return { success: true };
                    
                } else {
                    showNotificationToast(` ${data.error || '   '}`);
                    return { success: false };
                }
            } catch (error) {
                console.error(" Block error:", error);
                showNotificationToast('     ');
                return { success: false };
            }
        },

        unblockUser: async function(username) {
            if (!currentUser?.username || !username) {
                showNotificationToast('  ');
                return { success: false };
            }
            
            try {
                const response = await fetch(`${SERVER_URL}/api/blocks/unblock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        blockerUsername: currentUser.username,
                        blockedUsername: username
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    blockSystem._blockedCache.delete(username);
                    await blockSystem.fetchBlockedUsers(true);
                    
                    document.querySelectorAll('.tweet-card, .story-item, .search-result, [class*="search"] .flex.items-center.gap-3').forEach(el => {
                        const usernameEl = el.querySelector('.text-gray-500.truncate.text-\\[14px\\], .story-username, .text-gray-500.text-xs, .text-gray-500.text-\\[12px\\]');
                        if (usernameEl && usernameEl.textContent.includes(`@${username}`)) {
                            el.style.display = '';
                            el.style.opacity = '1';
                            el.classList.remove('hidden');
                        }
                    });
                    
                    const profileView = document.getElementById('user-profile-view');
                    if (!profileView.classList.contains('hidden-content')) {
                        const currentUserInProfile = document.getElementById('profile-view-handle')?.innerText.replace('@', '');
                        
                        const existingNotice = profileView.querySelector('.blocked-user-notice');
                        if (existingNotice) existingNotice.remove();
                        
                        await window.app.openProfile(currentUserInProfile);
                    }
                    
                    if (window._profileCache) {
                        delete window._profileCache[username];
                    }
                    
                    document.querySelectorAll(`.dropdown-menu`).forEach(menu => {
                        const blockOption = menu.querySelector('.dropdown-item.block');
                        const reportOption = menu.querySelector('.dropdown-item.report');
                        
                        if (blockOption && menu.closest('.tweet-card')) {
                            const tweetCard = menu.closest('.tweet-card');
                            const tweetUsername = tweetCard.querySelector('.text-gray-500.truncate.text-\\[14px\\]')?.textContent.replace('@', '');
                            
                            if (tweetUsername === username) {
                                blockOption.remove();
                                
                                if (reportOption) {
                                    reportOption.insertAdjacentHTML('afterend', `
                                        <div class="dropdown-item" onclick="event.stopPropagation(); window.app.unblockUser('${username}')">
                                            <i class="fas fa-user-check w-5" style="color: #00ba7c;"></i>  
                                        </div>
                                    `);
                                }
                            }
                        }
                    });
                    
                    showNotificationToast(` @${username}  `);
                    return { success: true };
                    
                } else {
                    showNotificationToast(` ${data.error || '   '}`);
                    return { success: false };
                }
            } catch (error) {
                console.error(" Unblock error:", error);
                showNotificationToast('     ');
                return { success: false };
            }
        },

        confirmBlockUser: async function(username) {
            if (!username) return;
            
            const result = await blockSystem.blockUser(username);
            
            if (result.success) {
                blockSystem.hideBlockedUserContent(username);
                
                showNotificationToast(` @${username}    .`);
                window.app.closeBlockConfirmModal();
                
                const profileView = document.getElementById('user-profile-view');
                if (!profileView.classList.contains('hidden-content')) {
                    const currentProfileUser = document.getElementById('profile-view-handle')?.innerText.replace('@', '');
                    if (currentProfileUser === username) {
                        window.app.goBackFromProfile();
                    }
                }
            } else {
                showNotificationToast(result.error || "   ");
                window.app.closeBlockConfirmModal();
            }
        },

        // Settings & Privacy
        openAccountSettings: function() {
            window.app.toggleDrawer();
            
            const modal = document.createElement('div');
            modal.id = 'settings-modal';
            modal.className = 'fixed inset-0 z-[10000] bg-black flex flex-col overflow-y-auto';
            modal.innerHTML = `
                <div class="sticky top-0 bg-black border-b border-x-line z-10">
                    <div class="flex items-center px-4 h-[54px]">
                        <button onclick="window.app.closeSettingsModal()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-white">
                            <i class="fas fa-arrow-right text-lg"></i>
                        </button>
                        <div class="flex-1 text-center font-bold text-white">
                               
                        </div>
                        <div class="w-10"></div>
                    </div>
                </div>
                
                <div class="p-4 space-y-4">
                    <div class="bg-[#16181c] rounded-xl overflow-hidden">
                        <div onclick="window.app.openAccountInfo()" class="flex items-center gap-3 p-4 cursor-pointer hover:bg-white/5 transition">
                            <div class="w-10 h-10 rounded-full bg-x-blue/20 flex items-center justify-center text-x-blue">
                                <i class="fas fa-id-card text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white text-base">  </div>
                                <div class="text-gray-500 text-xs mt-1">                 .</div>
                            </div>
                            <i class="fas fa-chevron-left text-gray-500"></i>
                        </div>
                    </div>
                    
                    <div class="bg-[#16181c] rounded-xl overflow-hidden">
                        <div onclick="window.app.openDeactivation()" class="flex items-center gap-3 p-4 cursor-pointer hover:bg-white/5 transition">
                            <div class="w-10 h-10 rounded-full bg-red-500/20 flex items-center justify-center text-red-500">
                                <i class="fas fa-user-slash text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white text-base">    </div>
                                <div class="text-gray-500 text-xs mt-1">        .</div>
                            </div>
                            <i class="fas fa-chevron-left text-gray-500"></i>
                        </div>
                    </div>
                    
                    <div class="bg-[#16181c] rounded-xl overflow-hidden">
                        <div onclick="window.app.openLanguageSettingsNew()" class="flex items-center gap-3 p-4 cursor-pointer hover:bg-white/5 transition">
                            <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-500">
                                <i class="fas fa-language text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white text-base"></div>
                                <div class="text-gray-500 text-xs mt-1">           Ajsports  .</div>
                            </div>
                            <i class="fas fa-chevron-left text-gray-500"></i>
                        </div>
                    </div>
                    
                    <div class="bg-[#16181c] rounded-xl overflow-hidden">
                        <div onclick="window.app.openActiveSessions()" class="flex items-center gap-3 p-4 cursor-pointer hover:bg-white/5 transition">
                            <div class="w-10 h-10 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-500">
                                <i class="fas fa-shield-alt text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white text-base">     </div>
                                <div class="text-gray-500 text-xs mt-1">            .</div>
                            </div>
                            <i class="fas fa-chevron-left text-gray-500"></i>
                        </div>
                    </div>
                    
                    <div class="bg-[#16181c] rounded-xl overflow-hidden">
                        <div onclick="window.app.openPrivacyCenter()" class="flex items-center gap-3 p-4 cursor-pointer hover:bg-white/5 transition">
                            <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-500">
                                <i class="fas fa-lock text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white text-base">   </div>
                                <div class="text-gray-500 text-xs mt-1">       </div>
                            </div>
                            <i class="fas fa-chevron-left text-gray-500"></i>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        },

        closeSettingsModal: function() {
            const modal = document.getElementById('settings-modal');
            if (modal) modal.remove();
        },

        openAccountInfo: async function() {
            window.app.closeSettingsModal();
            
            const modal = document.createElement('div');
            modal.id = 'account-info-modal';
            modal.className = 'fixed inset-0 z-[10000] bg-black flex flex-col overflow-y-auto';
            
            try {
                const response = await fetch(`${SERVER_URL}/api/settings/account/${currentUser.username}`);
                const accountData = await response.json();
                
                modal.innerHTML = `
                    <div class="sticky top-0 bg-black border-b border-x-line z-10">
                        <div class="flex items-center px-4 h-[54px]">
                            <button onclick="window.app.closeAccountInfoModal()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-white">
                                <i class="fas fa-arrow-right text-lg"></i>
                            </button>
                            <div class="flex-1 text-center font-bold text-white">
                                  
                            </div>
                            <div class="w-10"></div>
                        </div>
                    </div>
                    
                    <div class="p-6 space-y-6">
                        <div class="flex flex-col items-center">
                            <img src="${accountData.avatar_url || 'https://via.placeholder.com/100'}" 
                                 class="w-24 h-24 rounded-full border-2 border-x-blue object-cover" loading="lazy">
                            <h3 class="font-bold text-white text-xl mt-3">${accountData.display_name || accountData.username}</h3>
                        </div>
                        
                        <div class="bg-[#16181c] rounded-xl p-4 space-y-4">
                            <div>
                                <div class="text-gray-500 text-xs mb-1"></div>
                                <div class="text-white font-mono">@${accountData.username}</div>
                            </div>
                            <div class="border-t border-white/10 my-2"></div>
                            <div>
                                <div class="text-gray-500 text-xs mb-1"></div>
                                <div class="text-white">${accountData.email || ' '}</div>
                            </div>
                            <div class="border-t border-white/10 my-2"></div>
                            <div>
                                <div class="text-gray-500 text-xs mb-1"></div>
                                <div class="text-white flex items-center gap-2">
                                    <span class="fi fi-${accountData.country_code?.toLowerCase() || 'ir'}"></span>
                                    ${accountData.country_name || ''}
                                </div>
                            </div>
                            <div class="border-t border-white/10 my-2"></div>
                            <div>
                                <div class="text-gray-500 text-xs mb-1">IP </div>
                                <div class="text-white text-sm font-mono">${accountData.registered_ip || ''}</div>
                            </div>
                            <div class="border-t border-white/10 my-2"></div>
                            <div>
                                <div class="text-gray-500 text-xs mb-1"> </div>
                                <div class="text-white">${new Date(accountData.created_at).toLocaleDateString('fa-IR')}</div>
                            </div>
                            <div class="border-t border-white/10 my-2"></div>
                            <div>
                                <div class="text-gray-500 text-xs mb-1"> </div>
                                <div class="text-white">${window.app.formatTimeAgo(new Date(accountData.last_active))}</div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error(" Error loading account info:", error);
                modal.innerHTML = `
                    <div class="sticky top-0 bg-black border-b border-x-line z-10">
                        <div class="flex items-center px-4 h-[54px]">
                            <button onclick="window.app.closeAccountInfoModal()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-white">
                                <i class="fas fa-arrow-right text-lg"></i>
                            </button>
                            <div class="flex-1 text-center font-bold text-white">
                                  
                            </div>
                            <div class="w-10"></div>
                        </div>
                    </div>
                    <div class="flex-1 flex items-center justify-center p-6">
                        <div class="text-center text-gray-500">
                            <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                            <p>   </p>
                            <button onclick="window.app.openAccountInfo()" class="mt-4 px-4 py-2 bg-x-blue rounded-full text-sm text-white">
                                 
                            </button>
                        </div>
                    </div>
                `;
            }
            
            document.body.appendChild(modal);
        },

        closeAccountInfoModal: function() {
            const modal = document.getElementById('account-info-modal');
            if (modal) modal.remove();
            window.app.openAccountSettings();
        },

        openDeactivation: function() {
            window.app.closeSettingsModal();
            
            const modal = document.createElement('div');
            modal.id = 'deactivation-modal';
            modal.className = 'fixed inset-0 z-[10000] bg-black flex flex-col overflow-y-auto';
            
            modal.innerHTML = `
                <div class="sticky top-0 bg-black border-b border-x-line z-10">
                    <div class="flex items-center px-4 h-[54px]">
                        <button onclick="window.app.closeDeactivationModal()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-white">
                            <i class="fas fa-arrow-right text-lg"></i>
                        </button>
                        <div class="flex-1 text-center font-bold text-white">
                              
                        </div>
                        <div class="w-10"></div>
                    </div>
                </div>
                
                <div class="p-6 flex flex-col items-center">
                    <img src="${currentUser.avatar_url || 'https://via.placeholder.com/100'}" 
                         class="w-20 h-20 rounded-full border-2 border-red-500/50 object-cover" loading="lazy">
                    <div class="text-white font-bold text-lg mt-3">@${currentUser.username}</div>
                    
                    <div class="bg-[#16181c] rounded-xl p-5 mt-6 text-right w-full">
                        <p class="text-white text-sm leading-6 mb-4">
                                          .
                        </p>
                        <p class="text-white text-sm leading-6 mb-4">
                              <span class="text-x-blue font-bold"> </span>             .
                        </p>
                        <p class="text-white text-sm leading-6 mb-4">
                                                    .
                        </p>
                        <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-3 mt-2">
                            <p class="text-red-400 text-xs flex items-center gap-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                    .     .
                            </p>
                        </div>
                    </div>
                    
                    <button onclick="window.app.sendDeactivationOTP()" 
                            class="w-full bg-red-600 text-white font-bold py-4 rounded-xl mt-6 hover:bg-red-700 transition">
                        
                    </button>
                </div>
            `;
            
            document.body.appendChild(modal);
        },

        closeDeactivationModal: function() {
            const modal = document.getElementById('deactivation-modal');
            if (modal) modal.remove();
            window.app.openAccountSettings();
        },

        sendDeactivationOTP: async function() {
            const modal = document.getElementById('deactivation-modal');
            if (!modal) return;
            
            const content = modal.querySelector('.p-6');
            if (!content) return;
            
            content.innerHTML = `
                <div class="text-center py-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <div class="text-white">       ...</div>
                </div>
            `;
            
            try {
                const response = await fetch(`${SERVER_URL}/api/settings/deactivation/send-otp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser.username,
                        email: currentUser.email
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.app.showOTPVerificationForDeactivation();
                } else {
                    throw new Error(data.error || '   ');
                }
                
            } catch (error) {
                console.error(" OTP send error:", error);
                content.innerHTML = `
                    <div class="text-center text-red-500 py-8">
                        <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                        <p>    </p>
                        <button onclick="window.app.openDeactivation()" 
                                class="mt-4 px-4 py-2 bg-x-blue rounded-full text-sm text-white">
                            
                        </button>
                    </div>
                `;
            }
        },

        showOTPVerificationForDeactivation: function() {
            const modal = document.getElementById('deactivation-modal');
            if (!modal) return;
            
            const content = modal.querySelector('.p-6');
            if (!content) return;
            
            content.innerHTML = `
                <div class="text-center">
                    <div class="w-16 h-16 rounded-full bg-red-500/20 flex items-center justify-center text-red-500 mx-auto mb-4">
                        <i class="fas fa-envelope text-2xl"></i>
                    </div>
                    <h3 class="font-bold text-white text-lg mb-2">   </h3>
                    <p class="text-gray-400 text-sm mb-6">          </p>
                    
                    <div class="otp-boxes flex justify-center gap-2 mb-6" id="deactivation-otp-boxes">
                        <input type="tel" maxlength="1" class="otp-box w-12 h-14 text-center text-xl font-bold" id="dotp1" data-next="dotp2">
                        <input type="tel" maxlength="1" class="otp-box w-12 h-14 text-center text-xl font-bold" id="dotp2" data-next="dotp3" data-prev="dotp1">
                        <input type="tel" maxlength="1" class="otp-box w-12 h-14 text-center text-xl font-bold" id="dotp3" data-next="dotp4" data-prev="dotp2">
                        <input type="tel" maxlength="1" class="otp-box w-12 h-14 text-center text-xl font-bold" id="dotp4" data-next="dotp5" data-prev="dotp3">
                        <input type="tel" maxlength="1" class="otp-box w-12 h-14 text-center text-xl font-bold" id="dotp5" data-next="dotp6" data-prev="dotp4">
                        <input type="tel" maxlength="1" class="otp-box w-12 h-14 text-center text-xl font-bold" id="dotp6" data-prev="dotp5">
                    </div>
                    
                    <div id="otp-error" class="text-red-500 text-xs mb-4 min-h-[20px]"></div>
                    
                    <button onclick="window.app.verifyDeactivationOTP()" 
                            class="w-full bg-red-600 text-white font-bold py-4 rounded-xl hover:bg-red-700 transition">
                          
                    </button>
                    
                    <button onclick="window.app.openDeactivation()" 
                            class="w-full bg-transparent border border-x-line text-gray-400 font-bold py-3 rounded-xl mt-3 hover:bg-white/5 transition">
                        
                    </button>
                </div>
            `;
            
            setTimeout(() => {
                document.querySelectorAll('#deactivation-otp-boxes .otp-box').forEach(box => {
                    box.addEventListener('input', (e) => {
                        if (e.target.value.length === 1) {
                            e.target.classList.add('filled');
                            const next = document.getElementById(e.target.dataset.next);
                            if (next) setTimeout(() => next.focus(), 10);
                        }
                    });
                    
                    box.addEventListener('keydown', (e) => {
                        if (e.key === 'Backspace' && e.target.value === '') {
                            e.target.classList.remove('filled');
                            const prev = document.getElementById(e.target.dataset.prev);
                            if (prev) {
                                prev.focus();
                                prev.value = '';
                                prev.classList.remove('filled');
                            }
                            e.preventDefault();
                        }
                    });
                });
            }, 100);
        },

        verifyDeactivationOTP: async function() {
            const otp = Array.from(document.querySelectorAll('#deactivation-otp-boxes .otp-box'))
                             .map(i => i.value).join('');
            
            if (otp.length !== 6) {
                document.getElementById('otp-error').innerText = '    ';
                return;
            }
            
            const verifyBtn = document.querySelector('#deactivation-modal button[onclick*="verifyDeactivationOTP"]');
            if (verifyBtn) {
                verifyBtn.disabled = true;
                verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>   ...';
            }
            
            try {
                const response = await fetch(`${SERVER_URL}/api/settings/deactivation/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser.username,
                        otp: otp
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.app.showDeactivationSuccess();
                } else {
                    document.getElementById('otp-error').innerText = data.error || '  ';
                    if (verifyBtn) {
                        verifyBtn.disabled = false;
                        verifyBtn.innerHTML = '  ';
                    }
                }
                
            } catch (error) {
                console.error(" Verify error:", error);
                document.getElementById('otp-error').innerText = '    ';
                if (verifyBtn) {
                    verifyBtn.disabled = false;
                    verifyBtn.innerHTML = '  ';
                }
            }
        },

        showDeactivationSuccess: function() {
            const modal = document.getElementById('deactivation-modal');
            if (!modal) return;
            
            const content = modal.querySelector('.p-6');
            if (!content) return;
            
            content.innerHTML = `
                <div class="text-center py-6">
                    <div class="w-20 h-20 rounded-full bg-green-500/20 flex items-center justify-center text-green-500 mx-auto mb-4">
                        <i class="fas fa-check text-4xl"></i>
                    </div>
                    <h3 class="font-bold text-white text-xl mb-2">   </h3>
                    <p class="text-gray-400 text-sm mb-4">
                                     .
                    </p>
                    <p class="text-gray-500 text-xs mb-6">
                                   .
                    </p>
                    <div class="bg-[#16181c] rounded-lg p-4 mb-6">
                        <p class="text-gray-300 text-sm text-right">
                            <span class="text-x-blue"></span>       .<br>
                            <span class="text-x-blue"></span>          .
                        </p>
                    </div>
                    <button onclick="window.app.logout()" 
                            class="w-full bg-x-blue text-white font-bold py-4 rounded-xl hover:bg-blue-600 transition">
                           
                    </button>
                </div>
            `;
            
            setTimeout(() => {
                window.app.logout();
            }, 3000);
        },

        openLanguageSettingsNew: function() {
            window.app.closeSettingsModal();
            window.app.openLanguageModal();
        },

        openActiveSessions: async function() {
            window.app.closeSettingsModal();
            
            const modal = document.createElement('div');
            modal.id = 'sessions-modal';
            modal.className = 'fixed inset-0 z-[10000] bg-black flex flex-col overflow-y-auto';
            
            modal.innerHTML = `
                <div class="sticky top-0 bg-black border-b border-x-line z-10">
                    <div class="flex items-center px-4 h-[54px]">
                        <button onclick="window.app.closeSessionsModal()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-white">
                            <i class="fas fa-arrow-right text-lg"></i>
                        </button>
                        <div class="flex-1 text-center font-bold text-white">
                             
                        </div>
                        <div class="w-10"></div>
                    </div>
                </div>
                
                <div class="p-4" id="sessions-list">
                    <div class="flex justify-center py-8">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            try {
                const response = await fetch(`${SERVER_URL}/api/settings/sessions/${currentUser.username}`);
                const data = await response.json();
                
                if (data.success) {
                    window.app.renderSessionsList(data.sessions);
                } else {
                    throw new Error('   ');
                }
                
            } catch (error) {
                console.error(" Sessions error:", error);
                const list = document.getElementById('sessions-list');
                if (list) {
                    list.innerHTML = `
                        <div class="text-center text-red-500 py-8">
                            <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                            <p>    </p>
                        </div>
                    `;
                }
            }
        },

        renderSessionsList: function(sessions) {
            const container = document.getElementById('sessions-list');
            if (!container) return;
            
            if (!sessions || sessions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-laptop text-3xl mb-3"></i>
                        <p>    </p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            sessions.forEach(session => {
                const deviceInfo = session.device_info || {};
                const deviceName = deviceInfo.browser || deviceInfo.os || deviceInfo.device || ' ';
                const location = session.city ? `${session.city}, ${session.country_name}` : session.country_name || '';
                const timeAgo = window.app.formatTimeAgo(new Date(session.last_activity));
                
                const isCurrent = session.is_current_session;
                
                html += `
                    <div class="bg-[#16181c] rounded-xl p-4 mb-3 ${isCurrent ? 'border border-x-blue' : ''}">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-full bg-x-blue/20 flex items-center justify-center text-x-blue">
                                <i class="fas ${deviceInfo.mobile ? 'fa-mobile-alt' : 'fa-laptop'} text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-white">${deviceName}</span>
                                    ${isCurrent ? '<span class="text-xs bg-x-blue text-white px-2 py-0.5 rounded-full"> </span>' : ''}
                                </div>
                                <div class="text-gray-400 text-xs mt-1">
                                    <div>IP: ${session.ip_address || ''}</div>
                                    <div>${location}</div>
                                    <div> : ${timeAgo}</div>
                                </div>
                            </div>
                            ${!isCurrent ? `
                                <button onclick="window.app.terminateSession(${session.id})" 
                                        class="px-3 py-1.5 bg-red-500/20 text-red-500 text-xs rounded-full hover:bg-red-500/30 transition">
                                    
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            if (sessions.length > 1) {
                html += `
                    <button onclick="window.app.terminateAllSessions()" 
                            class="w-full bg-yellow-500/20 text-yellow-500 font-bold py-3 rounded-xl mt-4 hover:bg-yellow-500/30 transition">
                            
                    </button>
                `;
            }
            
            container.innerHTML = html;
        },

        terminateSession: async function(sessionId) {
            if (!confirm('       ')) return;
            
            try {
                const response = await fetch(`${SERVER_URL}/api/settings/sessions/terminate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser.username,
                        session_id: sessionId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.is_current_session) {
                        window.app.logout();
                    } else {
                        window.app.openActiveSessions();
                    }
                } else {
                    alert(data.error || '    ');
                }
                
            } catch (error) {
                console.error(" Terminate session error:", error);
                alert('    ');
            }
        },

        terminateAllSessions: async function() {
            if (!confirm('        ')) return;
            
            try {
                const response = await fetch(`${SERVER_URL}/api/settings/sessions/terminate-all`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: currentUser.username
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    window.app.openActiveSessions();
                } else {
                    alert(data.error || '    ');
                }
                
            } catch (error) {
                console.error(" Terminate all error:", error);
                alert('    ');
            }
        },

        closeSessionsModal: function() {
            const modal = document.getElementById('sessions-modal');
            if (modal) modal.remove();
            window.app.openAccountSettings();
        },

        openPrivacyCenter: function() {
            window.app.closeSettingsModal();
            
            const modal = document.createElement('div');
            modal.id = 'privacy-modal';
            modal.className = 'fixed inset-0 z-[10000] bg-black flex flex-col overflow-y-auto';
            
            modal.innerHTML = `
                <div class="sticky top-0 bg-black border-b border-x-line z-10">
                    <div class="flex items-center px-4 h-[54px]">
                        <button onclick="window.app.closePrivacyModal()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-white">
                            <i class="fas fa-arrow-right text-lg"></i>
                        </button>
                        <div class="flex-1 text-center font-bold text-white">
                               
                        </div>
                        <div class="w-10"></div>
                    </div>
                </div>
                
                <div class="p-4 space-y-4">
                    <div class="bg-[#16181c] rounded-xl overflow-hidden">
                        <div onclick="window.app.openPrivacyCenterDetail()" class="flex items-center gap-3 p-4 cursor-pointer hover:bg-white/5 transition">
                            <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-500">
                                <i class="fas fa-shield-alt text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white text-base">  </div>
                                <div class="text-gray-500 text-xs mt-1">           </div>
                            </div>
                            <i class="fas fa-chevron-left text-gray-500"></i>
                        </div>
                    </div>
                    
                    <div class="bg-[#16181c] rounded-xl overflow-hidden">
                        <div onclick="window.app.openPrivacyPolicyDetail()" class="flex items-center gap-3 p-4 cursor-pointer hover:bg-white/5 transition">
                            <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-500">
                                <i class="fas fa-file-contract text-lg"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-white text-base">    </div>
                                <div class="text-gray-500 text-xs mt-1">        </div>
                            </div>
                            <i class="fas fa-chevron-left text-gray-500"></i>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        },

        closePrivacyModal: function() {
            const modal = document.getElementById('privacy-modal');
            if (modal) modal.remove();
            window.app.openAccountSettings();
        },

        openPrivacyCenterDetail: function() {
            window.app.closePrivacyModal();
            
            const modal = document.createElement('div');
            modal.id = 'privacy-center-modal';
            modal.className = 'fixed inset-0 z-[10000] bg-black flex flex-col overflow-y-auto';
            
            modal.innerHTML = `
                <div class="sticky top-0 bg-black border-b border-x-line z-10">
                    <div class="flex items-center px-4 h-[54px]">
                        <button onclick="window.app.closePrivacyCenterModal()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-white">
                            <i class="fas fa-arrow-right text-lg"></i>
                        </button>
                        <div class="flex-1 text-center font-bold text-white">
                              
                        </div>
                        <div class="w-10"></div>
                    </div>
                </div>
                
                <div class="p-5 text-white leading-relaxed space-y-4" style="direction: rtl;">
                    <h2 class="font-bold text-xl mb-4 text-x-blue">    AJ Sports</h2>
                    
                    <div class="bg-[#16181c] rounded-xl p-5 space-y-4">
                        <p class="text-sm">
                            <span class="font-bold text-x-blue">AJ Sports</span>                         .
                        </p>
                        
                        <div class="border-t border-white/10 my-2"></div>
                        
                        <h3 class="font-bold text-base">   </h3>
                        <p class="text-sm text-gray-300">
                                (   )<br>
                                 (IP    )<br>
                                  (  )<br>
                                  ( )
                        </p>
                        
                        <h3 class="font-bold text-base mt-2">     </h3>
                        <p class="text-sm text-gray-300">
                                     (SSL/TLS)<br>
                                     <br>
                                         <br>
                                      
                        </p>
                        
                        <h3 class="font-bold text-base mt-2">  </h3>
                        <p class="text-sm text-gray-300">
                                       <br>
                                    visibility   <br>
                                         
                        </p>
                        
                        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3 mt-3">
                            <p class="text-yellow-400 text-xs flex items-start gap-2">
                                <i class="fas fa-info-circle mt-0.5"></i>
                                <span>                      .</span>
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        },

        closePrivacyCenterModal: function() {
            const modal = document.getElementById('privacy-center-modal');
            if (modal) modal.remove();
            window.app.openPrivacyCenter();
        },

        openPrivacyPolicyDetail: function() {
            window.app.closePrivacyModal();
            
            const modal = document.createElement('div');
            modal.id = 'privacy-policy-modal';
            modal.className = 'fixed inset-0 z-[10000] bg-black flex flex-col overflow-y-auto';
            
            modal.innerHTML = `
                <div class="sticky top-0 bg-black border-b border-x-line z-10">
                    <div class="flex items-center px-4 h-[54px]">
                        <button onclick="window.app.closePrivacyPolicyModal()" class="w-10 h-10 rounded-full hover:bg-white/10 flex items-center justify-center text-white">
                            <i class="fas fa-arrow-right text-lg"></i>
                        </button>
                        <div class="flex-1 text-center font-bold text-white">
                              
                        </div>
                        <div class="w-10"></div>
                    </div>
                </div>
                
                <div class="p-5 text-white leading-relaxed space-y-4" style="direction: rtl;">
                    <h2 class="font-bold text-xl mb-4 text-x-blue">   AJ Sports</h2>
                    
                    <div class="bg-[#16181c] rounded-xl p-5 space-y-4 text-sm">
                        <p><span class="font-bold">  :</span>  </p>
                        
                        <h3 class="font-bold text-base">. </h3>
                        <p class="text-gray-300">
                             AJ Sports  .               .            .
                        </p>
                        
                        <h3 class="font-bold text-base">.    </h3>
                        <p class="text-gray-300">
                            <span class="font-bold">.  :</span>    AJ Sports             .<br>
                            <span class="font-bold">.  :</span>        IP            .<br>
                            <span class="font-bold">.  :</span>            .
                        </p>
                        
                        <h3 class="font-bold text-base">.    </h3>
                        <p class="text-gray-300">
                                 AJ Sports<br>
                               <br>
                                    <br>
                                 <br>
                                  
                        </p>
                        
                        <h3 class="font-bold text-base">.  </h3>
                        <p class="text-gray-300">
                                         :<br>
                                <br>
                                    <br>
                                    AJ Sports   
                        </p>
                        
                        <h3 class="font-bold text-base">.  </h3>
                        <p class="text-gray-300">
                                              .          .
                        </p>
                        
                        <h3 class="font-bold text-base">.  </h3>
                        <p class="text-gray-300">
                              :<br>
                                  <br>
                                  <br>
                                   <br>
                                     
                        </p>
                        
                        <h3 class="font-bold text-base">.  </h3>
                        <p class="text-gray-300">
                                              .                    .
                        </p>
                        
                        <h3 class="font-bold text-base">.   </h3>
                        <p class="text-gray-300">
                                   .              .
                        </p>
                        
                        <h3 class="font-bold text-base">.   </h3>
                        <p class="text-gray-300">
                                           privacy@ajsports.ir    .
                        </p>
                        
                        <div class="bg-x-blue/10 border border-x-blue/30 rounded-lg p-3 mt-3">
                            <p class="text-x-blue text-xs">
                                <i class="fas fa-check-circle ml-1"></i>
                                   AJ Sports          .
                            </p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        },

        closePrivacyPolicyModal: function() {
            const modal = document.getElementById('privacy-policy-modal');
            if (modal) modal.remove();
            window.app.openPrivacyCenter();
        },

        formatTimeAgo: function(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return ' ';
            if (diff < 3600) return `${Math.floor(diff / 60)}  `;
            if (diff < 86400) return `${Math.floor(diff / 3600)}  `;
            if (diff < 2592000) return `${Math.floor(diff / 86400)}  `;
            return date.toLocaleDateString('fa-IR');
        }
    };

    // ============================================================================
    //       ( )
    // ============================================================================
    async function renderTweet(t, prepend = false, isBookmark = false, context = 'feed') {
        if(!t || !t.username) return null;
        
        let container;
        if (context === 'profile') {
            container = document.getElementById('profile-tweets-container');
        } else if (isBookmark) {
            container = document.getElementById('bookmarks-container');
        } else {
            container = document.getElementById('tweets-container');
        }
        
        if (!container) return null;
        
        const fragment = document.createDocumentFragment();
        const div = document.createElement('div');
        div.className = 'tweet-card';
        div.id = `tweet-${t.id}`;
        
        let timeAgo = '';
        if(t.created_at) {
            const diff = Math.floor((new Date() - new Date(t.created_at)) / 60000);
            if(diff > 0 && diff < 60) timeAgo = `${diff} `;
            else if(diff >= 60 && diff < 1440) timeAgo = `${Math.floor(diff/60)} `;
            else if(diff >= 1440) timeAgo = `${Math.floor(diff/1440)} `;
        }
        const displayName = t.display_name || t.username;
        
        const isOwner = (() => {
            if (context === 'profile' && t.username === currentUser?.username) return true;
            if (context === 'feed' && t.username === currentUser?.username) return true;
            if (isBookmark && t.username === currentUser?.username) return true;
            if (t.is_owner === true) return true;
            return false;
        })();
        
        const isBlocked = await blockSystem.isUserBlocked(t.username);
        
        const likeClass = t.has_liked ? 'liked' : '';
        const bookmarkClass = t.has_bookmarked ? 'bookmarked' : '';
        
        let verificationBadge = '';
        if(t.verification === 'gold') {
            verificationBadge = '<img src="https://upload.wikimedia.org/wikipedia/commons/8/81/Twitter_Verified_Badge_Gold.svg" class="verification-badge gold" alt="Verified Gold" loading="lazy">';
        } else if(t.verification === 'blue') {
            verificationBadge = '<img src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg" class="verification-badge blue" alt="Verified Blue" loading="lazy">';
        }
        
        let dropdownHtml = `<div class="dropdown-item" onclick="event.stopPropagation(); window.app.toggleBookmark('${t.id}')">
            <i class="far fa-bookmark w-5"></i> 
        </div>`;
        
        if (!isOwner) {
            dropdownHtml += `<div class="dropdown-item report" onclick="event.stopPropagation(); window.app.openReportModal('${t.id}', '${t.username}')">
                <i class="fas fa-flag w-5" style="color: #f4212e;"></i>  
            </div>`;
            
            if (isBlocked) {
                dropdownHtml += `<div class="dropdown-item" onclick="event.stopPropagation(); window.app.unblockUser('${t.username}')">
                    <i class="fas fa-user-check w-5" style="color: #00ba7c;"></i>  
                </div>`;
            } else {
                dropdownHtml += `<div class="dropdown-item block" onclick="event.stopPropagation(); window.app.openBlockConfirmModal('${t.username}')">
                    <i class="fas fa-user-slash w-5" style="color: #f4212e;"></i>  
                </div>`;
            }
        }
        
        if (isOwner) {
            dropdownHtml += `<div class="dropdown-item delete" onclick="event.stopPropagation(); window.app.deleteTweet('${t.id}')">
                <i class="far fa-trash-alt w-5"></i>  
            </div>`;
        }

        const userHasStory = currentStories && currentStories.some(s => 
            s.username === t.username && s.stories && s.stories.length > 0
        );
        
        let avatarHtml;
        if (userHasStory) {
            avatarHtml = `
                <div class="tweet-avatar-with-story cursor-pointer" onclick="event.stopPropagation(); window.app.openProfile('${t.username}')">
                    <div class="story-indicator">
                        <img src="${t.avatar_url || 'https://via.placeholder.com/40'}" 
                             alt="${displayName}"
                             style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">
                    </div>
                </div>
            `;
        } else {
            avatarHtml = `
                <div class="shrink-0 cursor-pointer" onclick="event.stopPropagation(); window.app.openProfile('${t.username}')">
                    <img src="${t.avatar_url || 'https://via.placeholder.com/40'}" 
                         class="w-10 h-10 rounded-full object-cover" loading="lazy">
                </div>
            `;
        }

        const contentDiv = document.createElement('div');
        contentDiv.className = 'flex-1 min-w-0 relative';
        
        const userInfoDiv = document.createElement('div');
        userInfoDiv.className = 'flex items-center gap-1 text-[15px] leading-5 flex-wrap';
        userInfoDiv.innerHTML = `
            <span class="font-bold text-white truncate cursor-pointer hover:underline" onclick="event.stopPropagation(); window.app.openProfile('${t.username}')">${sanitizeHTML(displayName)}</span>
            ${verificationBadge}
            <span class="text-gray-500 truncate text-[14px] dir-ltr ml-1">@${t.username}</span>
            <span class="text-gray-500 text-[13px]"> ${timeAgo}</span>
        `;
        contentDiv.appendChild(userInfoDiv);
        
        const menuButton = document.createElement('div');
        menuButton.className = 'tweet-options-btn absolute left-0 top-0 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 cursor-pointer';
        menuButton.innerHTML = '<i class="fas fa-ellipsis-h text-gray-500"></i>';
        menuButton.onclick = null;
        contentDiv.appendChild(menuButton);
        
        const dropdownMenu = document.createElement('div');
        dropdownMenu.id = `menu-${t.id}`;
        dropdownMenu.className = 'dropdown-menu';
        dropdownMenu.onclick = (e) => e.stopPropagation();
        dropdownMenu.innerHTML = dropdownHtml;
        contentDiv.appendChild(dropdownMenu);
        
        const tweetContent = document.createElement('div');
        tweetContent.className = 'text-white text-[15px] mt-1 whitespace-pre-wrap leading-6';
        tweetContent.innerHTML = sanitizeHTML(t.content);
        contentDiv.appendChild(tweetContent);
        
        if (t.media_url || t.media) {
            const mediaDiv = document.createElement('div');
            mediaDiv.className = 'mt-3 rounded-xl overflow-hidden border border-white/10';
            
            const mediaUrl = t.media_url || t.media;
            const mediaType = t.media_type || (mediaUrl && mediaUrl.includes('.mp4') ? 'gif' : 'image');
            
            if (mediaType === 'gif' || (mediaUrl && mediaUrl.includes('.mp4'))) {
                mediaDiv.innerHTML = `
                    <video src="${mediaUrl}" 
                           class="w-full object-cover cursor-pointer hover:opacity-95 transition" 
                           style="max-height: 400px;" 
                           autoplay loop muted playsinline
                           onclick="event.stopPropagation(); window.app.openImageModal('${mediaUrl}')"></video>
                `;
            } else {
                mediaDiv.innerHTML = `
                    <img src="${mediaUrl}" 
                         class="w-full object-cover cursor-pointer hover:opacity-95 transition" 
                         style="max-height: 400px;" 
                         onclick="window.app.openImageModal('${mediaUrl}')"
                         loading="lazy">
                `;
            }
            contentDiv.appendChild(mediaDiv);
        }
        
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'flex justify-between mt-3 max-w-[400px]';
        actionsDiv.innerHTML = `
            <div class="tweet-action reply" onclick="event.stopPropagation(); window.app.openReplyComposer('${t.id}', '${t.username}')"><i class="far fa-comment"></i> <span>${t.reply_count || 0}</span></div>
            <div class="tweet-action retweet"><i class="fas fa-retweet"></i> <span>${t.retweet_count || 0}</span></div>
            <div class="tweet-action like ${likeClass}" id="like-icon-${t.id}" onclick="event.stopPropagation(); window.app.likeTweet('${t.id}')">
                <i class="far fa-heart"></i> <span id="like-count-${t.id}">${t.likes_count || 0}</span>
            </div>
            <div class="tweet-action view"><i class="far fa-chart-bar"></i> <span>0</span></div>
            <div class="tweet-action bookmark ${bookmarkClass}" id="bookmark-icon-${t.id}" onclick="event.stopPropagation(); window.app.toggleBookmark('${t.id}')">
                 <i class="far fa-bookmark"></i>
            </div>
        `;
        contentDiv.appendChild(actionsDiv);
        
        div.innerHTML = avatarHtml;
        div.appendChild(contentDiv);

        fragment.appendChild(div);

        if (context === 'profile') {
            container.appendChild(fragment);
        } else if (prepend) {
            container.insertBefore(fragment, container.firstChild);
            setTimeout(() => {
                div.style.transition = 'opacity 0.5s ease';
                div.style.opacity = '1';
            }, 50);
        } else {
            container.appendChild(fragment);
        }
        
        return div;
    }

    async function fetchUserTweets(username) {
        const container = document.getElementById('profile-tweets-container');
        if (!container) return;
        
        container.innerHTML = '<div class="text-center text-gray-500 mt-5 pt-10"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
        
        try {
            const res = await fetch(`${SERVER_URL}/api/users/${username}/tweets?me=${currentUser.username}`);
            
            if (!res.ok) {
                throw new Error("   ");
            }
            
            const tweets = await res.json();
            container.innerHTML = '';
            
            if (!tweets || tweets.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 mt-10 py-8">
                        <i class="far fa-comment-alt text-3xl mb-3 opacity-50"></i>
                        <div class="text-sm">    .</div>
                    </div>
                `;
                return;
            }
            
            const isOwner = (username === currentUser.username);
            
            for (const tweet of tweets) {
                const tweetWithOwner = {
                    ...tweet,
                    is_owner: isOwner,
                    has_liked: tweet.has_liked || false,
                    has_bookmarked: tweet.has_bookmarked || false
                };
                
                await renderTweet(tweetWithOwner, false, false, 'profile');
            }
            
        } catch (e) {
            console.error("    :", e);
            container.innerHTML = `
                <div class="text-center text-gray-500 mt-10 text-sm p-4">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <div>   </div>
                    <button onclick="fetchUserTweets('${username}')" 
                            class="mt-2 px-4 py-2 bg-x-blue rounded-full text-sm">
                         
                    </button>
                </div>
            `;
        }
    }

    function initAppUI(user) {
        document.getElementById('auth-flow').style.display = 'none';
        document.getElementById('app-flow').style.display = 'block';
        
        const avatar = user.avatar_url || user.avatar || 'https://via.placeholder.com/150';
        const displayName = user.display_name || user.username;
        
        window.app.currentUser = user;
        currentUser = user;
        
        window.app.updateHeaderAvatar();
        window.app.updateDrawerAvatar();
        window.app.updateProfileAvatar();
        
        document.getElementById('drawer-name').innerText = displayName;
        document.getElementById('drawer-handle').innerText = '@' + user.username;
        document.getElementById('drawer-bio').innerText = user.bio || '';

        const drawerName = document.getElementById('drawer-name');
        if(user.verification === 'gold') {
            drawerName.innerHTML = `${sanitizeHTML(displayName)} <img src="https://upload.wikimedia.org/wikipedia/commons/8/81/Twitter_Verified_Badge_Gold.svg" class="verification-badge gold" alt="Verified Gold" loading="lazy">`;
        } else if(user.verification === 'blue') {
            drawerName.innerHTML = `${sanitizeHTML(displayName)} <img src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg" class="verification-badge blue" alt="Verified Blue" loading="lazy">`;
        } else {
            drawerName.innerHTML = sanitizeHTML(displayName);
        }

        if (!headerAvatarInitialized) {
            const headerAvatar = document.getElementById('header-avatar-container');
            if (headerAvatar) {
                headerAvatar.replaceWith(headerAvatar.cloneNode(true));
                const newHeaderAvatar = document.getElementById('header-avatar-container');
                
                newHeaderAvatar.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    window.app.toggleDrawer();
                });
                
                newHeaderAvatar.style.cursor = 'pointer';
                headerAvatarInitialized = true;
            }
        }

        setTimeout(() => {
            const drawerAvatar = document.getElementById('drawer-avatar-container');
            if (drawerAvatar) {
                drawerAvatar.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    window.app.toggleDrawer();
                };
            }
        }, 100);

        initSocketConnection(user);
        
        const notificationCount = parseInt(localStorage.getItem(LS_KEYS.NOTIFICATION_COUNT) || 0);
        if (notificationCount > 0) {
            document.getElementById('notification-badge').classList.add('active');
        }
        
        const dmCount = parseInt(localStorage.getItem(LS_KEYS.DM_COUNT) || 0);
        if (dmCount > 0) {
            const dmBadge = document.getElementById('dm-badge');
            dmBadge.classList.add('active');
            dmBadge.innerText = dmCount > 9 ? '9+' : dmCount.toString();
        }
        
        initReportSystem();
        initBlockSystem();

        registerUserSession();
        
        fetchTweets();
        window.app.loadStories();
        
        setupDrawerLinks();
        setupInfiniteScroll();
        setupLazyLoading();
    }

    function initReportSystem() {
        const hiddenTweets = JSON.parse(localStorage.getItem(LS_KEYS.HIDDEN_TWEETS) || '[]');
        hiddenTweets.forEach(tweetId => {
            const tweetElement = document.getElementById(`tweet-${tweetId}`);
            if (tweetElement) {
                tweetElement.style.opacity = '0.3';
            }
        });
        
        const permanentlyHidden = JSON.parse(localStorage.getItem(LS_KEYS.PERMANENTLY_HIDDEN_TWEETS) || '[]');
        permanentlyHidden.forEach(tweetId => {
            const tweetElement = document.getElementById(`tweet-${tweetId}`);
            if (tweetElement) {
                tweetElement.style.display = 'none';
            }
        });
    }

    function initBlockSystem() {
        blockSystem.fetchBlockedUsers(true).then(() => {
            console.log(" Block system initialized");
        }).catch(err => {
            console.error(" Block system init error:", err);
        });
        
        window.addEventListener('user-blocked', (e) => {
            console.log(` User blocked: ${e.detail.blocked} by ${e.detail.blocker}`);
        });
        
        window.addEventListener('user-unblocked', (e) => {
            console.log(` User unblocked: ${e.detail.blocked} by ${e.detail.blocker}`);
        });
        
        const profileView = document.getElementById('user-profile-view');
        if (!profileView.classList.contains('hidden-content')) {
            const profileUsername = document.getElementById('profile-view-handle')?.innerText.replace('@', '');
            if (profileUsername) {
                setTimeout(async () => {
                    const status = await blockSystem.checkBlockStatus(profileUsername);
                    if (status.blockedByMe) {
                        if (typeof blockSystem.showBlockedByMeProfile === 'function') {
                            blockSystem.showBlockedByMeProfile(profileUsername);
                        }
                    } else if (status.blockedMe) {
                        if (typeof blockSystem.showBlockedMeProfile === 'function') {
                            blockSystem.showBlockedMeProfile(profileUsername);
                        }
                    }
                }, 500);
            }
        }
    }

    function setupInfiniteScroll() {
        if (scrollObserver) {
            scrollObserver.disconnect();
            scrollObserver = null;
        }
        
        scrollObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && !tweetLoadLock && hasMoreTweets) {
                    loadMoreTweets();
                }
            });
        }, { threshold: 0.1 });
        
        const loader = document.getElementById('infinite-scroll-loader');
        if (loader && scrollObserver) {
            scrollObserver.observe(loader);
        }
    }

    function cleanupInfiniteScroll() {
        if (scrollObserver) {
            scrollObserver.disconnect();
            scrollObserver = null;
        }
        tweetLoadLock = false;
        isLoadingTweets = false;
    }

    async function loadMoreTweets() {
        if (tweetLoadLock || !hasMoreTweets) return;
        
        tweetLoadLock = true;
        isLoadingTweets = true;
        
        try {
            const nextPage = currentTweetPage + 1;
            const res = await fetch(`${SERVER_URL}/api/tweets/feed?username=${currentUser.username}&page=${nextPage}&limit=10`);
            
            if (res.ok) {
                const tweets = await res.json();
                if (tweets.length === 0) {
                    hasMoreTweets = false;
                } else {
                    currentTweetPage = nextPage;
                    for (const tweet of tweets) {
                        await renderTweet(tweet);
                    }
                }
            }
        } catch (e) {
            console.error("    :", e);
        } finally {
            tweetLoadLock = false;
            isLoadingTweets = false;
            const loader = document.getElementById('infinite-scroll-loader');
            if (loader) loader.style.display = 'none';
        }
    }

    async function fetchTweets(refresh = false) {
        const c = document.getElementById('tweets-container');
        
        if (refresh) {
            currentTweetPage = 0;
            hasMoreTweets = true;
            c.innerHTML = '<div class="text-center text-gray-500 mt-5 pt-10"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
        } else if (currentTweetPage === 0) {
            c.innerHTML = '<div class="text-center text-gray-500 mt-5 pt-10"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
        }
        
        try {
            const tweets = await fetch(
                `${SERVER_URL}/api/tweets/feed?username=${currentUser.username}&page=0&limit=20`
            ).then(r => r.json());
            
            c.innerHTML = '';
            
            if (tweets.length < 20) {
                hasMoreTweets = false;
            }
            
            for (const tweet of tweets) {
                await renderTweet(tweet);
            }
        } catch(e) {
            console.error("   :", e);
            c.innerHTML = `
                <div class="text-center text-gray-500 mt-10 p-4">
                    <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                    <div>   </div>
                    <button onclick="fetchTweets(true)" 
                            class="mt-2 px-4 py-2 bg-x-blue rounded-full text-sm">
                         
                    </button>
                </div>
            `;
        }
    }

    function setupDrawerLinks() {
        if (drawerLinksSetup) return;
        
        const profileLinks = document.querySelectorAll('.drawer-link[onclick*="openProfile"], .drawer-link[onclick*="profile"]');
        
        profileLinks.forEach(link => {
            if (!link.dataset.listenerAdded) {
                link.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    window.app.openProfile(currentUser.username);
                    window.app.toggleDrawer();
                };
                link.dataset.listenerAdded = 'true';
            }
        });
        
        drawerLinksSetup = true;
    }

    function setupLazyLoading() {
        if (lazyImageObserver) {
            lazyImageObserver.disconnect();
        }
        if (domMutationObserver) {
            domMutationObserver.disconnect();
        }
        
        lazyImageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (img.dataset.src) {
                        img.src = img.dataset.src;
                    }
                    img.classList.add('loaded');
                    lazyImageObserver.unobserve(img);
                }
            });
        }, {
            rootMargin: '50px 0px',
            threshold: 0.1
        });
        
        document.querySelectorAll('img[loading="lazy"]').forEach(img => {
            if (!img.src && img.dataset.src) {
                lazyImageObserver.observe(img);
            }
        });
        
        domMutationObserver = new MutationObserver((mutations) => {
            mutations.forEach(mutation => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === 1) {
                            const images = node.querySelectorAll ? 
                                node.querySelectorAll('img[loading="lazy"]') : [];
                            
                            images.forEach(img => {
                                if (!img.src && img.dataset.src) {
                                    lazyImageObserver.observe(img);
                                }
                            });
                            
                            if (node.tagName === 'IMG' && node.getAttribute('loading') === 'lazy') {
                                if (!node.src && node.dataset.src) {
                                    lazyImageObserver.observe(node);
                                }
                            }
                        }
                    });
                }
            });
        });
        
        domMutationObserver.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    function cleanupLazyLoading() {
        if (lazyImageObserver) {
            lazyImageObserver.disconnect();
            lazyImageObserver = null;
        }
        if (domMutationObserver) {
            domMutationObserver.disconnect();
            domMutationObserver = null;
        }
    }

    function initSocketConnection(user) {
        if(!window.io) {
            console.error("Socket.io not loaded");
            return;
        }
        
        const statusEl = document.getElementById('connection-status');
        statusEl.style.display = 'block';
        
        try {
            socket = io(SERVER_URL, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });
            
            if (socketListenersSetup) {
                socket.removeAllListeners();
            }
            
            socket.on('connect', () => {
                console.log(' Socket connected:', socket.id);
                statusEl.innerHTML = '<i class="fas fa-check-circle"></i>  ';
                statusEl.classList.remove('disconnected');
                statusEl.classList.add('connected');
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 2000);
                
                socket.emit('register_user', user.username);
            });
            
            socket.on('disconnect', (reason) => {
                console.log(' Socket disconnected:', reason);
                statusEl.innerHTML = '<i class="fas fa-times-circle"></i>  ';
                statusEl.classList.remove('connected');
                statusEl.classList.add('disconnected');
                statusEl.style.display = 'block';
            });
            
            socket.on('connect_error', (err) => {
                console.error('Socket connection error:', err);
                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i>   ';
                statusEl.classList.remove('connected');
                statusEl.classList.add('disconnected');
            });
            
            socket.on('new_tweet', (tweet) => {
                if(tweet.username !== currentUser.username) {
                    renderTweet(tweet, true);
                }
            });
            
            socket.on('update_tweet_stats', ({ tweetId, action }) => {
                const countEl = document.getElementById(`like-count-${tweetId}`);
                const iconEl = document.getElementById(`like-icon-${tweetId}`);
                if(countEl && action === 'like_added') {
                    let current = parseInt(countEl.innerText) || 0;
                    countEl.innerText = current + 1;
                    if(iconEl) iconEl.classList.add('liked');
                }
            });
            
            socket.on('notification_alert', (notification) => {
                const lastSeen = localStorage.getItem(LS_KEYS.NOTIFICATIONS_SEEN);
                const now = Date.now();
                if (!lastSeen || (now - parseInt(lastSeen)) > 1000) {
                    document.getElementById('notification-badge').classList.add('active');
                    const currentCount = parseInt(localStorage.getItem(LS_KEYS.NOTIFICATION_COUNT) || 0);
                    localStorage.setItem(LS_KEYS.NOTIFICATION_COUNT, currentCount + 1);
                }
                
                showNotificationToast(notification.message || ' ');
                vibrate();
                playDMSound();
            });
            
            socket.on('receive_message', (msg) => {
                if(currentChatContext === 'room' && currentChatId) {
                   renderMsg(msg, msg.username === user.username);
                   if (msg.username !== user.username) {
                       playMessageSound();
                   }
                } else {
                    const lastSeen = localStorage.getItem(LS_KEYS.DMS_SEEN);
                    const now = Date.now();
                    if (!lastSeen || (now - parseInt(lastSeen)) > 1000) {
                        const dmBadge = document.getElementById('dm-badge');
                        dmBadge.classList.add('active');
                        const currentCount = parseInt(dmBadge.innerText || 0);
                        dmBadge.innerText = currentCount + 1;
                        
                        const storedCount = parseInt(localStorage.getItem(LS_KEYS.DM_COUNT) || 0);
                        localStorage.setItem(LS_KEYS.DM_COUNT, storedCount + 1);
                    }
                }
            });
            
            socket.on('receive_dm', (msg) => {
                if(currentChatContext === 'dm' && currentChatId) {
                    window.app.renderMessageV2({
                        id: msg.id,
                        content: msg.content,
                        sender_id: msg.sender_id,
                        sender_username: msg.sender,
                        sender_display_name: msg.sender_display_name,
                        sender_avatar: msg.sender_avatar,
                        sender_verification: msg.sender_verification,
                        status: msg.status || 'delivered',
                        created_at: msg.created_at
                    }, msg.sender === user.username);
                    
                    if (msg.sender !== user.username) {
                        playDMSound();
                        window.app.markMessagesAsSeen(currentChatId, msg.id);
                    }
                } else {
                    const lastSeen = localStorage.getItem(LS_KEYS.DMS_SEEN);
                    const now = Date.now();
                    if (!lastSeen || (now - parseInt(lastSeen)) > 1000) {
                        const dmBadge = document.getElementById('dm-badge');
                        dmBadge.classList.add('active');
                        const currentCount = parseInt(dmBadge.innerText || 0);
                        dmBadge.innerText = currentCount + 1;
                        
                        const storedCount = parseInt(localStorage.getItem(LS_KEYS.DM_COUNT) || 0);
                        localStorage.setItem(LS_KEYS.DM_COUNT, storedCount + 1);
                        
                        vibrate();
                        playDMSound();
                    }
                }
            });

            socket.on('new_message', (message) => {
                if (currentChatContext === 'dm' && currentChatId === message.conversationId) {
                    window.app.renderMessageV2(message, message.sender.username === currentUser.username);
                    
                    const messagesBox = document.getElementById('chat-messages');
                    messagesBox.scrollTop = messagesBox.scrollHeight;
                    
                    if (message.sender.username !== currentUser.username) {
                        playDMSound();
                        window.app.markMessagesAsSeen(message.conversationId, message.id);
                    }
                } else {
                    const convElement = document.querySelector(`.dm-item[data-conversation-id="${message.conversationId}"]`);
                    if (convElement) {
                        let badge = convElement.querySelector('.unread-badge');
                        if (!badge) {
                            badge = document.createElement('div');
                            badge.className = 'unread-badge';
                            convElement.appendChild(badge);
                        }
                        
                        const currentCount = parseInt(badge.textContent || '0');
                        badge.textContent = currentCount + 1 > 9 ? '9+' : currentCount + 1;
                        badge.style.display = 'flex';
                    }
                    
                    window.app.getTotalUnreadCount();
                    
                    showNotificationToast(`    ${message.sender.displayName || message.sender.username}`);
                    vibrate();
                    playDMSound();
                }
            });

            socket.on('messages_seen', (data) => {
                if (currentChatContext === 'dm' && currentChatId === data.conversationId) {
                    if (data.messageIds && data.messageIds.length > 0) {
                        data.messageIds.forEach(msgId => {
                            const msgElement = document.querySelector(`[data-message-id="${msgId}"]`);
                            if (msgElement) {
                                const statusEl = msgElement.querySelector('.text-xs.flex.items-center.gap-1');
                                if (statusEl) {
                                    statusEl.innerHTML = '<span class="text-x-blue text-xs mr-1 flex items-center gap-0.5"><i class="fas fa-check-circle"></i><i class="fas fa-check-circle -ml-1"></i></span>';
                                }
                            }
                        });
                    } else if (data.lastSeenMessageId) {
                        document.querySelectorAll('.message-container[data-message-id]').forEach(el => {
                            const msgId = el.getAttribute('data-message-id');
                            if (msgId && !msgId.startsWith('temp_') && parseInt(msgId) <= parseInt(data.lastSeenMessageId)) {
                                const statusEl = el.querySelector('.text-xs.flex.items-center.gap-1');
                                if (statusEl && el.classList.contains('flex-row-reverse')) {
                                    statusEl.innerHTML = '<span class="text-x-blue text-xs mr-1 flex items-center gap-0.5"><i class="fas fa-check-circle"></i><i class="fas fa-check-circle -ml-1"></i></span>';
                                }
                            }
                        });
                    }
                }
            });

            socket.on('messages_seen_confirmed', (data) => {
                if (currentChatContext === 'dm' && currentChatId === data.conversationId) {
                    if (data.messageIds && data.messageIds.length > 0) {
                        data.messageIds.forEach(msgId => {
                            const msgElement = document.querySelector(`[data-message-id="${msgId}"]`);
                            if (msgElement && msgElement.classList.contains('flex-row-reverse')) {
                                const statusEl = msgElement.querySelector('.text-xs.flex.items-center.gap-1');
                                if (statusEl) {
                                    statusEl.innerHTML = '<span class="text-x-blue text-xs mr-1 flex items-center gap-0.5"><i class="fas fa-check-circle"></i><i class="fas fa-check-circle -ml-1"></i></span>';
                                }
                            }
                        });
                    }
                }
            });

            socket.on('new_story', (story) => {
                if(currentUser && story.username !== currentUser.username) {
                    window.app.loadStories();
                }
            });

            socket.on('story_deleted', (storyId) => {
                window.app.loadStories();
            });
            
            socketListenersSetup = true;
        } catch(err) {
            console.error("Socket initialization error:", err);
            statusEl.innerHTML = '<i class="fas fa-exclamation-triangle"></i>   ';
            statusEl.classList.add('disconnected');
        }
    }

    function renderMsg(msg, isMe) {
        const box = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = `flex gap-2 mb-2 message-container ${isMe ? 'flex-row-reverse' : ''}`;
        div.setAttribute('data-message-id', msg.id || Date.now());
        
        const avatar = msg.avatar || msg.avatar_url || 'https://via.placeholder.com/40';
        let verificationBadge = '';
        if(msg.verification === 'gold') {
            verificationBadge = '<img src="https://upload.wikimedia.org/wikipedia/commons/8/81/Twitter_Verified_Badge_Gold.svg" class="verification-badge gold" alt="Verified Gold" style="width: 14px; height: 14px; margin-right: 2px;" loading="lazy">';
        } else if(msg.verification === 'blue') {
            verificationBadge = '<img src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg" class="verification-badge blue" alt="Verified Blue" style="width: 14px; height: 14px; margin-right: 2px;" loading="lazy">';
        }
        
        div.innerHTML = `
            ${isMe ? `<div class="message-options"><button class="delete-msg-btn" onclick="window.app.deleteMessage('${msg.id || ''}')"><i class="fas fa-trash"></i></button></div>` : ''}
            <img src="${avatar}" class="w-8 h-8 rounded-full border border-white/10 object-cover bg-black" loading="lazy">
            <div class="px-3 py-2 rounded-2xl max-w-[75%] text-sm ${isMe ? 'bg-[#1d9bf0] text-white rounded-bl-sm' : 'bg-[#212121] text-white rounded-br-sm'}">
                ${!isMe ? `<div class="text-[11px] text-[#e58e38] font-bold mb-0.5 flex items-center">${sanitizeHTML(msg.username || 'User')} ${verificationBadge}</div>` : ''}
                ${sanitizeHTML(msg.content)}
                <div class="text-[10px] text-gray-400 mt-1 text-left dir-ltr">${formatTime(new Date(msg.created_at || msg.time || Date.now()))}</div>
            </div>
        `;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function showNotificationToast(message) {
        const toast = document.createElement('div');
        toast.className = 'notification-toast';
        toast.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i class="far fa-bell"></i>
                    <span>${sanitizeHTML(message)}</span>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="text-white/70 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    }

    function formatTime(date) {
        const now = new Date();
        const diff = now - date;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        
        if (minutes < 1) return ' ';
        if (minutes < 60) return `${minutes}  `;
        if (hours < 60) return `${hours}  `;
        if (days < 7) return `${days}  `;
        
        if (i18next.language === 'fa') {
            return new Intl.DateTimeFormat('fa-IR').format(date);
        } else {
            return new Intl.DateTimeFormat('en-US').format(date);
        }
    }

    function playMessageSound() {
        try {
            messageSound.currentTime = 0;
            messageSound.play().catch(e => console.log("   :", e));
        } catch (e) {
            console.log("   ");
        }
    }

    function playDMSound() {
        try {
            dmSound.currentTime = 0;
            dmSound.play().catch(e => console.log("    :", e));
        } catch (e) {
            console.log("    ");
        }
    }

    function vibrate() {
        if (navigator.vibrate) {
            navigator.vibrate(200);
        }
    }

    async function registerUserSession() {
        try {
            const deviceInfo = {
                browser: (() => {
                    if (navigator.userAgent.includes('Chrome')) return 'Chrome';
                    if (navigator.userAgent.includes('Firefox')) return 'Firefox';
                    if (navigator.userAgent.includes('Safari')) return 'Safari';
                    if (navigator.userAgent.includes('Edg')) return 'Edge';
                    if (navigator.userAgent.includes('OPR')) return 'Opera';
                    return 'Unknown';
                })(),
                os: (() => {
                    if (navigator.userAgent.includes('Windows')) return 'Windows';
                    if (navigator.userAgent.includes('Mac')) return 'macOS';
                    if (navigator.userAgent.includes('Linux')) return 'Linux';
                    if (navigator.userAgent.includes('Android')) return 'Android';
                    if (navigator.userAgent.includes('iOS') || navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad')) return 'iOS';
                    return 'Unknown';
                })(),
                mobile: /Mobile|Android|iPhone|iPad|iPod/i.test(navigator.userAgent),
                device: /Mobile|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ? '' : '',
                browser_version: navigator.userAgent.match(/(Chrome|Firefox|Safari|Edg|OPR)\/(\d+\.\d+)/)?.[2] || 'Unknown'
            };
            
            let sessionToken = localStorage.getItem(LS_KEYS.SESSION_TOKEN);
            if (!sessionToken) {
                sessionToken = 'sess_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
                localStorage.setItem(LS_KEYS.SESSION_TOKEN, sessionToken);
            } else {
                const lastSessionCheck = localStorage.getItem(LS_KEYS.LAST_SESSION_CHECK);
                const now = Date.now();
                
                if (!lastSessionCheck || now - parseInt(lastSessionCheck) > 24 * 60 * 60 * 1000) {
                    localStorage.setItem(LS_KEYS.LAST_SESSION_CHECK, now.toString());
                }
            }
            
            let ip = '127.0.0.1';
            try {
                const ipRes = await fetch('https://api.ipify.org?format=json');
                if (ipRes.ok) {
                    const ipData = await ipRes.json();
                    ip = ipData.ip;
                }
            } catch (e) {
                console.log("Could not fetch IP");
            }
            
            await fetch(`${SERVER_URL}/api/settings/sessions/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: currentUser.username,
                    device_info: deviceInfo,
                    ip_address: ip,
                    session_token: sessionToken
                })
            });
            
            await fetch(`${SERVER_URL}/api/settings/country`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: currentUser.username,
                    ip_address: ip
                })
            });
            
        } catch (error) {
            console.error(" Session registration error:", error);
        }
    }

    // Event Listeners
    document.getElementById('fileInput').addEventListener('change', function(e){
        if(e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            const maxSize = 10 * 1024 * 1024;
            
            if (file.size > maxSize) {
                alert('       ');
                this.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const MAX_SIZE = 800;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > MAX_SIZE) {
                            height = Math.round((height * MAX_SIZE) / width);
                            width = MAX_SIZE;
                        }
                    } else {
                        if (height > MAX_SIZE) {
                            width = Math.round((width * MAX_SIZE) / height);
                            height = MAX_SIZE;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    window.app.setProfileImage(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = event.target.result;
            };
            reader.onerror = function(error) {
                console.error('   :', error);
                alert('   ');
                this.value = '';
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('story-media-input').addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            const maxSize = 15 * 1024 * 1024;
            
            if (file.size > maxSize) {
                alert('       ');
                this.value = '';
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const type = file.type.startsWith('image/') ? 'image' : 
                            file.type.startsWith('video/') ? 'video' : null;
                
                if (type) {
                    window.app.setStoryMedia(type, event.target.result);
                }
            };
            
            reader.onerror = function(error) {
                console.error('    :', error);
                alert('   ');
                this.value = '';
            };
            
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('story-gallery-input').addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            const maxSize = 15 * 1024 * 1024;
            
            if (file.size > maxSize) {
                alert('       ');
                this.value = '';
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const type = file.type.startsWith('image/') ? 'image' : 
                            file.type.startsWith('video/') ? 'video' : null;
                
                if (type) {
                    window.app.setStoryMedia(type, event.target.result);
                }
            };
            
            reader.onerror = function(error) {
                console.error('    :', error);
                alert('   ');
                this.value = '';
            };
            
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('color-picker').addEventListener('click', function(e) {
        if (e.target.classList.contains('color-option')) {
            document.querySelectorAll('.color-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            e.target.classList.add('selected');
            selectedTextColor = e.target.getAttribute('data-color');
        }
    });

    const searchInput = document.getElementById('search-input');
    const debouncedSearch = debounce(async (value) => {
        const resContainer = document.getElementById('search-results');
        const loadingEl = document.getElementById('search-loading');
        
        if (!resContainer) return;
        
        if (loadingEl) loadingEl.style.display = 'block';
        
        try {
            const res = await fetch(`${SERVER_URL}/api/users/search?q=${value}`);
            const users = await res.json();
            
            if (loadingEl) loadingEl.style.display = 'none';
            
            resContainer.innerHTML = '';
            
            if(users.length === 0) { 
                resContainer.innerHTML = '<div class="text-center text-gray-500 mt-4">  .</div>'; 
                return; 
            }
            
            await window.app.loadStories();
            
            for (const u of users) {
                const userHasStory = currentStories && currentStories.some(s => 
                    s.username === u.username && s.stories && s.stories.length > 0
                );
                
                const d = document.createElement('div');
                d.className = 'flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 cursor-pointer';
                
                d.onclick = () => {
                    if(isDmSearchMode) {
                        if (window.app.startConversationV2) {
                            window.app.startConversationV2(u.username);
                        } else {
                            window.app.startConversation(u.username);
                        }
                    } else {
                        window.app.openProfile(u.username);
                    }
                };

                let verificationBadge = '';
                if(u.verification === 'gold') {
                    verificationBadge = '<img src="https://upload.wikimedia.org/wikipedia/commons/8/81/Twitter_Verified_Badge_Gold.svg" class="verification-badge gold" alt="Verified Gold" loading="lazy">';
                } else if(u.verification === 'blue') {
                    verificationBadge = '<img src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg" class="verification-badge blue" alt="Verified Blue" loading="lazy">';
                }

                let avatarHtml;
                if (userHasStory) {
                    avatarHtml = `
                        <div class="search-result-avatar-with-story">
                            <div class="story-indicator">
                                <img src="${u.avatar_url || 'https://via.placeholder.com/40'}" 
                                     style="width: 100%; height: 100%; object-fit: cover;" loading="lazy">
                            </div>
                        </div>
                    `;
                } else {
                    avatarHtml = `<img src="${u.avatar_url || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover" loading="lazy">`;
                }

                d.innerHTML = `
                    ${avatarHtml}
                    <div>
                        <div class="font-bold text-white text-sm flex items-center gap-1">
                            ${sanitizeHTML(u.display_name || u.username)}
                            ${verificationBadge}
                        </div>
                        <div class="text-gray-500 text-xs">@${u.username}</div>
                    </div>
                `;
                resContainer.appendChild(d);
            }
        } catch(e) { 
            console.error("  :", e);
            if (loadingEl) loadingEl.style.display = 'none';
            resContainer.innerHTML = '<div class="text-center text-red-500 mt-4 text-xs">  </div>'; 
        }
    }, 600);

    searchInput.addEventListener('input', (e) => {
        const val = e.target.value.trim();
        const loadingEl = document.getElementById('search-loading');
        const resContainer = document.getElementById('search-results');
        
        if(val.length < 2) { 
            if (loadingEl) loadingEl.style.display = 'none';
            if (resContainer) resContainer.innerHTML = ''; 
            return; 
        }
        debouncedSearch(val);
    });

    function validateProfileForm(){
        const u = document.getElementById('usernameInput').value;
        const fab = document.getElementById('continueFab');
        if(u.length > 2) fab.classList.add('enabled');
        else fab.classList.remove('enabled');
    }
    
    document.getElementById('usernameInput').addEventListener('input', validateProfileForm);
    document.getElementById('emailInput').addEventListener('input', (e) => {
        const fab = document.getElementById('loginFab');
        if(e.target.value.length > 5 && e.target.value.includes('@')) fab.classList.add('enabled');
        else fab.classList.remove('enabled');
    });
    
    document.querySelectorAll('.otp-box').forEach(box => {
        box.addEventListener('input', (e) => {
            if(e.target.value.length === 1) {
                e.target.classList.add('filled');
                const next = document.getElementById(e.target.dataset.next);
                if(next) {
                    setTimeout(() => next.focus(), 10);
                }
            }
        });
        
        box.addEventListener('keydown', (e) => {
            if(e.key === 'Backspace' && e.target.value === '') {
                e.target.classList.remove('filled');
                const prev = document.getElementById(e.target.dataset.prev);
                if(prev) {
                    prev.focus();
                    prev.value = '';
                    prev.classList.remove('filled');
                }
                e.preventDefault();
            }
            
            if(e.key === 'ArrowRight') {
                const next = document.getElementById(e.target.dataset.next);
                if(next) {
                    next.focus();
                    e.preventDefault();
                }
            }
            
            if(e.key === 'ArrowLeft') {
                const prev = document.getElementById(e.target.dataset.prev);
                if(prev) {
                    prev.focus();
                    e.preventDefault();
                }
            }
            
            if((e.ctrlKey || e.metaKey) && e.key === 'v') {
                setTimeout(() => {
                    const pastedText = e.target.value;
                    if(pastedText.length === 6 && /^\d+$/.test(pastedText)) {
                        const boxes = document.querySelectorAll('.otp-box');
                        boxes.forEach((box, index) => {
                            if(index < pastedText.length) {
                                box.value = pastedText[index];
                                box.classList.add('filled');
                            }
                        });
                        document.getElementById('verifyBtn').focus();
                    }
                }, 10);
            }
        });
    });

    document.getElementById('tweet-media-input').addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            const maxSize = 10 * 1024 * 1024;
            
            if (file.size > maxSize) {
                alert('       ');
                this.value = '';
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                alert('    ');
                this.value = '';
                return;
            }
            
            currentTweetMedia = file;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const preview = document.getElementById('composer-media-preview');
                const image = document.getElementById('composer-media-image');
                image.src = event.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('header-file-input').addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            const maxSize = 10 * 1024 * 1024;
            
            if (file.size > maxSize) {
                alert('       ');
                this.value = '';
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                alert('    ');
                this.value = '';
                return;
            }
            
            window._pendingHeaderFile = file;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById('profile-header-image').src = event.target.result;
                showNotificationToast('  .      .');
            };
            reader.readAsDataURL(file);
        }
    });

    // Event Listeners  GIF Picker
    document.getElementById('gif-search-input')?.addEventListener('input', (e) => {
        window.app.searchGifs(e.target.value);
    });

    document.querySelectorAll('.gif-chip')?.forEach(chip => {
        chip.addEventListener('click', function() {
            window.app.onGifChipClick(this);
        });
    });

    document.getElementById('gif-grid-container')?.addEventListener('scroll', (e) => {
        const container = e.target;
        if (container.scrollTop + container.clientHeight >= container.scrollHeight - 100) {
            if (!window.app.gifPickerState.isLoading && window.app.gifPickerState.hasMore) {
                window.app.gifPickerState.currentPage++;
                window.app.loadGifs(window.app.gifPickerState.currentQuery, false);
            }
        }
    });

    function debounce(func, wait, immediate = false) {
        let timeout;
        let lastCallTime = 0;
        const MIN_TIME_BETWEEN_CALLS = 100;
        
        return function executedFunction(...args) {
            const context = this;
            const now = Date.now();
            
            if (now - lastCallTime < MIN_TIME_BETWEEN_CALLS) {
                return;
            }
            lastCallTime = now;
            
            const later = () => {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            
            const callNow = immediate && !timeout;
            
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            
            if (callNow) func.apply(context, args);
        };
    }

    const savedLanguage = localStorage.getItem(LS_KEYS.LANGUAGE);
    if (savedLanguage) {
        i18next.changeLanguage(savedLanguage);
    } else {
        i18next.changeLanguage('fa');
    }

    const saved = localStorage.getItem('x_user_v2');
    if(saved) {
        try {
            currentUser = JSON.parse(saved);
            window.app.currentUser = currentUser;
            initAppUI(currentUser);
        } catch(e) {
            console.error("Error parsing saved user:", e);
            localStorage.removeItem('x_user_v2');
        }
    }

    window.addEventListener('beforeunload', () => {
        cleanupInfiniteScroll();
        cleanupLazyLoading();
        
        if (storyInterval) {
            clearInterval(storyInterval);
            storyInterval = null;
        }
        
        if (mediaStream) {
            mediaStream.getTracks().forEach(track => track.stop());
            mediaStream = null;
        }
        
        if (socket) {
            socket.disconnect();
        }
    });

    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            if (storyInterval && document.getElementById('story-viewer').classList.contains('active')) {
                window.app.pauseStoryProgress();
            }
        } else {
            if (!storyInterval && document.getElementById('story-viewer').classList.contains('active')) {
                window.app.resumeStoryProgress();
            }
        }
    });

    //     
    (function initAuthGraphics() {
        if (!document.getElementById('auth-flow')) return;

        const canvas = document.getElementById('particle-canvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        let particles = [];
        let animationFrame;

        function initParticles() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            particles = [];
            for (let i = 0; i < 50; i++) {
                particles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 1.5,
                    speedX: Math.random() * 0.4 - 0.2,
                    speedY: Math.random() * 0.4 - 0.2,
                    opacity: Math.random() * 0.4
                });
            }
        }

        function animateParticles() {
            if (!ctx || !canvas) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                p.x += p.speedX; 
                p.y += p.speedY;
                if (p.x < 0 || p.x > canvas.width) p.speedX *= -1;
                if (p.y < 0 || p.y > canvas.height) p.speedY *= -1;
                ctx.fillStyle = `rgba(255, 255, 255, ${p.opacity})`;
                ctx.beginPath(); 
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); 
                ctx.fill();
            });
            animationFrame = requestAnimationFrame(animateParticles);
        }

        document.addEventListener('mousemove', (e) => {
            if (!document.getElementById('auth-flow')) return;
            const x = (window.innerWidth / 2 - e.pageX) / 80;
            const y = (window.innerHeight / 2 - e.pageY) / 80;
            const glow = document.getElementById('glow');
            if (glow) {
                glow.style.transform = `translate(calc(-50% + ${-x}px), calc(-50% + ${-y}px))`;
            }
        });

        const otpInputs = document.querySelectorAll('.otp-box');
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                if (e.target.value && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            });
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });
        });

        initParticles();
        animateParticles();

        window.addEventListener('resize', () => {
            cancelAnimationFrame(animationFrame);
            initParticles();
            animateParticles();
        });

        if (window.gsap) {
            gsap.from("#welcomeLogo", { duration: 1.2, scale: 0.5, opacity: 0, ease: "elastic.out(1, 0.5)" });
        }
    })();

});
</script>
</body>
</html>